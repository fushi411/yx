<extend name="Apply:applyBase" />

<!-- 去除不可选择日期 -->
<block name="disable_date"></block>
<!-- 去除不可选择日期 end-->
<block name="content_body">
    <input type="hidden" id="ratio" value="ratio">
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd">
                <label class="weui-label">
                    <span class="font-width">收款方式</span>&nbsp;&nbsp;
                    <span style="color:red;">*</span>
                </label>
            </div>
            <div class="weui-cell__bd">
                <select class="weui-select greyColor" name="type" id='fkfs'>
                    <option value='-1' disabled selected style='display:none;'>请选择收款方式</option>
                    <option value="4">现金</option>
                    <option value="2">公司账户</option>
                    <option value="3">承兑汇票</option>
                </select>
            </div>
        </div>
        <div class="weui-cell weui-cell_select weui-cell_select-after" id="btnhp" style="display:none;">
            <div class="weui-cell__hd">
                <label class="weui-label">汇票详情&nbsp;&nbsp;
                    <span style="color:red;">*</span>
                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-select " type="text" readonly id="select_ycl" style="color: #337ab7;" value="点击进入汇票页面" />
            </div>
        </div>
        <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd">
                <label class="weui-label">
                    <span class="font-width">收款银行</span>&nbsp;&nbsp;
                    <span style="color:red;">*</span>
                </label>
            </div>
            <div class="weui-cell__bd">
                <select class="weui-select greyColor" name="type" id='bank'>
                    <option value='-1' disabled selected style='display:none;'>请选择收款银行</option>
                    <option value="4">现金</option>
                    <option value="2">公司账户</option>
                    <option value="3">承兑汇票</option>
                </select>
            </div>
        </div>

        <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd">
                <label class="weui-label">收款金额&nbsp;&nbsp;
                    <span style="color:red;">*</span>
                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-select" type="number" name="custodian" id="money" placeholder="请输入收款金额" />
                <div class="weui-select" id="show_number"></div>
            </div>
        </div>
        <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd">
                <label class="weui-label">
                    <span class="font-width">收入类型</span>&nbsp;&nbsp;
                    <span style="color:red;">*</span>
                </label>
            </div>
            <div class="weui-cell__bd">
                <select class="weui-select greyColor" name="type" id='srlx'>
                    <option value='-1' disabled selected style='display:none;'>请选择收入类型</option>
                    <option value="1">利息收入</option>
                    <option value="2">汇票托收款</option>
                    <option value="3">其他收入</option>
                    <option value="4">投资款</option>
                    <option value="5">借支还款</option>
                    <option value="6">代垫还款</option>
                    <option value="7">代垫款</option>
                    <option value="8">分红</option>
                    <option value="9">转让股权收入</option>
                    <option value="10">还款</option>
                    <option value="11">租金收入</option>
                </select>
            </div>
        </div>
    </div>


    <div class="other_page" id="other_page" style="display: none;">
        <div class="container">
            <div class="page js_show">
                <h3 class="titleTab" style="text-align: center">汇票录入</h3>
                <div class="weui-cells weui-cells_form">
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">收票日期&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select" type="text" name="custodian" id="hpDatePicker_1" readonly value="{$today}" />
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">开票日期&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select" type="text" name="custodian" id="hpDatePicker_2" readonly value="{$today}" />
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">到期日期&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select" type="text" name="custodian" id="hpDatePicker_3" readonly value="{$today}" />
                        </div>
                    </div>
                </div>
                <div class="weui-cells weui-cells_form">
                    <div class="weui-cell weui-cell_select weui-cell_select-after ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="font-width">汇票号码</span>&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select peibi scale" type="text" name="" id="hphm" placeholder="仅填写汇票号码的下面一行">
                        </div>
                    </div>
                </div>

                <div class="weui-cells weui-cells_form">
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="font-width">汇票媒介</span>&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <select class="weui-select greyColor" name="type" id='mj'>
                                <option value='-1' disabled selected style='display:none;'>请选择汇票媒介</option>
                                <option value="纸质汇票">纸质汇票</option>
                                <option value="电子汇票">电子汇票</option>
                            </select>
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="font-width">汇票性质</span>&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <select class="weui-select greyColor" name="type" id='xz'>
                                <option value='-1' disabled selected style='display:none;'>请选择汇票性质</option>
                                <option value="银行">银行</option>
                                <option value="商业">商业</option>
                            </select>
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="font-width">开票银行</span>&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <select class="weui-select greyColor" name="type" id='kpyh1'>
                                <option value='-1' disabled selected style='display:none;'>请选择开票银行</option>
                                <option value="建设银行">建设银行</option>
                                <option value="工商银行">工商银行</option>
                                <option value="中国银行">中国银行</option>
                                <option value="农业银行">农业银行</option>
                                <option value="交通银行">交通银行</option>
                                <option value="民生银行">民生银行</option>
                                <option value="光大银行">光大银行</option>
                                <option value="兴业银行">兴业银行</option>
                                <option value="海峡银行">海峡银行</option>
                                <option value="农商银行">农商银行</option>
                                <option value="厦门银行">厦门银行</option>
                                <option value="其他银行">其他银行</option>
                            </select>
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after " id="bank_name_div">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="font-width">银行名称</span>&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select peibi scale" type="text" name="" id="bank_name" placeholder="名称不一致,填入汇款单位名称">
                        </div>
                    </div>

                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">出票金额&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select" type="number" name="custodian" id="money_1" placeholder="请输入出票金额" />
                            <div class="weui-select" id="show_number_1"></div>
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">背书情况&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select" type="number" name="custodian" id="bsqk" placeholder="请输入背书次数" />
                        </div>
                    </div>
                </div>
                <div class="weui-cells weui-cells_form">

                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">附件上传&nbsp;&nbsp;
                            </label>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-uploader__bd">
                            <ul class="weui-uploader__files" id="uploaderFiles" style="margin-bottom: 0px;float: left;">
                            </ul>
                            <div class="weui-uploader__input-box">
                                <input onclick="imgUpload()" class="weui-uploader__input" />
                                <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*"
                                    name="file_image[]" multiple style="display: none;" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="weui-cells weui-cells_form">
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">相关说明&nbsp;&nbsp;
                            </label>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__bd" id="cnt">
                            <textarea class="weui-textarea" name="reason" id="hpsm" placeholder="请输入相关说明；
            "
                                rows="2"></textarea>
                            <div class="weui-textarea-counter">
                                <span id="reason_char">0</span>/200</div>
                        </div>
                    </div>
                </div>
                <div class="button-sp-area" style="margin-bottom: 20px;display: flex;flex-direction: row;width: 100%;justify-content: space-around;align-items: baseline;">
                    <a href="javascript:;" id="ratio-refuse" class="weui-btn weui-btn_warn" style="width: 40%;">取消</a>
                    <a href="javascript:;" id="ratio-agree" class="weui-btn weui-btn_primary" style="width: 40%">确定</a>
                </div>
            </div>
        </div>
    </div>
</block>
<block name="other">
    <div class="modal fade" id="signModal" tabindex="-1" role="dialog" aria-labelledby="signModalLabel" aria-hidden="true"
        width="100%">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only sign_close">Close</span>
                    </button>
                    <h4 class="modal-title" id="signModalLabel">选择人员</h4>
                </div>
                <div class="modal-body" id="select_sign_content" style="padding-top: 0px;padding-bottom: 0px;">
                    <div class="page js_show" style="position: relative;">
                        <div class="page__bd">
                            <!-- <div class="weui-search-bar" id="sign_searchBar">
                                <form class="weui-search-bar__form">
                                    <div class="weui-search-bar__box">
                                        <i class="weui-icon-search"></i>
                                        <input type="search" class="weui-search-bar__input" id="sign_searchInput" placeholder="请输入姓名或拼音缩写搜索" required="">
                                        <a href="javascript:" class="weui-icon-clear" id="sign_searchClear"></a>
                                    </div>
                                    <label class="weui-search-bar__label" id="sign_searchText">
                                        <i class="weui-icon-search"></i>
                                        <span>请输入姓名或拼音缩写搜索</span>
                                    </label>
                                </form>
                                <a href="javascript:" class="weui-search-bar__cancel-btn" id="sign_searchCancel">搜索</a>
                            </div> -->
                            <div class="weui-cells searchbar-result" id="sign_searchResult" style="margin-top: 0px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default sing_to_close" data-dismiss="modal">关闭</button>
                    <!-- <button type="button" class="btn btn-success" id="sign_pre-level" data-pid="">上一级</button> -->
                </div>
            </div>
        </div>
    </div>
    <div id="sign_dialogs">
        <div class="js_dialog" id="signDialog" style="display: none;">
            <div class="weui-mask"></div>
            <div class="weui-dialog">
                <div class="weui-dialog__hd">
                    <strong class="weui-dialog__title">是否删除签收人</strong>
                </div>
                <div class="weui-dialog__ft">
                    <a href="javascript:;" onclick="sign_dialog_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                    <a href="javascript:;" onclick="sign_dialog_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                </div>
            </div>
        </div>
    </div>
</block>
<block name="js">
    <script src="__PUBLIC__/assets/js/AmountConversionformat.js"></script>
    <script>

        var sign_type = '',
            department_id = 0;
            mode_type = '';
            sort = '';
        $('#signModal').on('show.bs.modal', function (e) {
            var id = department_id;
            $("#sign_pre-level").attr("data-pid", department_id);
            getSignDepartment(department_id);
        });
        $('.open_sign_model').on('click', function () {
            department_id = $(this).attr('index');
            mode_type = $(this).attr('mode');
            sort = $(this).attr('sort');
            $('#signModal').modal('show');
        });

        function getSignDepartment(id) {
            $('#sign_searchResult').empty();
            $('#sign_searchResult').append(loading);
            $.post("{:U('Light/Apply/getDeptHtml')}",
                {
                    "id": id,
                    "mode_type" : mode_type,
                }, function (data) {
                    $('#sign_searchResult').empty();
                    if (data == '') {
                        $('#sign_searchResult').append(noresult);
                    } else {
                        $('#sign_searchResult').append(data);
                    }
                }
            );
        }
        // up pre-level
        $("#sign_pre-level").on("click", function () {
            $('#sign_searchResult').empty();
            $('#sign_searchResult').append(loading);
            var pid = $(this).attr("data-pid");
            // console.log(pid);
            getSignDepartment(department_id)
        });
        // select department
        $("#sign_searchResult").on("click", ".select-department", function () {
            var id = $(this).attr('data-id');
            var type = $(this).attr('data-type');
            sign_type = id;
            // console.log(id);
            getSignDepartment(id);
            $("#sign_pre-level").attr("data-pid", id);
        });
        // select department user
        $selectSign = $(".user_show");
        $("#sign_searchResult").on("click", ".select-user", function () {
            // var tmpl = '<li class="weui-uploader__file weui-selet__user" style="background-image:url(#url#)" id="#id#"></li>';
            var tmpl = '<li class="weui-uploader__file wk-select__user" id="#id#" style="height:90px;"><img src="#url#" class="weui-selet__user" style="margin-bottom: 0px;margin-right: 6px;margin-top:10px;" /><span style="margin-right: 6px;font-size: 14px;">#name#</span><span class="weui-badge" style="position: relative;top: -5.8em;right: -1.4em;">X</span></li>';
            var id = $(this).attr('data-id');
            var type = $(this).attr('data-type');
            var img = $(this).attr('data-img');
            var name = $(this).attr('data-name');
            var ids = $("#sign_id").val() + "," + id;
            // console.log(id);
            tmpl = tmpl.replace('#id#', id);
            tmpl = tmpl.replace('#name#', name);
            var index = sort - 1;
            // if (department_id == 5) index = 1;
            $selectSign.eq(index).html($(tmpl.replace('#url#', img)));
            $("#sign_id").val(ids);
            $('#signModal').modal('hide')
        });
        // delete copyto user
        $("#selectSign").on("click", ".wk-select__user", function () {
            $li_dom = $(this);
            $("#signDialog").fadeIn(200);
        });
        function sign_dialog_close() {
            $("#signDialog").fadeOut(100);
        }
        // Confirm dialog
        function sign_dialog_confirm() {
            var id = $li_dom.attr("id");
            var ids = $("#sign_id").val() + ",";
            var old_ids_arr = ids.split(",");
            var id_str = '';
            var location = $.inArray(id, old_ids_arr);
            if (location >= 0) {
                var repl_id = ',' + id;
                id_str = ids.replace(repl_id, ',');
            }
            $("#sign_id").val(id_str);
            $li_dom.remove();
            $("#signDialog").fadeOut(100);
        }

        // 抄送搜索
        $(function () {
            var $searchBar = $('#sign_searchBar'),
                $searchResult = $('#sign_searchResult'),
                $searchText = $('#sign_searchText'),
                $searchInput = $('#sign_searchInput'),
                $searchClear = $('#sign_searchClear'),
                $searchCancel = $('#sign_searchCancel');

            function hideSearchResult() {
                // $searchResult.hide();
                $searchInput.val('');
            }
            function cancelSearch() {
                hideSearchResult();
                $searchBar.removeClass('weui-search-bar_focusing');
                $searchText.show();
            }

            $searchText.on('click', function () {
                $searchBar.addClass('weui-search-bar_focusing');
                $searchInput.focus();
            });
            $searchInput
                .on('blur', function () {
                    if (!this.value.length) cancelSearch();
                })
                .on('input', function () {
                    if (this.value.length) {
                        $searchResult.show();
                        searchSignUser();
                    } else {
                        modelIni()
                    }
                })
                ;
            $searchClear.on('click', function () {
                hideSearchResult();
                $searchInput.focus();
            });
            $searchCancel.on('click', function () {
                searchSignUser();
            });
            $searchInput.on('keypress', function (e) {
                var keycode = e.keyCode;
                var searchName = $(this).val();
                if (keycode == '13') {
                    e.preventDefault();

                    searchSignUser();
                }
            });
            function searchSignUser() {
                word = $searchInput.val();
                if (!word.length) return modelIni();
                $('#searchResult').empty();
                $('#searchResult').append(loading);
                $.post("{:U('Light/Apply/getDeptHtml')}",
                    {
                        "type": 1,
                        'search': word
                    }, function (data) {
                        $('#sign_searchResult').empty();
                        // console.log(data);
                        if (data == '') {

                            $('#sign_searchResult').append(noresult);
                        } else {

                            $('#sign_searchResult').append(data);
                            // console.log(data.pid);
                            $("#sign_pre-level").attr("data-pid", 17);
                        }
                    }
                );
            }

            function modelIni() {
                var id = 1;
                $searchInput.val(null);
                $("#sign_pre-level").attr("data-pid", 0);
                getSignDepartment(id);
            }
        });
        // 汇票时间
        // 日期选择
        var hp_date = '';
        $('#hpDatePicker_1').on('click', function () {
            hp_date = $(this);
            weui.datePicker({
                start: 2018,
                end: new Date().getFullYear() + 10,
                defaultValue: [new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate()],
                onConfirm: function (result) {
                    DateValue(result);

                },
                id: 'hpDatePicker_1'
            });
        });
        $('#hpDatePicker_2').on('click', function () {
            hp_date = $(this);
            weui.datePicker({
                start: 2018,
                end: new Date().getFullYear() + 10,
                defaultValue: [new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate()],
                onConfirm: function (result) {
                    DateValue(result);

                },
                id: 'hpDatePicker_2'
            });
        });
        $('#hpDatePicker_3').on('click', function () {
            hp_date = $(this);
            weui.datePicker({
                start: 2018,
                end: new Date().getFullYear() + 10,
                defaultValue: [new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate()],
                onConfirm: function (result) {
                    DateValue(result);

                },
                id: 'hpDatePicker_3'
            });
        });
        // 日历填充
        function DateValue(dateArr) {
            var val = dateArr[0] + '-';
            val += dateArr[1] > 9 ? dateArr[1] : '0' + dateArr[1];
            val += '-';
            val += dateArr[2] > 9 ? dateArr[2] : '0' + dateArr[2];
            hp_date.val(val);
        }



        // bank获取
        var bankInfo = '', imagepath = '';
        getBank()
        function getBank() {
            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/AddMoneyQtTzApi')}",
                dataType: 'json',
                data: {
                    system: "{$system}",
                    modname: 'AddMoneyQtTz',
                    action: 'getBankInfo',
                },
                success: function (res) {
                    bankInfo = res;
                }
            });
        }
        // 生成收款银行
        $('#fkfs').change(function () {
            var index = $(this).val();
            makeOption(bankInfo[index]);
        })

        function makeOption(data) {
            var optionStr = '';
            for (i = 0; i < data.length; i++) {
                optionStr += '<option selected=""  value="' + data[i][2] + '">' + data[i][0] + '</option>';
            }
            optionStr += '<option value="-1" disabled selected style="display:none;">请选择银行账号</option>';
            $('#bank').html(optionStr);
        }
        // 日期更改
        var label = "收款日期&nbsp;&nbsp;<span style='color:red;'>*</span>",
            datePicker = $('#showDatePicker'),
            the_date = datePicker.val(),
            this_time = new Date(the_date),
            H = new Date().getHours() + 1,
            money = $('#money'),
            H = H > 9 ? H : '0' + H;
        var arr_week = new Array("星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六");
        now = this_time.getFullYear() + '-' + ((this_time.getMonth() + 1) > 9 ? (this_time.getMonth() + 1) : '0' + (this_time.getMonth() + 1)) + '-' + (this_time.getDate() > 9 ? this_time.getDate() : '0' + this_time.getDate()) + ' ' + H + ':00';

        // 附件上传 
        // 触发上传机制
        function imgUpload() {
            $("#knowDialog").fadeIn(100);
        }

        // 内容提示(知道了)
        function dialog_iknow() {
            $("#knowDialog").fadeOut(100);
            filechooser.click();
        }

        // 图片压缩
        var filechooser = document.getElementById("uploaderInput");

        // Close dialog
        //    用于压缩图片的canvas
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        //    瓦片canvas
        var tCanvas = document.createElement("canvas");
        var tctx = tCanvas.getContext("2d");
        var maxsize = 100 * 1024;
        var img_num = 0;
        var imgIndex = "",
            imgdom = "";
        $("#upload").on("click", function () {
            filechooser.click();
        }).on("touchstart", function () {
            $(this).addClass("touch")
        })
            .on("touchend", function () {
                $(this).removeClass("touch")
            });
        filechooser.onchange = function () {
            if (!this.files.length) return;
            var files = Array.prototype.slice.call(this.files);
            if (files.length > 1 || img_num > 0) {
                alert("最多只可上传1张图片");
                return;
            }
            files.forEach(function (file, i) {
                if (!/\/(?:jpeg|png|gif)/i.test(file.type)) return;
                // console.log(file);
                // console.log(i);
                // console.log(Orientation);
                var reader = new FileReader();
                var li = document.createElement("li");
                //          获取图片大小
                var size = file.size / 1024 > 1024 ? (~~(10 * file.size / 1024 / 1024)) / 10 + "MB" : ~~(file.size / 1024) + "KB";
                // li.innerHTML = '<div class="progress"><span></span></div><div class="size">' + size + '</div>';
                li.innerHTML = '<div class="weui-uploader__file-content"></div>';
                $(li).addClass("weui-uploader__file weui-uploader__file_status");
                $("#uploaderFiles").append($(li));
                reader.onload = function () {
                    var result = this.result;
                    var img = new Image();
                    img.src = result;
                    $(li).css("background-image", "url(" + result + ")");

                    //如果图片大小小于100kb，则直接上传
                    if (result.length <= maxsize) {
                        img = null;
                        // TODO：这里没有做图片旋转，小于100K可能会有问题
                        upload(result, file.type, $(li), i);
                        return;
                    }
                    //      图片加载完毕之后进行压缩，然后上传
                    if (img.complete) {
                        callback();
                    } else {
                        img.onload = callback;
                    }

                    function callback() {
                        //获取照片方向角属性，用户旋转控制  
                        EXIF.getData(file, function () {
                            Orientation = EXIF.getTag(this, 'Orientation');
                            // alert(Orientation);
                            var data = compress(img, Orientation);
                            upload(data, file.type, $(li), i);
                            img = null;
                        });
                    }
                };
                reader.readAsDataURL(file);
            })
        };
        //对图片旋转处理 added by lzk  
        function rotateImg(img, direction, canvas) {
            // alert(img);  
            //最小与最大旋转方向，图片旋转4次后回到原方向    
            var min_step = 0;
            var max_step = 3;
            //var img = document.getElementById(pid);    
            if (img == null) return;
            //img的高度和宽度不能在img元素隐藏后获取，否则会出错    
            var height = img.height;
            var width = img.width;
            //var step = img.getAttribute('step');    
            var step = 2;
            if (step == null) {
                step = min_step;
            }
            if (direction == 'right') {
                step++;
                //旋转到原位置，即超过最大值    
                step > max_step && (step = min_step);
            } else {
                step--;
                step < min_step && (step = max_step);
            }
            //img.setAttribute('step', step);    
            /*var canvas = document.getElementById('pic_' + pid);   
            if (canvas == null) {   
                img.style.display = 'none';   
                canvas = document.createElement('canvas');   
                canvas.setAttribute('id', 'pic_' + pid);   
                img.parentNode.appendChild(canvas);   
            }  */
            //旋转角度以弧度值为参数    
            var degree = step * 90 * Math.PI / 180;
            // var ctx = canvas.getContext('2d');
            // console.log(step);
            switch (step) {
                case 0:
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0);
                    break;
                case 1:
                    canvas.width = height;
                    canvas.height = width;
                    ctx.rotate(degree);
                    ctx.drawImage(img, 0, -height);
                    break;
                case 2:
                    canvas.width = width;
                    canvas.height = height;
                    ctx.rotate(degree);
                    ctx.drawImage(img, -width, -height);
                    break;
                case 3:
                    canvas.width = height;
                    canvas.height = width;
                    ctx.rotate(degree);
                    ctx.drawImage(img, -width, 0);
                    break;
            }
        }
        //    使用canvas对大图片进行压缩
        function compress(img, Orientation) {
            var initSize = img.src.length;
            var width = img.width;
            var height = img.height;
            //如果图片大于四百万像素，计算压缩比并将大小压至400万以下
            var ratio;
            if ((ratio = width * height / 4000000) > 1) {
                ratio = Math.sqrt(ratio);
                width /= ratio;
                height /= ratio;
            } else {
                ratio = 1;
            }
            canvas.width = width;
            canvas.height = height;
            //        铺底色
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            //如果图片像素大于100万则使用瓦片绘制
            var count;
            if ((count = width * height / 1000000) > 1) {
                count = ~~(Math.sqrt(count) + 1); //计算要分成多少块瓦片
                //            计算每块瓦片的宽和高
                var nw = ~~(width / count);
                var nh = ~~(height / count);
                tCanvas.width = nw;
                tCanvas.height = nh;
                for (var i = 0; i < count; i++) {
                    for (var j = 0; j < count; j++) {
                        tctx.drawImage(img, i * nw * ratio, j * nh * ratio, nw * ratio, nh * ratio, 0, 0, nw, nh);
                        ctx.drawImage(tCanvas, i * nw, j * nh, nw, nh);
                    }
                }
            } else {
                ctx.drawImage(img, 0, 0, width, height);
            }

            // console.log(Orientation);

            if (navigator.userAgent.match(/iphone/i)) {
                console.log('iphone');
                //alert(expectWidth + ',' + expectHeight);  
                //如果方向角不为1，都需要进行旋转 added by lzk  
                if (Orientation != "" && Orientation != 1) {
                    console.log('旋转处理');
                    switch (Orientation) {
                        case 6://需要顺时针（向左）90度旋转  
                            console.log('需要顺时针（向左）90度旋转');
                            rotateImg(img, 'left', canvas);
                            break;
                        case 8://需要逆时针（向右）90度旋转  
                            console.log('需要顺时针（向右）90度旋转');
                            rotateImg(img, 'right', canvas);
                            break;
                        case 3://需要180度旋转  
                            console.log('需要180度旋转');
                            rotateImg(img, 'right', canvas);//转两次  
                            rotateImg(img, 'right', canvas);
                            break;
                    }
                }
            } else {
                //alert(Orientation);  
                if (Orientation != "" && Orientation != 1) {
                    //alert('旋转处理');  
                    switch (Orientation) {
                        case 6://需要顺时针（向左）90度旋转  
                            console.log('需要顺时针（向左）90度旋转');
                            rotateImg(img, 'left', canvas);
                            break;
                        case 8://需要逆时针（向右）90度旋转  
                            console.log('需要顺时针（向右）90度旋转');
                            rotateImg(img, 'right', canvas);
                            break;
                        case 3://需要180度旋转  
                            console.log('需要180度旋转');
                            rotateImg(img, 'right', canvas);//转两次  
                            rotateImg(img, 'right', canvas);
                            break;
                    }
                }

            }

            var srcStr = img.src;
            var img_header = srcStr.substring(0, 23);
            // console.log(img_header);
            var indexSearch = img_header.indexOf('png');
            console.log(indexSearch);
            //进行最小压缩
            if (indexSearch <= 0) {
                var ndata = canvas.toDataURL('image/jpeg', 0.4);
            }
            else if (indexSearch > 0) {
                var ndata = canvas.toDataURL('image/jpeg', 0.4);//'image/png'
            }
            // console.log('压缩前：' + initSize);
            // console.log('压缩后：' + ndata.length);
            // console.log('压缩率：' + ~~(100 * (initSize - ndata.length) / initSize) + "%");
            tCanvas.width = tCanvas.height = canvas.width = canvas.height = 0;
            return ndata;
        }
        //    图片上传，将base64的图片转成二进制对象，塞进formdata上传
        function upload(basestr, file, $li, i) {
            var text = window.atob(basestr.split(",")[1]);
            // var buffer = new Uint8Array(text.length);
            var pecent = 0,
                loop = null;
            // for (var i = 0; i < text.length; i++) {
            //     buffer[i] = text.charCodeAt(i);
            // }
            // var blob = getBlob([buffer], type);
            var xhr = new XMLHttpRequest();
            var formdata = getFormData();
            // console.log(blob);
            // formdata.append('imagefile', blob);
            formdata.append('imagefile', basestr);
            formdata.append('system', "{$system}");
            formdata.append('modname', "AddMoneyQtTz");
            formdata.append('action', "hpsc");
            u = "{:U('Light/Api/AddMoneyQtTzApi')}";
            xhr.open('post', u);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var jsonData = JSON.parse(xhr.responseText);

                    var imagedata = jsonData[0] || {};
                    var text = imagedata.path ? '上传成功' : '上传失败';
                    imagepath = imagedata.output_file;
                    console.log(text + '：' + imagedata.path);
                    clearInterval(loop);
                    //当收到该消息时上传完毕
                    // $li.find(".weui-uploader__file-content").animate({ 'width': "100%" }, pecent < 95 ? 200 : 0, function() {
                    //     $(this).html(text);
                    // });
                    $li.find(".weui-uploader__file-content").html("");
                    $li.find(".weui-uploader__file-content").parent().removeClass("weui-uploader__file_status");
                    img_num++;
                    $("#upload_nums").text(img_num);
                    var file_names = $("#file_names").val() + imagedata.output_file + "|";
                    $("#file_names").val(file_names);

                    if (!imagedata.path) return;
                    // $(".pic-list").append('<a href="' + imagedata.path + '">' + imagedata.name + '（' + imagedata.size + '）<img src="' + imagedata.path + '" /></a>');
                }
            };
            //数据发送进度，前50%展示该进度
            xhr.upload.addEventListener('progress', function (e) {
                if (loop) return;
                pecent = ~~(100 * e.loaded / e.total) / 2;
                // $li.find(".weui-uploader__file-content").css('width', pecent + "%");
                $li.find(".weui-uploader__file-content").html(pecent + "%");
                if (pecent == 50) {
                    mockProgress();
                }
            }, false);
            //数据后50%用模拟进度
            function mockProgress() {
                if (loop) return;
                loop = setInterval(function () {
                    pecent++;
                    // $li.find(".weui-uploader__file-content").css('width', pecent + "%");
                    $li.find(".weui-uploader__file-content").html(pecent + "%");
                    console.log(pecent);
                    if (pecent == 99) {
                        clearInterval(loop);
                    }
                }, 100)
            }
            xhr.send(formdata);

            $(".weui-uploader__file").on('click', function () {
                imgIndex = $(this).index();
                imgdom = $(this);
                // console.log(imgIndex);
            })

            $(".weui-gallery__del").on('click', function () {
                // 是否删除该图
                $("#iosDialog_imgDel").fadeIn(100);
            })

        }

        // 取消图片删除
        function dialog_close_imgdelete() {
            $("#iosDialog_imgDel").fadeOut(100);
        }
        // 确认图片删除
        function dialog_confirm_imgdelete() {
            imgdom.remove();
            var file_names_str = $("#file_names").val();
            var file_names_arr = file_names_str.split("|");
            file_names_arr.splice(imgIndex, 1);
            var file_str_1 = file_names_arr.toString();
            var file_str_2 = file_str_1.replace(/,/g, "|");
            // console.log(file_str_2);
            $("#file_names").val(file_str_2);
            $("#iosDialog_imgDel").fadeOut(100);
        }

        /**
         * 获取blob对象的兼容性写法
         * @param buffer
         * @param format
         * @returns {*}
         */
        function getBlob(buffer, format) {
            try {
                return new Blob(buffer, { type: format });
            } catch (e) {
                var bb = new (window.BlobBuilder || window.WebKitBlobBuilder || window.MSBlobBuilder);
                buffer.forEach(function (buf) {
                    bb.append(buf);
                });
                return bb.getBlob(format);
            }
        }
        /**
         * 获取formdata
         */
        function getFormData() {
            var isNeedShim = ~navigator.userAgent.indexOf('Android') &&
                ~navigator.vendor.indexOf('Google') &&
                !~navigator.userAgent.indexOf('Chrome') &&
                navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop() <= 534;
            return isNeedShim ? new FormDataShim() : new FormData()
        }
        /**
         * formdata 补丁, 给不支持formdata上传blob的android机打补丁
         * @constructor
         */
        function FormDataShim() {
            console.warn('using formdata shim');
            var o = this,
                parts = [],
                boundary = Array(21).join('-') + (+new Date() * (1e16 * Math.random())).toString(36),
                oldSend = XMLHttpRequest.prototype.send;
            this.append = function (name, value, filename) {
                parts.push('--' + boundary + '\r\nContent-Disposition: form-data; name="' + name + '"');
                if (value instanceof Blob) {
                    parts.push('; filename="' + (filename || 'blob') + '"\r\nContent-Type: ' + value.type + '\r\n\r\n');
                    parts.push(value);
                } else {
                    parts.push('\r\n\r\n' + value);
                }
                parts.push('\r\n');
            };
            // Override XHR send()
            XMLHttpRequest.prototype.send = function (val) {
                var fr,
                    data,
                    oXHR = this;
                if (val === o) {
                    // Append the final boundary string
                    parts.push('--' + boundary + '--\r\n');
                    // Create the blob
                    data = getBlob(parts);
                    // Set up and read the blob into an array to be sent
                    fr = new FileReader();
                    fr.onload = function () {
                        oldSend.call(oXHR, fr.result);
                    };
                    fr.onerror = function (err) {
                        throw err;
                    };
                    fr.readAsArrayBuffer(data);
                    // Set the multipart content type and boudary
                    this.setRequestHeader('Content-Type', 'multipart/form-data; boundary=' + boundary);
                    XMLHttpRequest.prototype.send = oldSend;
                } else {
                    oldSend.call(this, val);
                }
            };
        }

        // END => 图片上传 


        // 确定按钮  -- 汇票提交
        $('#ratio-agree').click(function () {

            var hphm = $('#hphm').val(),
                mj = $('#mj').val(),
                xz = $('#xz').val(),
                kpyh1 = $('#kpyh1').val(),
                bank_name = $('#bank_name').val(),
                bsqk = $('#bsqk').val(),
                money_1 = $('#money_1').val();

            if (!imagepath) return tooltip('请上传附件');
            if (!hphm) return tooltip('请填写汇票号码');
            if (mj == -1 || !mj) return tooltip('请选择汇票媒介');
            if (xz == -1 || !xz) return tooltip('请选择汇票性质');
            if (kpyh1 == -1 || !kpyh1) return tooltip('请选择开票银行');
            if (kpyh1 == '其他银行' && !bank_name) return tooltip('请输入银行名称');
            if (!money_1 || money_1 < 0) return tooltip('出票金额不能为空或小于零');
            if (!bsqk || bsqk < 0) return tooltip('背书次数不能为空或小于零');
            toast.fadeIn(200);
            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/AddMoneyQtTzApi')}",
                dataType: 'json',
                data: {
                    hphm: hphm,
                    mj: mj,
                    xz: xz,
                    kpyh1: kpyh1,
                    bank_name: bank_name,
                    money_1: money_1,
                    bsqk: bsqk,
                    spdate: $('#hpDatePicker_1').val(),
                    kpdate: $('#hpDatePicker_2').val(),
                    dqdate: $('#hpDatePicker_3').val(),
                    reason: $('#hpsm').val(),
                    imagepath: imagepath,
                    system: "{$system}",
                    modname: 'AddMoneyQtTz',
                    action: 'hptj',
                    __hash__: hash
                },
                dataType: 'json',
                success: function (res) {
                    toast.fadeOut(200);
                    if (res.code == 200) {
                        $('#other_page').fadeOut(200);
                    } else {
                        tooltip(res.msg);
                    }
                }
            });
        });
        // 取消按钮
        $('#ratio-refuse').click(function () {
            $('#other_page').fadeOut(200);
        });

        // 汇票弹出
        $('#fkfs').change(function () {
            if ($(this).val() == 3) {
                $('#btnhp').fadeIn(200);
            } else {
                $('#btnhp').fadeOut(200);
            }
        })
        // 点击汇票按钮跳出汇票页面

        $('#select_ycl').click(function () {
            $('#other_page').fadeIn(200);
        });
        // 银行名称隐藏
        $('#bank_name_div').hide();
        $('#kpyh1').change(function () {
            if ($(this).val() == '其他银行') $('#bank_name_div').fadeIn(200);
            else $('#bank_name_div').fadeOut(200);
        })
        // 日期插件
        datePicker.val(null);
        datePicker.attr('placeholder', '前三天至今天');
        $('.weui-label').eq(1).html(label);

        $('.greyColor').change(function () {
            $(this).removeClass('greyColor');
        })

        function ratioTime() {
            // 日期选择
            var hours = [],
                minites = [],
                symbol = [];

            for (var i = 0; i < 4; i++) {
                $date = new Date();
                $date = $date.setDate($date.getDate() - 3 + i);
                $date = new Date($date);

                var Y = $date.getFullYear(),
                    M = $date.getMonth() + 1,
                    D = $date.getDate();

                var hours_item = {};
                hours_item.label = Y + '-' + M + '-' + D + ' ' + arr_week[$date.getDay()];
                if (i == 3) {
                    hours_item.label = '今天';
                }
                hours_item.value = Y + '-' + M + '-' + D;
                hours.push(hours_item);
            }

            weui.picker(symbol, hours, minites, {
                defaultValue: [0, hours_item.value, 0],
                onConfirm: function (result) {
                    pickerValue(result);
                }
            });
        }

        // 日历填充
        function pickerValue(dateArr) {
            var val = dateArr[1];
            $('#showDatePicker').val(val);
        }

        $('#submit').click(function () {
            var datetime = $('#showDatePicker').val(),
                fkfs = $('#fkfs').val(),
                bank = $('#bank').val(),
                money = $('#money').val(),
                srlx = $('#srlx').val();
            if (!datetime) return tooltip('请选择收款时间');

            if (fkfs == -1 || !fkfs) return tooltip('请选择收款方式');
            if (bank == -1 || !bank) return tooltip('请选择收款银行');
            if (srlx == -1 || !srlx) return tooltip('请选择收款银行');
            if (!money ) return tooltip('收款金额不能为空');
            // 留言判断
            var reason = $('#reason').val(),
                ids = $("#sign_id").val() + ",",
                old_ids_arr = ids.split(","),
                flag = 1;
            for (i = 0; i < old_ids_arr.length; i++) {
                if (old_ids_arr[i] != '') flag = 0;
            }
            if (flag) return tooltip('请选择签收人');

            str = $selectSign.eq(0).text();
            str = str.replace(/\s+/g, "");
            if (str == 0) return tooltip('请选择财务部签收人');

            toast.fadeIn(200);
            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/AddMoneyQtTzApi')}",
                dataType: 'json',
                data: {
                    sign: ids,
                    fkfs: fkfs,
                    bank: bank,
                    srlx: srlx,
                    money: money,
                    text: reason,
                    datetime: datePicker.val(),
                    copyto_id: $("#copyto_id").val(),
                    system: "{$system}",
                    modname: 'AddMoneyQtTz',
                    action: 'submit',
                    __hash__: hash
                },
                dataType: 'json',
                success: function (res) {
                    toast.fadeOut(200);
                    if (res.code == 200) {
                        window.location.href = "{$fixed['info']}" + "&aid=" + res.aid;
                    } else {
                        tooltip(res.msg);
                    }
                }
            });
        });
        // 输入框插件
        var init_data = {
            'input': money,
            'show_div': $('#show_number'),
            'symbol': "&yen;",
            'input_show_bool': false
        };
        var forTest = new AmountConversionformat(init_data);
        forTest.init();

        // 输入框插件
        var init_data_1 = {
            'input': $('#money_1'),
            'show_div': $('#show_number_1'),
            'symbol': "&yen;",
            'input_show_bool': false
        };
        var forTest_1 = new AmountConversionformat(init_data_1);
        forTest_1.init();
    </script>
</block>