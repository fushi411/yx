<extend name="Apply:applyBase" />

<!-- 去除不可选择日期 -->
<block name="disable_date"></block>
<block name="able_date"></block>
<block name="content_body">
    <style>
        body .weui-form-preview__value {
            color: #4e4e4e;
        }

        .no-more {
            display: none;
            text-align: center;
            line-height: 30px;
            color: #cecece;
            font-size: 12px;
            background: #f0f0f0;
        }

        .load-more {
            display: none;
            text-align: center;
            line-height: 30px;
            color: #6ea3f3;
            font-size: 12px;
            border-radius: 5px;
            width: 98%;
            margin: 0 auto;
            border-top: 1px solid rgb(243, 237, 237);
        }


        .load-more:active {
            background: #97d4ff;
            color: #fff;
        }

        #btn-all {
            display: none;
            right: 10px;
            bottom: 10px;
            position: fixed;
            text-align: center;
            z-index: 999;
        }

        label {
            font-weight: 400;
            margin-bottom: 0px;
        }

        .searchCenter {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .addbtn {
            color: #4b4b4b;
        }

        .addbtn:hover {
            color: #b0b0b0;
        }

        .hide {
            display: none;
        }
    </style>
    <input type="hidden" id="ratio" value="ratio">
    <div class="weui-cells" id="content1">
        <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd">
                <label class="weui-label">费用选择&nbsp;&nbsp;
                    <span style="color:red;">*</span>
                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-select " type="text" readonly id="select_ycl" style="color: #337ab7;" value="点击选择费用" />
            </div>
        </div>
        <div class="weui-panel__bd weui-cell" style="padding:0">
            <div class="weui-media-box weui-media-box_small-appmsg">
                <div class="weui-cells">
                    <span class="weui-media-box weui-media-box_appmsg">
                        <div class="weui-media-box__bd" id="apply_status">
                            <div id='content_costmoney'>
                                    <p class="weui-media-box__desc weui-flex"><span>自动填写</span></p>
                            </div>
                        </div>
                    </span>
                </div>
            </div>
        </div>
        <div id='fj' style="display: none;">
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <label class="weui-label" style="width: 100%;">附件&nbsp;&nbsp;
                    </label>
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files " id="viewer"  style="margin-bottom: 0px;float: left;">
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
            <div class="weui-cell__hd">
                <label class="weui-label" style="width: 100%;">附件上传&nbsp;&nbsp;
                    <span style="color:red;">*</span>
                    <span style="color: #f12e2e;font-size: 14px;">（点击+号，可查看或删除附件）</span>
                </label>
            </div>
        </div>
        <div class="weui-cell">
            <div class="weui-uploader__bd">
                <ul class="weui-uploader__files " id="uploaderFiles" style="margin-bottom: 0px;float: left;">
                </ul>
                <div class="weui-uploader__input-box" style="margin-top: 5px;">
                    <input onclick="imgUpload()" class="weui-uploader__input" />
                    <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" name="file_image[]" multiple style="display: none;"/>
                </div>
            </div>
        </div>
    </div>
    <div class="other_page" id="other_page" style='display: none;'>
        <div class="container">
            <div class="page js_show">
                    <div class="weui-cells weui-cells_form">
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="">费用类型</span>&nbsp;&nbsp;
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <select class="weui-select greyColor" name="type" id='fylx'>
                                <option value='-1' disabled selected style='display:none;'>请选择费用类型</option>
                                <option value="bx">报销费用</option>
                                <option value="yk">用款费用</option>
                            </select>
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after ">
                        <div class="weui-cell__hd">
                            <label class="weui-label" >用款金额&nbsp;&nbsp;
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select peibi scale" type="number" name="Num" id="number" placeholder="请输入费用金额">
                        </div>
                    </div>
                </div>
                <div class="weui-cells weui-cells_form" id="order_select" style="margin-top: 0;min-height: 101%">    
                    <div class="page__bd">
                        <div class="weui-cells searchbar-result" id="order_searchResult" style="background-color:#f8f8f8;margin-top:0;">

                        </div>
                        <div class="no-more">信息已经到底...</div>
                        <div class="load-more">点我加载更多...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="btn-all">
        <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_primary">返回</a>
    </div>
</block>
<block name="Process">
    <div class="weui-cells__title">签收人员选择
        <span style="color: #f12e2e">（各部门须选择1人签收）</span>
    </div>
    <div class="weui-cells" style="margin-top:0px;">
        <div class="weui-cell" style="padding-top: 0px;padding-bottom: 5px;margin-bottom: 10px;">
            <div class="weui-cell__bd">
                <div class="weui-uploader">
                    <div class="weui-uploader__bd">
                        <ul class="weui-uploader__files" id="selectSign" style="margin-bottom: 0px;">
                            <li class="weui-uploader__file" style="min-height:80px;">
                                <div class="user_show">

                                </div>
                                <div class="box_div">
                                    <div class="weui-uploader__input-box" style="width: 2.5em;height: 2.5em;margin-right: 0px;margin-bottom: 0px;margin-top:10px;">
                                        <input id="signInput" class="weui-uploader__input open_sign_model" index="25" type="button" name="sign" readonly />
                                        <!--data-toggle="modal" data-target="#myModal" -->

                                    </div>
                                    <span style="margin-right: 6px;font-size: 14px;">财务部</span>
                                </div>
                            </li>
                        </ul>
                        <input type="hidden" name="sign_id" id="sign_id" value="">
                    </div>
                </div>
            </div>
        </div>
    </div>

</block>

<block name='js'>
    <div class="weui-gallery" id="gallery">
            <span class="weui-gallery__img" id="galleryImg"></span>
            <div class="weui-gallery__opr">
                <a href="javascript:" class="weui-gallery__del">
                    <i class="weui-icon-delete weui-icon_gallery-delete"></i>
                </a>
            </div>
    </div>
    <div id="dialogs">
        <div class="js_dialog" id="iosDialog_imgDel" style="display: none;">
            <div class="weui-mask"></div>
            <div class="weui-dialog">
                <div class="weui-dialog__hd"><strong class="weui-dialog__title">是否删除该图片</strong></div>
                <div class="weui-dialog__ft">
                    <a href="javascript:;" onclick="dialog_close_imgdelete()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                    <a href="javascript:;" onclick="dialog_confirm_imgdelete()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                </div>
            </div>
        </div>
    </div>
    <script src="__PUBLIC__/assets/js/base64_js.js"></script>
    <script>
        var params = getQueryString('id');
        var feeid = params;
        // 页面的隐藏显示
        $('#select_ycl').click(function(){
            if(params) return;
            $('#other_page').show();
            $('#btn-all').show();
        });
        $('#btn-all').click(function(){
            $('#other_page').hide();
            $('#btn-all').hide();
        });

        if(!params){
            getDataOfFp();
        }
        $('#fylx').change(function(){
            getDataOfFp();
        });
        $('#number').change(function(){
            getDataOfFp();
        });
        function getDataOfFp(){
            var fylx = $('#fylx').val();
            var money = $('#number').val();
            $.ajax({
                
                type: 'POST',
                url: "{:U('Light/Api/FpsmApi')}",
                dataType: 'json',
                data: {
                    fylx:fylx,
                    money:money,
                    system: "{$system}",
                    modname: 'Fpsm',
                    action: 'getDataOfFp',
                },
                dataType: 'json',
                success: function (res) {
                    if(res.length == 0) {
                        $('#order_searchResult').html('');
                        $('.no-more').show();
                        return tooltip('暂无未到发票记录');
                    }else{
                        $('.no-more').hide();
                    }
                    makeResHtml(res);
                }
            });
        }
    function makeResHtml(data) {
            var html = '';
            for (i = 0; i < data.length; i++) {
                idx = data[i]['id'];
                html += '<div class="weui-cell__bd weui-cell_primary fhindex"  index="' + idx + '">' +
                    '<div class="weui-cells__title">' + data[i]['date'] + ' <span style="float: right;">' + data[i]['dh'] + '</span></div>' +
                    '<div class="weui-form-preview">' +
                    '<div class="weui-form-preview__bd">' +
                    '<div class="weui-form-preview__item">' +
                    '<label class="weui-form-preview__label">费用类型</label>' +
                    '<span class="weui-form-preview__value" style="text-align:left;">' + data[i]['sqlx'] + '</span>' +
                    '</div>' +
                    '<div class="weui-flex">' +
                    '<div class="weui-form-preview__item weui-flex__item">' +
                    '<label class="weui-form-preview__label">用款金额</label>' +
                    '<span class="weui-form-preview__value" style="text-align:left;">' + data[i]['money'] + '</span>' +
                    '</div>' +
                    '</div>' +
                    '<div class="weui-flex">' +
                    '<div class="weui-form-preview__item weui-flex__item">' +
                    '<label class="weui-form-preview__label">相关说明</label>' +
                    '<span class="weui-form-preview__value" style="text-align:left;">' + data[i]['text'] + '</span>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            }
           
            $('#order_searchResult').html(html);
            $('.fhindex').click(function () {
                feeid = $(this).attr('index');
                getContent(feeid);
                $('#other_page').hide();
                $('#btn-all').hide();
            });
        }
        if(params){
            getContent(params);
        }
        function getContent(params) {
            if (!params) return tooltip('请重新选择费用');
            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/FpsmApi')}",
                dataType: 'json',
                data: {
                    id: params,
                    system: "{$system}",
                    modname: 'Fpsm',
                    action: 'getContent',
                },
                dataType: 'json',
                success: function (res) {
                    makeHtml(res['content']);
                    makefjHtml(res['imgsrc']);
                }
            });
        }
        var viewer_conut = 0;
        function makefjHtml(data) {
            if (data.length > 0){ 
                 $('#fj').show();
            }else{
                return $('#fj').hide();
            }
            $html = '';
            for (k in data) {
               
                $html += '<img src="' + data[k] + '" class="fjys" data-original="' + data[k] + '" >';
            }
            $('#viewer').html($html);
            if(viewer_conut == 0){
                $('#viewer').viewer({
                    url: 'data-original',
                });
                viewer_conut++;
            }
            $('#viewer').viewer('update');
        }
        function makeHtml(data) {
            $html = '';
            for (k in data) {
                $html += '<p class="weui-media-box__desc weui-flex">' +
                    '<span>' + data[k].name + '</span>' +
                    '<span class="weui-flex__item" style="color:'+data[k].color+'">' + data[k].value + '</span>' +
                    '</p>';
            }
            $('#content_costmoney').html($html);
        }
        $('#submit').click(function () {
            var fylx = $('#sqlx').val(),
            file_names = $('#file_names').val();
            if (!file_names ) return tooltip('至少上传一张图片');

            str = $selectSign.eq(0).text();
            str = str.replace(/\s+/g, "");
            if (str == 0) return tooltip('请选择财务部签收人');
            var reason = $('#reason').val();
            ids = $("#sign_id").val() + ",",
                old_ids_arr = ids.split(","),

            toastfadeIn(200, '数据提交中');
            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/FpsmApi')}", //&system=yxhb&modname=CgfkApply&action=getCustomerList
                dataType: 'json',
                data: {
                    id: feeid,
                    sign: ids,
                    imagepath:file_names,
                    text: reason,
                    copyto_id: $("#copyto_id").val(),
                    system: "{$system}",
                    modname: 'Fpsm',
                    action: 'submit',
                    __hash__: hash
                },
                dataType: 'json',
                success: function (res) {
                    toast.fadeOut(200);
                    if (res.code == 200) {
                        window.location.href = "{$fixed['info']}" + "&aid=" + res.aid;
                    } else {
                        tooltip(res.msg);
                    }
                }
            });
        });

        // 获取URL参数
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return null;
        } 



        var sign_type = '',
            department_id = 0;
        $('#signModal').on('show.bs.modal', function (e) {
            var id = department_id;
            $("#sign_pre-level").attr("data-pid", department_id);
            getSignDepartment(department_id);
        });
        $('.open_sign_model').on('click', function () {
            department_id = $(this).attr('index');
            $('#signModal').modal('show');
        });

        function getSignDepartment(id) {
            $('#sign_searchResult').empty();
            $('#sign_searchResult').append(loading);
            $.post("{:U('Light/Apply/getDeptHtml')}",
                {
                    "id": id
                }, function (data) {
                    $('#sign_searchResult').empty();
                    if (data == '') {
                        $('#sign_searchResult').append(noresult);
                    } else {
                        $('#sign_searchResult').append(data);
                    }
                }
            );
        }
        // up pre-level
        $("#sign_pre-level").on("click", function () {
            $('#sign_searchResult').empty();
            $('#sign_searchResult').append(loading);
            var pid = $(this).attr("data-pid");
            // console.log(pid);
            getSignDepartment(department_id)
        });
        // select department
        $("#sign_searchResult").on("click", ".select-department", function () {
            var id = $(this).attr('data-id');
            var type = $(this).attr('data-type');
            sign_type = id;
            // console.log(id);
            getSignDepartment(id);
            $("#sign_pre-level").attr("data-pid", id);
        });
        // select department user
        $selectSign = $(".user_show");
        $("#sign_searchResult").on("click", ".select-user", function () {
            // var tmpl = '<li class="weui-uploader__file weui-selet__user" style="background-image:url(#url#)" id="#id#"></li>';
            var tmpl = '<li class="weui-uploader__file wk-select__user" id="#id#" style="height:90px;"><img src="#url#" class="weui-selet__user" style="margin-bottom: 0px;margin-right: 6px;margin-top:10px;" /><span style="margin-right: 6px;font-size: 14px;">#name#</span><span class="weui-badge" style="position: relative;top: -5.8em;right: -1.4em;">X</span></li>';
            var id = $(this).attr('data-id');
            var type = $(this).attr('data-type');
            var img = $(this).attr('data-img');
            var name = $(this).attr('data-name');
            var ids = $("#sign_id").val() + "," + id;
            // console.log(id);
            tmpl = tmpl.replace('#id#', id);
            tmpl = tmpl.replace('#name#', name);
            var index = 0;
            if (department_id == 5) index = 1;
            $selectSign.eq(index).html($(tmpl.replace('#url#', img)));
            $("#sign_id").val(ids);
            $('#signModal').modal('hide')
        });
        // delete copyto user
        $("#selectSign").on("click", ".wk-select__user", function () {
            $li_dom = $(this);
            $("#signDialog").fadeIn(200);
        });
        function sign_dialog_close() {
            $("#signDialog").fadeOut(100);
        }
        // Confirm dialog
        function sign_dialog_confirm() {
            var id = $li_dom.attr("id");
            var ids = $("#sign_id").val() + ",";
            var old_ids_arr = ids.split(",");
            var id_str = '';
            var location = $.inArray(id, old_ids_arr);
            if (location >= 0) {
                var repl_id = ',' + id;
                id_str = ids.replace(repl_id, ',');
            }
            $("#sign_id").val(id_str);
            $li_dom.remove();
            $("#signDialog").fadeOut(100);
        }




         // 触发上传机制
  function imgUpload(){
        $("#knowDialog").fadeIn(100);
    }

    // 内容提示(知道了)
    function dialog_iknow(){
        $("#knowDialog").fadeOut(100);
        filechooser.click();
    }

    // 图片压缩
    var imagepath='';
    var filechooser = document.getElementById("uploaderInput");

    // Close dialog
  //    用于压缩图片的canvas
  var canvas = document.createElement("canvas");
    var ctx = canvas.getContext('2d');
    //    瓦片canvas
    var tCanvas = document.createElement("canvas");
    var tctx = tCanvas.getContext("2d");
    var maxsize = 100 * 1024;
    var img_num = 0;
    var imgIndex = "",
        imgdom = "";
    $("#upload").on("click", function () {
        filechooser.click();
    }).on("touchstart", function () {
            $(this).addClass("touch")
        })
        .on("touchend", function () {
            $(this).removeClass("touch")
        });
    filechooser.onchange = function () {
        if (!this.files.length) return;
        var files = Array.prototype.slice.call(this.files);
        if (files.length > 20 || img_num > 19) {
            alert("最多只可上传9张图片");
            return;
        }
        files.forEach(function (file, i) {
            if (!/\/(?:jpeg|png|gif)/i.test(file.type)) return;
            var reader = new FileReader();
            var li = document.createElement("li");
            //          获取图片大小
            var size = file.size / 1024 > 1024 ? (~~(10 * file.size / 1024 / 1024)) / 10 + "MB" : ~~(file.size / 1024) + "KB";
            // li.innerHTML = '<div class="progress"><span></span></div><div class="size">' + size + '</div>';
            li.innerHTML = '<img class="weui-selet__user" style="margin-bottom: 0px;margin-right: 6px;margin-top:10px;"><div class="weui-uploader__file-content"></div><span class="weui-badge imgDel" style="position: relative;top: -4.8em;left: 2.5em;">X</span>';
            $(li).addClass("weui-uploader__file  weui-uploader__file_status");
            $("#uploaderFiles").append($(li));
            reader.onload = function () {
                var result = this.result;
                var img = new Image();
                img.src = result;
                //如果图片大小小于100kb，则直接上传
                if (result.length <= maxsize) {
                    img = null;
                    // TODO：这里没有做图片旋转，小于100K可能会有问题
                    upload(result, file.type, $(li), i);
                    return;
                }
                //      图片加载完毕之后进行压缩，然后上传
                if (img.complete) {
                    callback();
                } else {
                    img.onload = callback;
                }

                function callback() {
                    //获取照片方向角属性，用户旋转控制  
                    EXIF.getData(file, function () {
                        Orientation = EXIF.getTag(this, 'Orientation');
                        // alert(Orientation);
                        var data = compress(img, Orientation);
                        upload(data, file.type, $(li), i);
                        img = null;
                    });
                }
            };
            reader.readAsDataURL(file);
        })
    };
    //对图片旋转处理 added by lzk  
    function rotateImg(img, direction, canvas) {
        // alert(img);  
        //最小与最大旋转方向，图片旋转4次后回到原方向    
        var min_step = 0;
        var max_step = 3;
        //var img = document.getElementById(pid);    
        if (img == null) return;
        //img的高度和宽度不能在img元素隐藏后获取，否则会出错    
        var height = img.height;
        var width = img.width;
        //var step = img.getAttribute('step');    
        var step = 2;
        if (step == null) {
            step = min_step;
        }
        if (direction == 'right') {
            step++;
            //旋转到原位置，即超过最大值    
            step > max_step && (step = min_step);
        } else {
            step--;
            step < min_step && (step = max_step);
        }
    
        //旋转角度以弧度值为参数    
        var degree = step * 90 * Math.PI / 180;
        // var ctx = canvas.getContext('2d');
        // console.log(step);
        switch (step) {
            case 0:
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0);
                break;
            case 1:
                canvas.width = height;
                canvas.height = width;
                ctx.rotate(degree);
                ctx.drawImage(img, 0, -height);
                break;
            case 2:
                canvas.width = width;
                canvas.height = height;
                ctx.rotate(degree);
                ctx.drawImage(img, -width, -height);
                break;
            case 3:
                canvas.width = height;
                canvas.height = width;
                ctx.rotate(degree);
                ctx.drawImage(img, -width, 0);
                break;
        }
    }
    //    使用canvas对大图片进行压缩
    function compress(img, Orientation) {
        var initSize = img.src.length;
        var width = img.width;
        var height = img.height;
        //如果图片大于四百万像素，计算压缩比并将大小压至400万以下
        var ratio;
        if ((ratio = width * height / 4000000) > 1) {
            ratio = Math.sqrt(ratio);
            width /= ratio;
            height /= ratio;
        } else {
            ratio = 1;
        }
        canvas.width = width;
        canvas.height = height;
        //        铺底色
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        //如果图片像素大于100万则使用瓦片绘制
        var count;
        if ((count = width * height / 1000000) > 1) {
            count = ~~(Math.sqrt(count) + 1); //计算要分成多少块瓦片
            //            计算每块瓦片的宽和高
            var nw = ~~(width / count);
            var nh = ~~(height / count);
            tCanvas.width = nw;
            tCanvas.height = nh;
            for (var i = 0; i < count; i++) {
                for (var j = 0; j < count; j++) {
                    tctx.drawImage(img, i * nw * ratio, j * nh * ratio, nw * ratio, nh * ratio, 0, 0, nw, nh);
                    ctx.drawImage(tCanvas, i * nw, j * nh, nw, nh);
                }
            }
        } else {
            ctx.drawImage(img, 0, 0, width, height);
        }

        // console.log(Orientation);

        if (navigator.userAgent.match(/iphone/i)) {
            console.log('iphone');
            //alert(expectWidth + ',' + expectHeight);  
            //如果方向角不为1，都需要进行旋转 added by lzk  
            if (Orientation != "" && Orientation != 1) {
                console.log('旋转处理');
                switch (Orientation) {
                    case 6://需要顺时针（向左）90度旋转  
                        console.log('需要顺时针（向左）90度旋转');
                        rotateImg(img, 'left', canvas);
                        break;
                    case 8://需要逆时针（向右）90度旋转  
                        console.log('需要顺时针（向右）90度旋转');
                        rotateImg(img, 'right', canvas);
                        break;
                    case 3://需要180度旋转  
                        console.log('需要180度旋转');
                        rotateImg(img, 'right', canvas);//转两次  
                        rotateImg(img, 'right', canvas);
                        break;
                }
            }
        } else {
            //alert(Orientation);  
            if (Orientation != "" && Orientation != 1) {
                //alert('旋转处理');  
                switch (Orientation) {
                    case 6://需要顺时针（向左）90度旋转  
                        console.log('需要顺时针（向左）90度旋转');
                        rotateImg(img, 'left', canvas);
                        break;
                    case 8://需要逆时针（向右）90度旋转  
                        console.log('需要顺时针（向右）90度旋转');
                        rotateImg(img, 'right', canvas);
                        break;
                    case 3://需要180度旋转  
                        console.log('需要180度旋转');
                        rotateImg(img, 'right', canvas);//转两次  
                        rotateImg(img, 'right', canvas);
                        break;
                }
            }

        }

        var srcStr = img.src;
        var img_header = srcStr.substring(0,23);
        // console.log(img_header);
        var indexSearch = img_header.indexOf('png');
        console.log(indexSearch);
        //进行最小压缩
        if(indexSearch<=0){
            var ndata = canvas.toDataURL('image/jpeg', 0.4);
        }
        else if (indexSearch>0){
            var ndata = canvas.toDataURL('image/jpeg', 0.4);//'image/png'
        }
        // console.log('压缩前：' + initSize);
        // console.log('压缩后：' + ndata.length);
        // console.log('压缩率：' + ~~(100 * (initSize - ndata.length) / initSize) + "%");
        tCanvas.width = tCanvas.height = canvas.width = canvas.height = 0;
        return ndata;
    }
    //    图片上传，将base64的图片转成二进制对象，塞进formdata上传
    function upload(basestr, file, $li, i) {
        var text = window.atob(basestr.split(",")[1]);
        // var buffer = new Uint8Array(text.length);
        var pecent = 0,
            loop = null;
        // for (var i = 0; i < text.length; i++) {
        //     buffer[i] = text.charCodeAt(i);
        // }
        // var blob = getBlob([buffer], type);
        var xhr = new XMLHttpRequest();
        var formdata = getFormData();
        // console.log(blob);
        // formdata.append('imagefile', blob);
        formdata.append('imagefile', basestr);
        formdata.append('system', "{$system}");
        formdata.append('modname', "CostMoney");
        formdata.append('action', "fjsc");
        u = "{:U('Light/Api/CostMoneyApi')}";
        xhr.open('post', u);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var jsonData = JSON.parse(xhr.responseText);
               
                var imagedata = jsonData[0] || {};
                var text = imagedata.path ? '上传成功' : '上传失败';
                imagepath = imagedata.output_file;
                
                clearInterval(loop);
                //当收到该消息时上传完毕
                // $li.find(".weui-uploader__file-content").animate({ 'width': "100%" }, pecent < 95 ? 200 : 0, function() {
                //     $(this).html(text);
                // });
                $li.find(".weui-uploader__file-content").html("");
                $li.find(".weui-uploader__file-content").parent().removeClass("weui-uploader__file_status");
                $li.find('img').attr('data-original','https://www.fjyuanxin.com/sngl/upload/fy/'+imagepath);
                $li.find('img').attr('src','https://www.fjyuanxin.com/sngl/upload/fy/'+imagepath);
                createViewr();
                img_num++;
                $("#upload_nums").text(img_num);
                var file_names = $("#file_names").val() + imagedata.output_file + "|";
                $("#file_names").val(file_names);
                
                
                if (!imagedata.path) return;
                // $(".pic-list").append('<a href="' + imagedata.path + '">' + imagedata.name + '（' + imagedata.size + '）<img src="' + imagedata.path + '" /></a>');
            }
        };
        //数据发送进度，前50%展示该进度
        xhr.upload.addEventListener('progress', function (e) {
            if (loop) return;
            pecent = ~~(100 * e.loaded / e.total) / 2;
            // $li.find(".weui-uploader__file-content").css('width', pecent + "%");
            $li.find(".weui-uploader__file-content").html(pecent + "%");
            if (pecent == 50) {
                mockProgress();
            }
        }, false);
        //数据后50%用模拟进度
        function mockProgress() {
            if (loop) return;
            loop = setInterval(function () {
                pecent++;
                // $li.find(".weui-uploader__file-content").css('width', pecent + "%");
                $li.find(".weui-uploader__file-content").html(pecent + "%");
                console.log(pecent);
                if (pecent == 99) {
                    clearInterval(loop);
                }
            }, 100)
        }
        xhr.send(formdata);

        $(".weui-uploader__file").on('click',function(){
            imgIndex = $(this).index();
            imgdom = $(this);
            // console.log(imgIndex);
        })

        $(".imgDel").on('click',function(){
            // 是否删除该图
            $("#iosDialog_imgDel").fadeIn(100);
        })

    }
  
    
    // 取消图片删除
    function dialog_close_imgdelete(){
        $("#iosDialog_imgDel").fadeOut(100);
    }
    // 确认图片删除
    function dialog_confirm_imgdelete(){
        imgdom.remove();
        var file_names_str = $("#file_names").val();
        var file_names_arr = file_names_str.split("|");
        file_names_arr.splice(imgIndex, 1);
        var file_str_1 = file_names_arr.toString();
        var file_str_2=file_str_1.replace(/,/g,"|");
        // console.log(file_str_2);
        $("#file_names").val(file_str_2);
        $("#iosDialog_imgDel").fadeOut(100);
    }

    /**
     * 获取blob对象的兼容性写法
     * @param buffer
     * @param format
     * @returns {*}
     */
    function getBlob(buffer, format) {
        try {
            return new Blob(buffer, { type: format });
        } catch (e) {
            var bb = new (window.BlobBuilder || window.WebKitBlobBuilder || window.MSBlobBuilder);
            buffer.forEach(function (buf) {
                bb.append(buf);
            });
            return bb.getBlob(format);
        }
    }
    /**
     * 获取formdata
     */
    function getFormData() {
        var isNeedShim = ~navigator.userAgent.indexOf('Android') &&
            ~navigator.vendor.indexOf('Google') &&
            !~navigator.userAgent.indexOf('Chrome') &&
            navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop() <= 534;
        return isNeedShim ? new FormDataShim() : new FormData()
    }
    /**
     * formdata 补丁, 给不支持formdata上传blob的android机打补丁
     * @constructor
     */
    function FormDataShim() {
        console.warn('using formdata shim');
        var o = this,
            parts = [],
            boundary = Array(21).join('-') + (+new Date() * (1e16 * Math.random())).toString(36),
            oldSend = XMLHttpRequest.prototype.send;
        this.append = function (name, value, filename) {
            parts.push('--' + boundary + '\r\nContent-Disposition: form-data; name="' + name + '"');
            if (value instanceof Blob) {
                parts.push('; filename="' + (filename || 'blob') + '"\r\nContent-Type: ' + value.type + '\r\n\r\n');
                parts.push(value);
            } else {
                parts.push('\r\n\r\n' + value);
            }
            parts.push('\r\n');
        };
        // Override XHR send()
        XMLHttpRequest.prototype.send = function (val) {
            var fr,
                data,
                oXHR = this;
            if (val === o) {
                // Append the final boundary string
                parts.push('--' + boundary + '--\r\n');
                // Create the blob
                data = getBlob(parts);
                // Set up and read the blob into an array to be sent
                fr = new FileReader();
                fr.onload = function () {
                    oldSend.call(oXHR, fr.result);
                };
                fr.onerror = function (err) {
                    throw err;
                };
                fr.readAsArrayBuffer(data);
                // Set the multipart content type and boudary
                this.setRequestHeader('Content-Type', 'multipart/form-data; boundary=' + boundary);
                XMLHttpRequest.prototype.send = oldSend;
            } else {
                oldSend.call(this, val);
            }
        };
    }
    </script>
</block>
<block name="other">
        <div class="modal fade" id="signModal" tabindex="-1" role="dialog" aria-labelledby="signModalLabel" aria-hidden="true" width="100%">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only sign_close">Close</span>
                        </button>
                        <h4 class="modal-title" id="signModalLabel">选择人员</h4>
                    </div>
                    <div class="modal-body" id="select_sign_content" style="padding-top: 0px;padding-bottom: 0px;">
                        <div class="page js_show" style="position: relative;">
                            <div class="page__bd">
                                <div class="weui-cells searchbar-result" id="sign_searchResult" style="margin-top: 0px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default sing_to_close" data-dismiss="modal">关闭</button>
                        <!-- <button type="button" class="btn btn-success" id="sign_pre-level" data-pid="">上一级</button> -->
                    </div>
                </div>
            </div>
        </div>
        <div id="sign_dialogs">
            <div class="js_dialog" id="signDialog" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__hd">
                        <strong class="weui-dialog__title">是否删除签收人</strong>
                    </div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="sign_dialog_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                        <a href="javascript:;" onclick="sign_dialog_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                    </div>
                </div>
            </div>
        </div>
    </block>