<extend name="Apply:applyBase" />
<!-- 去除不可选择日期 -->
<block name="disable_date"></block>
<!-- 去除不可选择日期 end-->
<block name="content_body">
    <input type="hidden" id="ratio" value="ratio">
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd">
                <label class="weui-label">生产品种&nbsp;&nbsp;

                </label>
            </div>
            <div class="weui-cell__bd">
                <select class="weui-select greyColor" disabled name="type" id='type'>
                    <option value='-1' disabled selected style='display:none;'>自动填写</option>
                    <option value="F75">F75</option>
                    <option value="F85">F85</option>
                    <option value="S95">S95</option>
                    <option value="试验品种">试验品种</option>
                </select>
            </div>
        </div>
        <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd">
                <label class="weui-label">
                    <span class="font-width">生产线</span>&nbsp;&nbsp;

                </label>
            </div>
            <div class="weui-cell__bd">
                <select class="weui-select greyColor" disabled name="type" id='scx'> 
                    <option value='-1' disabled selected style='display:none;'>自动填写</option>
                    <option value="A#">A#生产线</option>
                    <option value="B#">B#生产线</option>
                </select>
            </div>
        </div>
        <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd">
                <label class="weui-label">
                    <span class="font-width">入库号</span>&nbsp;&nbsp;

                </label>
            </div>
            <div class="weui-cell__bd">
                <select class="weui-select greyColor" disabled name="type" id='kh'> 
                    <option value='-1' disabled selected style='display:none;'>自动填写</option>
                    <option value='1#'>1#</option>
                    <option value='2#'>2#</option>
                    <option value='3#'>3#</option>
                    <option value='4#'>4#</option>
                    <option value='5#'>5#</option>
                    <option value='6#'>6#</option>
                </select>
            </div>
        </div>
    </div>

    <div class="weui-cells weui-cells_form">
        <div class="weui-cell weui-cell_select weui-cell_select-after ">
            <div class="weui-cell__hd">
                <label class="weui-label">
                    <span class="font-width">45μm</span>&nbsp;&nbsp;
                    
                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-select peibi scale" id='xd' type="number" index="45μm" maxlength="15" name="custodian" 
                    placeholder="0-20">
            </div>
        </div>
        <div class="weui-cell weui-cell_select weui-cell_select-after ">
            <div class="weui-cell__hd">
                <label class="weui-label">
                    <span class="font-width">比表</span>&nbsp;&nbsp;
                    <span style='color:red;'>*</span>
                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-select peibi scale" id='bb' type="number" index="比表" maxlength="15" name="custodian"
                    placeholder="300-600">
            </div>
        </div>
        <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd">
                <label class="weui-label">水份记录&nbsp;&nbsp;

                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-select " type="text" readonly id="select_sf" style="color: #337ab7;" value="点击添加水份" />
            </div>
        </div>
        <div class="weui-cell ">
            <div class="weui-cell__hd">
                <label class="weui-label">
                    <span class="font-width">水份详情</span>&nbsp;&nbsp;
                </label>
            </div>
            <div class="weui-cell__hd">
                <div id="ycl_content">

                </div>
                <div id="param_div">
                    <span class="greyColor">自动填写</span>
                </div>
            </div>
        </div>

    </div>
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
            <div class="weui-cell__hd">
                <label class="weui-label">相关说明&nbsp;&nbsp;
                </label>
            </div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__bd" id="cnt">
                <textarea class="weui-textarea" name="reason" id="reason" placeholder="请输入相关说明；"
                    rows="3"></textarea>
                <div class="weui-textarea-counter">
                    <span id="reason_char">0</span>/200</div>
            </div>
        </div>
    </div>
    <div class="other_page" id="other_page" style="display: none;">
        <div class="container">
            <div class="page js_show">
                <h3 class="titleTab" style="text-align: center">原料配比</h3>
                <div class="weui-cells__title">磨内(单位:%)</div>
                <div class="weui-cells weui-cells_form">
                    <div class="weui-cell weui-cell_select weui-cell_select-after ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="">宝钢水渣</span>&nbsp;&nbsp;

                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select peibi scale" type="number" index="宝钢水渣" maxlength="15" name="custodian"
                                id="scale1" placeholder="0-100%">
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="font-width">矿渣</span>&nbsp;&nbsp;

                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select peibi scale" type="number" index="矿渣" maxlength="15" name="custodian"
                                id="scale2" placeholder="0-100%">
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="">矿热炉渣</span>&nbsp;&nbsp;

                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select peibi scale" type="number" index="矿热炉渣" maxlength="15" name="custodian"
                                id="scale3" placeholder="0-100%">
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="">电厂炉渣</span>&nbsp;&nbsp;

                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select peibi scale" type="number" index="电厂炉渣" maxlength="15" name="custodian"
                                id="scale4" placeholder="0-100%">
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="">精炼炉渣</span>&nbsp;&nbsp;

                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select peibi scale" type="number" index="精炼炉渣" maxlength="15" name="custodian"
                                id="scale5" placeholder="0-100%">
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="font-width">石灰石</span>&nbsp;&nbsp;

                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select peibi scale" type="number" index="石灰石" maxlength="15" name="custodian"
                                id="scale6" placeholder="0-100%">
                        </div>
                    </div>
                </div>
                <div class="weui-cells__title">成品(单位:%)</div>
                <div class="weui-cells weui-cells_form">
                    <div class="weui-cell weui-cell_select weui-cell_select-after ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="font-width">成品</span>&nbsp;&nbsp;
                                 
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select peibi scale out_scale" type="number" index="成品" maxlength="15" name="custodian" id="out_scale" placeholder="0-1">
                        </div>
                    </div>
                </div>

                <div class="button-sp-area" style="margin-bottom: 20px;display: flex;flex-direction: row;width: 100%;justify-content: space-around;align-items: baseline;">
                    <a href="javascript:;" id="ratio-refuse" class="weui-btn weui-btn_warn" style="width: 40%;">取消</a>
                    <a href="javascript:;" id="ratio-agree" class="weui-btn weui-btn_primary" style="width: 40%">确定</a>
                </div>
            </div>
        </div>
    </div>
</block>
</block>
<block name="Process">
    <div class="weui-cells__title">签收人员选择 <span style="color: #f12e2e">（各部门须选择1人签收）</span>
        
    </div>
    <div class="weui-cells" style="margin-top:0px;">
        <div class="weui-cell" style="padding-top: 0px;padding-bottom: 5px;margin-bottom: 10px;">
            <div class="weui-cell__bd">
                <div class="weui-uploader">
                    <div class="weui-uploader__bd">
                        <ul class="weui-uploader__files" id="selectSign" style="margin-bottom: 0px;">
                            <li class="weui-uploader__file" style="min-height:80px;" >
                                <div class="user_show">

                                </div>
                                <div class="box_div">
                                    <div class="weui-uploader__input-box" style="width: 2.5em;height: 2.5em;margin-right: 0px;margin-bottom: 0px;margin-top:10px;">
                                            <input id="signInput" class="weui-uploader__input open_sign_model" index="9" type="button" name="sign" readonly />
                                            <!--data-toggle="modal" data-target="#myModal" -->
                                            
                                        </div>
                                    <span style="margin-right: 6px;font-size: 14px;">生产部</span>
                                </div>
                            </li>
                        </ul>
                        <input type="hidden" name="sign_id" id="sign_id" value="">
                    </div>
                </div>
            </div>
        </div>
    </div>

</block>
<block name="other">
    <div class="modal fade" id="signModal" tabindex="-1" role="dialog" aria-labelledby="signModalLabel" aria-hidden="true" width="100%">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only sign_close">Close</span>
                    </button>
                    <h4 class="modal-title" id="signModalLabel">选择人员</h4>
                </div>
                <div class="modal-body" id="select_sign_content" style="padding-top: 0px;padding-bottom: 0px;">
                    <div class="page js_show" style="position: relative;">
                        <div class="page__bd">
                            <!-- <div class="weui-search-bar" id="sign_searchBar">
                                <form class="weui-search-bar__form">
                                    <div class="weui-search-bar__box">
                                        <i class="weui-icon-search"></i>
                                        <input type="search" class="weui-search-bar__input" id="sign_searchInput" placeholder="请输入姓名或拼音缩写搜索" required="">
                                        <a href="javascript:" class="weui-icon-clear" id="sign_searchClear"></a>
                                    </div>
                                    <label class="weui-search-bar__label" id="sign_searchText">
                                        <i class="weui-icon-search"></i>
                                        <span>请输入姓名或拼音缩写搜索</span>
                                    </label>
                                </form>
                                <a href="javascript:" class="weui-search-bar__cancel-btn" id="sign_searchCancel">搜索</a>
                            </div> -->
                            <div class="weui-cells searchbar-result" id="sign_searchResult" style="margin-top: 0px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default sing_to_close" data-dismiss="modal">关闭</button>
                    <!-- <button type="button" class="btn btn-success" id="sign_pre-level" data-pid="">上一级</button> -->
                </div>
            </div>
        </div>
    </div>
    <div id="sign_dialogs">
        <div class="js_dialog" id="signDialog" style="display: none;">
            <div class="weui-mask"></div>
            <div class="weui-dialog">
                <div class="weui-dialog__hd">
                    <strong class="weui-dialog__title">是否删除签收人</strong>
                </div>
                <div class="weui-dialog__ft">
                    <a href="javascript:;" onclick="sign_dialog_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                    <a href="javascript:;" onclick="sign_dialog_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                </div>
            </div>
        </div>
    </div>
</block>
<block name="js">
    <script>
        var label = "生产时间&nbsp;&nbsp;<span style='color:red;'>*</span>",
            datePicker = $('#showDatePicker'),
            the_date = datePicker.val(),
            this_time = new Date(the_date),
            scale1 = $('#scale1'),
            scale2 = $('#scale2'),
            scale3 = $('#scale3'),
            scale4 = $('#scale4'),
            scale5 = $('#scale5'),
            scale6 = $('#scale6'),
            scale_array = [],
            out_scale_array = [],
            xd     = $('#xd'),
            bb     = $('#bb'),
            H = H > 9 ? H : '0' + H;
        var arr_week = new Array("星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六");
        now = this_time.getFullYear() + '-' + ((this_time.getMonth() + 1) > 9 ? (this_time.getMonth() + 1) : '0' + (this_time.getMonth() + 1)) + '-' + (this_time.getDate() > 9 ? this_time.getDate() : '0' + this_time.getDate()) + ' ' + H + ':00';
        
        // 日期插件
        $params_time = getQueryString('datetime');
        if($params_time){
            datePicker.val(the_date+' '+getNowDateTime()+":30");
        }else{
            datePicker.val(null);
        }
       // 
       
        getProductInfo(the_date+' '+getNowDateTime()+":30")
        datePicker.attr('placeholder', '上一班至当前班');
        $('.weui-label').eq(1).html(label);

        $('.greyColor').change(function () {
            $(this).removeClass('greyColor');
        })

        function ratioTime() {
            // 日期选择
            var hours = [],
                minites = [{ label: '30', value: 30 }],
                symbol = [];

            for (var i = 0; i < 24; i++) {
                var hours_item = {};
                hours_item.label = ('' + i).length === 1 ? '0' + i : '' + i;
                hours_item.value = i;
                hours.push(hours_item);
            }
            var limit = getNowDateTime()<8 ?2:1;
            for (var i = 0; i < limit; i++) {
                $date = new Date();
                var temp = i;
                if(limit == 2){
                    temp  = i-1;
                } 
                $date = $date.setDate($date.getDate() + temp);
                $date = new Date($date);

                var Y = $date.getFullYear(),
                    M = $date.getMonth() + 1,
                    D = $date.getDate();

                M = M > 9 ? M : '0' + M;
                D = D > 9 ? D : '0' + D;

                var symbol_item = {};
                symbol_item.label = Y + '-' + M + '-' + D + ' ' + arr_week[$date.getDay()];
                if (the_date ==  Y + '-' + M + '-' + D) {
                    symbol_item.label = '今天';
                }
                symbol_item.value = Y + '-' + M + '-' + D;
                symbol.push(symbol_item);
            }

            weui.picker(symbol, hours, minites, {
                defaultValue: [the_date, $date.getHours() + 1, 0],
                onConfirm: function (result) {
                    pickerValue(result);
                }
            });
        }

        function getfazhi() {
            var fazhi = 1;
            F85.forEach(function (item) {
                if (!item[3] && $('#type').val() == 'F85') {
                    fazhi = 0;
                    return tooltip(item[0] + '的阀值为' + item[1] + '-' + item[2] + '%');
                }
            });
            return fazhi;
        }
        // 日历填充
        function pickerValue(dateArr) {
            var val = dateArr[0] + ' ';

            val += dateArr[1] > 9 ? dateArr[1] : '0' + dateArr[1];
            val += ':';
            val += dateArr[2];
            // 当前的时间戳 
            var hours = getNowDateTime();
            if(hours <8 ) hours = 8;
            else if(hours < 16 ) hours = 16;
            else hours = 24;
            
            timestampnow = new Date(the_date+' '+hours+":00").getTime();
            // 16小时前的时间戳
            timestampsix = timestampnow-3600000*16;
            // 选择时间的时间戳
            timestampsel = new Date(val).getTime();
          
            if( timestampsel> timestampnow || timestampsel< timestampsix){
                return tooltip('生产时间为当前班8小时和上一班8小时'); 
            }
            $('#showDatePicker').val(val);
            getProductInfo(val)
        }
        //获取下方信息
        function getProductInfo(datetime){
            if(!datetime) return false;
            toast.fadeIn(200);
            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/kfScjlApi')}", //&system=yxhb&modname=CgfkApply&action=getCustomerList
                dataType: 'json',
                data: {
                    time: datetime,
                    system: "{$system}",
                    modname: 'kfScjl',
                    action: 'getProductInfo',
                    __hash__: hash
                },
                dataType: 'json',
                success: function (res) {
                    toast.fadeOut(200);
                    $('#type').val(res['product']);
                    $('#scx').val(res['scx']);
                    $('#kh').val(res['ku']);
                }
            });
        }
        // 时间判断
        function getNowDateTime(){
            var datetime = new Date(),
                hours    = datetime.getHours(),
                minites  = datetime.getMinutes(),
                res      = '';
            
            hours = minites >= 30 ? hours : (hours-1);
            if(hours < 0) hours = "00";
            return hours;
        }
        // 页面显示
        $('#select_sf').click(function(){
            $('#other_page').fadeIn(200);
        });

        $('#ratio-refuse').click(function(){
            $('#other_page').fadeOut(200);
        });
        $('.scale').change(function(){
            var value = $(this).val(),
                idx  = $(this).attr('index');
              
                F85.forEach(function(item,key){
                    if(item[0] == idx){
                        if(value<item[1] || value >item[2]){
                            F85[key][3] = 0;
                            return tooltip(idx+'的阀值为'+item[1]+'-'+item[2]+'%'); 
                        } else{
                            F85[key][3] = 1;
                        }
                    }
                });
        });
        // 阀值检测
        var F85 = [
            ['宝钢水渣',0,100,1],
            ['矿渣',0,100,1],
            ['矿热炉渣',0,100,1],
            ['电厂炉渣',0,100,1],
            ['精炼炉渣',0,100,1],
            ['石灰石'  ,0,100,1],
            ['成品'  ,0,1,1],
            
        ];
        function getfazhi(){
            var fazhi=1;
            F85.forEach(function(item){
                if(!item[3] ) {
                    fazhi=0;
                    return tooltip(item[0]+'的阀值为'+item[1]+'-'+item[2]+'%');
                }
            });
            return fazhi;
        }
        // 确定按钮
        $('#ratio-agree').click(function () {
           if(!getfazhi()) return false;
           var scale_1 = scale1.val(),
               scale_2 = scale2.val(),
               scale_3 = scale3.val(),
               scale_4 = scale4.val(),
               scale_5 = scale5.val(),
               scale_6 = scale6.val();
               out_scale  = $('#out_scale').val();
           if (!scale_1 && !scale_2 && !scale_3 && !scale_4 && !scale_5 && !scale_6) return tooltip('请选择至少一种物料');
           scale_array = [];
           scale_array[0] = { 'name': scale_1 ? scale_1 : null, 'value': scale1.attr('index') };
           scale_array[1] = { 'name': scale_2 ? scale_2 : null, 'value': scale2.attr('index') };
           scale_array[2] = { 'name': scale_3 ? scale_3 : null, 'value': scale3.attr('index') };
           scale_array[3] = { 'name': scale_4 ? scale_4 : null, 'value': scale4.attr('index') };
           scale_array[4] = { 'name': scale_5 ? scale_5 : null, 'value': scale5.attr('index') };
           scale_array[5] = { 'name': scale_6 ? scale_6 : null, 'value': scale6.attr('index') };
           out_scale_array[0] = { 'name': out_scale ? out_scale : null, 'value': $('#out_scale').attr('index') };
           show_wl();
           $('#other_page').fadeOut(200);
       });
        // 水份添加的显示
        function show_wl() {
            $('#ycl_content').empty();
            var html = '<div style="padding: 3px 0 0 0;border-bottom: 1px solid #e5e5e5; "><strong >磨内</strong></div>';
            for (i = 0; i < scale_array.length; i++) {
                if (scale_array[i].name == null) continue;
                html += '<div style="padding: 3px 0 0 10px;"><span class="" >' + scale_array[i].value + '</span>：' + scale_array[i].name + '%</div>';
            }
            for (i = 0; i < out_scale_array.length; i++) {
                if (out_scale_array[i].name == null) continue;
                if(i == 0)html += '<div style="padding: 3px 0 0 0;border-bottom: 1px solid #e5e5e5; "><strong>成品</strong></div>';
                html += '<div style="padding: 3px 0 0 10px;"><span class="" >' + out_scale_array[i].value + '</span>：' + out_scale_array[i].name + '</div>';
            }
            $('#param_div').remove();
            $('#ycl_content').html(html);
        }

        // 细度变化
        xd.change(function(){
            var value = $(this).val();
            if(value > 20 || value < 0){
                return tooltip('细度范围为0-20');
            }
        });
        // 比表变化
        bb.change(function(){
            var value = $(this).val();
            if(value > 600 || value < 300){
                return tooltip('细度范围为300-600');
            }
        });
        // 提交
        $('#submit').click(function(){
            // 时间选定
            if(!datePicker.val()) return tooltip('请选择生产日期');
            // 细度检测
            var xdVal = xd.val(),
                bbVal = bb.val();
            if(xdVal){
                if(xdVal > 20 || xdVal < 0) return tooltip('细度范围为0-20');
            } 
            if(bbVal > 600 || bbVal < 300)  return tooltip('比表范围为300-600');
            var reason = $('#reason').val(),
                ids = $("#sign_id").val() + ",",
                old_ids_arr = ids.split(","),
                flag = 1;
            for (let i = 0; i < old_ids_arr.length; i++) {
                if (old_ids_arr[i] != '') flag = 0;
            }
            if (flag) return tooltip('请选择签收人');

            str = $selectSign.eq(0).text();
            str = str.replace(/\s+/g,"");
            if (str == 0) return tooltip('请选择生产部签收人');

            // 提交数据
            toast.fadeIn(200);
            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/kfScjlApi')}",
                dataType: 'json',
                data: {
                    sign: ids,
                    scale: scale_array,
                    type: $('#type').val(),
                    scx: $('#scx').val(),
                    kh: $('#kh').val(),
                    out_scale:out_scale_array,
                    xd:xdVal,
                    bb:bbVal,
                    text: reason,
                    datetime: datePicker.val(),
                    copyto_id: $("#copyto_id").val(),
                    system: "{$system}",
                    modname: 'kfScjl',
                    action: 'check_is_set',
                    __hash__: hash
                },
                dataType: 'json',
                success: function (res) {
                    toast.fadeOut(200);
                    if (res.code == 200) {
                        submit();
                    } else {
                        tooltip(res.msg);
                    }
                }
            });
        });
        function submit(){
            var xdVal = xd.val(),
                bbVal = bb.val(),
                reason = $('#reason').val(),
                ids = $("#sign_id").val();
            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/kfScjlApi')}",
                dataType: 'json',
                data: {
                    sign: ids,
                    scale: scale_array,
                    type: $('#type').val(),
                    scx: $('#scx').val(),
                    kh: $('#kh').val(),
                    out_scale:out_scale_array,
                    xd:xdVal,
                    bb:bbVal,
                    text: reason,
                    datetime: datePicker.val(),
                    copyto_id: $("#copyto_id").val(),
                    system: "{$system}",
                    modname: 'kfScjl',
                    action: 'submit',
                    __hash__: hash
                },
                dataType: 'json',
                success: function (res) {
                    toast.fadeOut(200);
                    if (res.code == 200) {
                        window.location.href = "{$fixed['info']}" + "&aid=" + res.aid;
                    } else {
                        tooltip(res.msg);
                    }
                }
            });
        }
         var sign_type = '',
            department_id = 0;
        $('#signModal').on('show.bs.modal', function (e) {
            var id = department_id;
            $("#sign_pre-level").attr("data-pid", department_id);
            getSignDepartment(department_id);
        });
        $('.open_sign_model').on('click', function () {
            department_id = $(this).attr('index');
            $('#signModal').modal('show');
        });

        function getSignDepartment(id) {
            $('#sign_searchResult').empty();
            $('#sign_searchResult').append(loading);
            $.post("{:U('Light/Apply/getDeptHtml')}",
                {
                    "id": id
                }, function (data) {
                    $('#sign_searchResult').empty();
                    if (data == '') {
                        $('#sign_searchResult').append(noresult);
                    } else {
                        $('#sign_searchResult').append(data);
                    }
                }
            );
        }
        // up pre-level
        $("#sign_pre-level").on("click", function () {
            $('#sign_searchResult').empty();
            $('#sign_searchResult').append(loading);
            var pid = $(this).attr("data-pid");
            // console.log(pid);
            getSignDepartment(department_id)
        });
        // select department
        $("#sign_searchResult").on("click", ".select-department", function () {
            var id = $(this).attr('data-id');
            var type = $(this).attr('data-type');
            sign_type = id;
            // console.log(id);
            getSignDepartment(id);
            $("#sign_pre-level").attr("data-pid", id);
        });
        // select department user
        $selectSign = $(".user_show");
        $("#sign_searchResult").on("click", ".select-user", function () {
            // var tmpl = '<li class="weui-uploader__file weui-selet__user" style="background-image:url(#url#)" id="#id#"></li>';
            var tmpl = '<li class="weui-uploader__file wk-select__user" id="#id#" style="height:90px;"><img src="#url#" class="weui-selet__user" style="margin-bottom: 0px;margin-right: 6px;margin-top:10px;" /><span style="margin-right: 6px;font-size: 14px;">#name#</span><span class="weui-badge" style="position: relative;top: -5.8em;right: -1.4em;">X</span></li>';
            var id = $(this).attr('data-id');
            var type = $(this).attr('data-type');
            var img = $(this).attr('data-img');
            var name = $(this).attr('data-name');
            var ids = $("#sign_id").val() + "," + id;
            // console.log(id);
            tmpl = tmpl.replace('#id#', id);
            tmpl = tmpl.replace('#name#', name);
            var index = 0;
            if(department_id == 10) index = 1;
            $selectSign.eq(index).html($(tmpl.replace('#url#', img)));
            $("#sign_id").val(ids);
            $('#signModal').modal('hide')
        });
        // delete copyto user
        $("#selectSign").on("click", ".wk-select__user", function () {
            $li_dom = $(this);
            $("#signDialog").fadeIn(200);
        });
        function sign_dialog_close() {
            $("#signDialog").fadeOut(100);
        }
        // Confirm dialog
        function sign_dialog_confirm() {
            var id = $li_dom.attr("id");
            var ids = $("#sign_id").val() + ",";
            var old_ids_arr = ids.split(",");
            var id_str = '';
            var location = $.inArray(id, old_ids_arr);
            if (location >= 0) {
                var repl_id = ',' + id;
                id_str = ids.replace(repl_id, ',');
            }
            $("#sign_id").val(id_str);
            $li_dom.remove();
            $("#signDialog").fadeOut(100);
        }
    </script>
</block>