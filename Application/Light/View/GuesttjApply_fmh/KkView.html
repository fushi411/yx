<extend name="Apply:applyBase" />

<!-- 去除不可选择日期 -->

<block name="disable_date"></block>
<block name="able_date">
</block>
<block name="content_body">
    <style>
        .font13 {
            font-size: 13px;
        }

        .fontth {
            font-size: 13px;
            font-weight: 550;
        }

        #other_page .weui-form-preview__bd,
        #other_page .fhindex .weui-cells__title {
            color: black;
        }

        #other_page .fhindex .weui-cells__title {
            font-weight: 550;
        }

        #other_page .weui-form-preview__label {
            text-align-last: auto;
            min-width: 1em;
        }
    </style>
    <div class="weui-cells">
        <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd">
                <label class="weui-label">结算详情&nbsp;&nbsp;
                    <span style="color:red;">*</span>
                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-select " type="text" readonly="" id="select_ycl" style="color: #337ab7;"
                    value="提交结算信息" autocomplete="off">
            </div>
        </div>
        <div class="weui-cell ">
            <div class="weui-cell__hd">
                <label class="weui-label">执行时间&nbsp;&nbsp;
                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-input zmsj" type="text" name="custodian" readonly placeholder="自动填写" />
                <span id="zmsj"></span>
            </div>
        </div>
        <div class="weui-cell ">
            <div class="weui-cell__hd">
                <label class="weui-label">时间范围&nbsp;&nbsp;
                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-input sjfw" type="text" name="custodian" readonly placeholder="自动填写" />
                <span id="sjfw"></span>
            </div>
        </div>
        <div class="weui-cell ">
            <div class="weui-cell__hd">
                <label class="weui-label">客户名称&nbsp;&nbsp;
                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-input khmc" type="text" name="custodian" readonly placeholder="自动填写" />
                <span id="khmc"></span>
            </div>
        </div>
        <div class="weui-cell " id='jsje_div'>
            <div class="weui-cell__hd">
                <label class="weui-label">结算金额&nbsp;&nbsp;
                </label>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-input jsje" type="text" name="custodian" readonly placeholder="自动填写" />
                <span id="jsje"></span>
            </div>
        </div>
    </div>


    <div class="other_page" id="other_page" style="display: none;">
        <div class="container">
            <div class="page js_show">
                <div class="weui-cells weui-cells_form">

                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">
                                <span class="">结算类型</span>&nbsp;&nbsp;
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <select class="weui-select greyColor" name="type" id='jslx'>
                                <option value='-1' disabled selected style='display:none;'>请选择结算类型</option>
                                <!-- <option value="1">磅差调整</option> -->
                                <!-- <option value="2">返利</option> -->
                                <!-- <option value="3">手续费</option> -->
                                <option value="5">价差调整</option>
                                <!-- <option value="6">业务费调整</option> -->
                                <option value="4">其他</option>
                                <option value="7">应收坏账调整</option>
                                <option value="8">预收呆账调整</option>
                            </select>
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">客户名称&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd" id='alter_div'>
                            <select class="weui-select" name="user_name[]" id="user_name" multiple="multiple"
                                style="width: 95%;" data-placeholder="客户范围为总客户[有效+冻结]">
                            </select>
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">开始日期&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select" type="text" name="custodian" id="start_date" readonly=""
                                placeholder="请选择开始日期" value="" autocomplete="off">
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">结束日期&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select" type="text" name="custodian" id="end_date" readonly=""
                                placeholder="请选择结束日期" value="" autocomplete="off">
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd">
                            <label class="weui-label">执行日期&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-select" type="text" name="custodian" id="showDatePicker" readonly
                                value="" placeholder="请选择执行日期" />
                        </div>
                    </div>
                </div>
                <div class="weui-cells__title">
                    <div style="display: inline-block;width: 40%;">结算详情</div>
                    <div style="display: inline-block;width: 50%;text-align: right;">
                        <div id="btn-all" class="btn btn-default btn-sm">关闭</div>
                        <div id="overdue" class="btn btn-success btn-sm">确定</div>
                    </div>
                </div>
                <!-- 其他 -->
                <div class="weui-cells" id='other_div' style="display:none;">
                    <div class="weui-cell ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">结算金额&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input " type="number" id="js" name="custodian" placeholder="请输入结算金额" />
                            <div class="weui-input" id="js_show"></div>
                        </div>
                    </div>
                    <div class="weui-cell ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">大写金额&nbsp;&nbsp;
                            </label>
                        </div>
                        <div class="weui-cell__bd greyColor" id="show_cap">自动填写
                        </div>
                    </div>
                </div>
                <!-- 呆账坏账 -->
                <div class="weui-cells" id='dz_div' style="display:none;">
                    <div class="weui-cell ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">应收余额&nbsp;&nbsp;
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input show_number" type="text" name="custodian" readonly="" id='ys'
                                placeholder="自动填写" autocomplete="off">
                            <span id="ysye"></span>
                        </div>
                    </div>
                    <div class="weui-cell ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">调整金额&nbsp;&nbsp;
                                <span style="color:red;">*</span>
                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input " type="number" id="tz" name="custodian" placeholder="请输入结算金额" />
                            <div class="weui-input" id="tz_show"></div>
                        </div>
                    </div>
                    <div class="weui-cell ">
                        <div class="weui-cell__hd">
                            <label class="weui-label">调整余额&nbsp;&nbsp;

                            </label>
                        </div>
                        <div class="weui-cell__bd">
                            <span id="tzye">0</span>
                        </div>
                    </div>
                </div>
                <!-- 价差 -->
                <div id='jc_div' style="padding-top:5px;display: none; ">
                    <div class="weui-cells weui-cells_form" style="margin-top: 0;min-height: 101%">
                        <div class="page__bd">
                            <div class="weui-cells searchbar-result" id="jc_content"
                                style="background-color:#f8f8f8;margin-top:0;">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</block>

<block name='js'>
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel">价差调整</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="tzzl" class="control-label">数量: <span class="tzzl"></span></label>
                            <input type="text" onkeyup="clearNoNum(this)" onchange="checkNum(this)" class="form-control"
                                id="tzzl">
                        </div>
                        <div class="form-group">
                            <label for="tzdj" class="control-label">单价:<span class="tzdj"></span></label>
                            <input type="text" onkeyup="clearNoNum(this)" onchange="checkNum(this)" class="form-control"
                                id="tzdj">
                        </div>
                        <div class="form-group">
                            <label for="tzyf" class="control-label">运费:<span class="tzyf"></span></label>
                            <input type="text" onkeyup="clearNoNum(this)" onchange="checkNum(this)" class="form-control"
                                id="tzyf">
                        </div>
                        <div class="form-group">
                            <label for="tzxj" class="control-label">小计:<span class="tzxj"></span></label>
                            <input type="text" class="form-control" readonly='true' id="tzxj">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id='btn-sure'>确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="__PUBLIC__/assets/js/AmountConversionformat.js"></script>
    <script>
        // Params
        var user_id = 0;
        var qmje = 0;
        var tzindex = '';
        var client = '';
        var tzData = '';
        var user_name = '';
        var changeData = '';
        var noDataHtml = '<div class="weui-form-preview">\
                    <div class="weui-form-preview__bd">\
                        <div class="weui-flex">\
                            <div class="weui-form-preview__item weui-flex__item">\
                                    <div class="weui-cells__title" style="text-align:center;color:black;">本月无发货</div>\
                        </div>\
                    </div>\
                </div>';
        // 呆账 坏账金额
        var init_data_2 = {
            'input': $('#tz'),
            'show_div': $('#tz_show'),
            'symbol': "&yen;",
            'input_show_bool': false
        };
        var forTest_2 = new AmountConversionformat(init_data_2);
        forTest_2.init();
        // 金额输入
        var init_data_1 = {
            'input': $('#js'),
            'show_div': $('#js_show'),
            'symbol': "&yen;",
            'input_show_bool': false
        };
        var show_cap = $('#show_cap');
        var forTest_1 = new AmountConversionformat(init_data_1);
        forTest_1.init();
        // 开始时间
        $('#start_date').on('click', function () {
            DateClick('start_date', $(this).val());
        });
        // 结束时间
        $('#end_date').on('click', function () {
            DateClick('end_date', $(this).val());
        });
        // 时间选择器
        function DateClick($domId, $val) {
            var dateInfo = getDateInfo($val);
            weui.datePicker({
                start: dateInfo[0] - 1,
                end: dateInfo[0] + 10,
                defaultValue: dateInfo,
                onConfirm: function (result) {
                    DateVal(result, $domId);
                },
                id: $domId,
            });
        }
        // 时间分区
        function getDateInfo($val) {
            var Item = $val == '' ? new Date : new Date($val);
            var year = Item.getFullYear();
            var month = Item.getMonth() + 1;
            var day = Item.getDate();
            return [year, month, day];
        }
        // 时间赋值
        function DateVal(dateArr, id) {
            var val = dateArr[0] + '-';
            val += dateArr[1] > 9 ? dateArr[1] : '0' + dateArr[1];
            val += '-';
            val += dateArr[2] > 9 ? dateArr[2] : '0' + dateArr[2];
            $('#' + id).val(val);
        }
        // 提交
        $('#submit').click(function () {
            var jslx = $('#jslx').val();
            if (jslx == -1) return tooltip('请选择结算类型');
            if (user_id == 0) return tooltip('请选择结算客户');

            switch (jslx) {
                case '4':
                    // 显示其他
                    submitQt();
                    break;
                case '5':
                    // 显示价差
                    submitJc();
                    break;
                default:
                    // 显示呆账坏账
                    submitDz();
            }
        });

        // 其他提交
        function submitQt() {
            var money = $('#js').val();
            if (money == '' || money == 0) return tooltip('请输入结算金额');
            var data = {
                money: money,
            };
            submit(data);
        }

        // 带站坏账 提交
        function submitDz() {
            var money = $('#tz').val();
            if (money == '') return tooltip('调整金额不能为空');
            var data = {
                money: money,
            };
            submit(data);
        }

        // 价差提交
        function submitJc() {
            var data = {
                data: changeData,
            };
            submit(data);
        }

        // 提交
        function submit(data) {
            var reason = $('#reason').val();
            if (reason.length < 5) return tooltip('相关说明不得少于5个字！');
            var stday = $('#start_date').val();
            var enday = $('#end_date').val();
            if (stday == '') return tooltip('请选择开始时间');
            if (enday == '') return tooltip('请选择结束时间');
            var jslx = $('#jslx').val();
            var js_date = $('#showDatePicker').val();
            data.jslx = jslx;
            data.text = reason;
            data.stday = stday;
            data.enday = enday;
            data.user_id = user_id,
                data.js_date = js_date;
            data.action = 'submit';
            data.system = "{$system}";
            data.modname = 'GuestJsApply';
            data.__hash__ = hash;
            data.copyto_id = $("#copyto_id").val();
            toast.fadeIn(200);
            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/GuestJsApplyApi')}",
                dataType: 'json',
                data: data,
                success: function (res) {
                    toast.fadeOut(200);
                    if (res.code == 200) {
                        window.location.href = "{$fixed['info']}" + "&aid=" + res.aid;
                    } else {
                        tooltip(res.msg);
                    }
                }
            });
        }
        // 客户获取
        $(function () {
            // 用户选择
            function formatRepo(repo) { return repo.text; }
            function formatRepoSelection(repo) { return repo.text }
            $("#user_name").select2({
                ajax: {
                    url: "{:U('Light/Api/GuestJsApplyApi')}" + "&system=kk&modname=GuestJsApply&action=getCustomerList",
                    dataType: 'json',
                    delay: 350,
                    data: function (params) {
                        $('#alter_div input').eq(0).attr('placeholder', '请选择客户或拼音缩写');
                        return {
                            math: params.term,
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data
                        };
                    },
                    cache: true
                },
                escapeMarkup: function (markup) { return markup; },
                minimumInputLength: 0,
                minimumResultsForSearch: 9,
                // allowClear: true,
                language: "zh-CN",
                templateResult: formatRepo,
                templateSelection: formatRepoSelection
            });
            $('#alter_div').on('blur', 'input', function () {
                if (!user_id) $('#alter_div input').eq(0).attr('placeholder', '客户范围为总客户[有效+冻结]');
            })
            // select2 点击触发
            $("#user_name").on("select2:selecting", function (e) {
                $('.select2-selection__choice__remove').click();
                var selectArr = e.params.args.data;
                user_name = selectArr.text;
                $('.select2-selection__choice').text(selectArr.text);
                user_id = selectArr.id;
                showDom();
            });
            $("#user_name").on("select2:unselecting", function (e) {
                user_id = 0;
                user_name = '';
            });

        });
        $('#jslx').change(function () {
            showDom();
        });
        // 显示对应的 模块
        function showDom() {
            if (user_id == 0) return;
            var type = $('#jslx').val();
            if (type == -1) return;
            $('#select_ycl').val('查看结算信息');
            switch (type) {
                case '4':
                    // 显示其他
                    $('#other_div').show();
                    $('#dz_div').hide();
                    $('#jc_div').hide();
                    $('#hide').show();
                    $('#jsje_div').show();
                    break;
                case '5':
                    // 显示价差
                    $('#other_div').hide();
                    $('#dz_div').hide();
                    $('#jc_div').show();
                    $('#jsje_div').hide();
                    break;
                default:
                    // 显示呆账坏账
                    $('#other_div').hide();
                    $('#dz_div').show();
                    $('#jc_div').hide();
                    $('#hide').show();
                    $('#jsje_div').show();
                    // 获取应收
                    getClientInfo();
            }
            
        }
        // 点击价差信息
        $('#select_ycl').click(function () {
            $('#other_page').show();
        });
        // 点击确定
        $('#overdue').click(function () {
            var stday = $('#start_date').val();
            var enday = $('#end_date').val();
            if (stday == '') return tooltip('请选择开始时间');
            if (enday == '') return tooltip('请选择结束时间');
            var jslx = $('#jslx').val();
            if (jslx == 5) {
                getJcData();
            }
        });
        // 点击关闭
        $('#btn-all').click(function () {
            // 执行时间
            var zxsj = $('#showDatePicker').val();
            if (zxsj != '') {
                showInfo('zmsj', zxsj);
            }
            var stday = $('#start_date').val();
            var enday = $('#end_date').val();
            if (stday != '' && enday != '') {
                showInfo('sjfw', stday + ' 至 ' + enday);
            }
            if (user_id != 0) {
                showInfo('khmc', user_name);
            }
            var jslx = $('#jslx').val();
            if (jslx == 4) {
                showInfo('jsje', $('#js_show').html());
            } else if (jslx == 7 || jslx == 8) {
                showInfo('jsje', '&yen;' + forTest_1.formatMoney($('#tz').val(), 2));
            }
            showInfo()
            $('#other_page').hide();
        });
        function showInfo(classNmae, val) {
            if (val == '') {
                $('.' + classNmae).show();
                $('#' + classNmae).hide();
                $('#' + classNmae).html('');
            } else {
                $('.' + classNmae).hide();
                $('#' + classNmae).show();
                $('#' + classNmae).html(val);
            }
        }
        // 获取价差信息
        function getJcData() {
            var stday = $('#start_date').val();
            var enday = $('#end_date').val();
            if (stday == '' || enday == '') return;
            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/GuestJsApplyApi')}",
                dataType: 'json',
                data: {
                    user_id: user_id,
                    system: "{$system}",
                    modname: 'GuestJsApply',
                    action: 'getJcData',
                    stday: stday,
                    enday: enday,
                },
                success: function (res) {
                    changeData = res;
                    for (k in changeData) {
                        changeData[k].xj = 0;
                    }
                    tzData = res;
                    makeJcHtml(res);
                }
            });
        }
        // 价差html拼接
        function makeJcHtml(data) {
            if (data.length == 0) return $('#jc_content').html(noDataHtml);
            var temp = data;
            html = '';
            for (key in temp) {
                html += '<div class="weui-cells__title" style="text-align:center;color:black;">' + temp[key].g_name + '</div>';
                data = temp[key].data;
                for (k in data) {
                    var classNameZl = 'zl' + data[k].client + k;
                    var classNameDj = 'dj' + data[k].client + k;
                    var classNameYf = 'yf' + data[k].client + k;
                    var classNameXj = 'xj' + data[k].client + k;
                    html += '<div class="weui-cells__title" style="margin-top: 3px;">日期：' + data[k].st + ' 至 ' + data[k].end + '</div>\
                            <div class="weui-cells weui-cells_form " style="padding-bottom: 5px;">\
                                <div class="weui-cells__title" style="color: black;position: relative;">\
                                    <span> '+ data[k].ppformat + ' </span> \
                                    <a href="#"    style="position:absolute;right: 25px;">\
                                        <span style="color:#f12e2e;">点击调整价差&rarr;</span>\
                                        <i  client='+ data[k].client + ' index=' + k + ' data-toggle="modal" data-target="#exampleModal" data-whatever="@mdo" class="iconfont icon-xiugai tzbtn" style="font-size: 18px;vertical-align: middle;"></i>\
                                    </a>\
                                </div>\
                                <div class="weui-flex" style="padding: 2px 15px;">\
                                        <div class="weui-form-preview__item font13" style="width: 50px;"></div>\
                                        <div class="weui-form-preview__item weui-flex__item  fontth">数量</div>\
                                        <div class="weui-form-preview__item weui-flex__item  fontth">单价 [运费]</div>\
                                        <div class="weui-form-preview__item weui-flex__item  fontth">小计</div>\
                                    </div>\
                                    <div class="weui-flex" style="padding: 3px 15px;">\
                                        <div class="weui-form-preview__item   fontth" style="width: 50px;">调整前</div>\
                                        <div class="weui-form-preview__item weui-flex__item  font13">'+ data[k].zlformat.replace(/(?:\.0*|(\.\d+?)0+)$/,'$1') + '</div>\
                                        <div class="weui-form-preview__item weui-flex__item  font13">'+ data[k].djformat.replace(/(?:\.0*|(\.\d+?)0+)$/,'$1') + ' [' + data[k].yf + ']</div>\
                                        <div class="weui-form-preview__item weui-flex__item  font13">&yen;'+ data[k].xjformat.replace(/(?:\.0*|(\.\d+?)0+)$/,'$1') + '</div>\
                                    </div>\
                                    <div class="weui-flex" style="padding: 3px 15px;">\
                                        <div class="weui-form-preview__item fontth" style="width: 50px;">调整后</div>\
                                        <div class="weui-form-preview__item weui-flex__item  font13 '+ classNameZl + '">' + data[k].zlformat.replace(/(?:\.0*|(\.\d+?)0+)$/,'$1') + '</div>\
                                        <div class="weui-form-preview__item weui-flex__item  font13 '+ classNameDj + '">' + data[k].djformat.replace(/(?:\.0*|(\.\d+?)0+)$/,'$1') + ' [' + data[k].yf + ']</div>\
                                        <div class="weui-form-preview__item weui-flex__item  font13 '+ classNameXj + '">0</div>\
                                    </div>\
                            </div>';
                }
            }
            $('#jc_content').html(html);
        }
        // 点击调整按钮 
        $('#jc_content').on('click', '.tzbtn', function () {
            tzindex = $(this).attr('index');
            client = $(this).attr('client');
            $('#tzzl').val(changeData[client]['data'][tzindex].zl);
            $('#tzdj').val(changeData[client]['data'][tzindex].dj);
            $('#tzyf').val(changeData[client]['data'][tzindex].yf);
            $('#tzxj').val(changeData[client]['data'][tzindex].xj);
            $('.tzzl').html(tzData[client]['data'][tzindex].zlformat.replace(/(?:\.0*|(\.\d+?)0+)$/,'$1'));
            $('.tzdj').html(tzData[client]['data'][tzindex].djformat.replace(/(?:\.0*|(\.\d+?)0+)$/,'$1'));
            $('.tzyf').html(tzData[client]['data'][tzindex].yfformat.replace(/(?:\.0*|(\.\d+?)0+)$/,'$1'));
            $('.tzxj').html('&yen;'+tzData[client]['data'][tzindex].xjformat.replace(/(?:\.0*|(\.\d+?)0+)$/,'$1'));
        });
        // 调整数值改变
        $('#tzzl,#tzdj,#tzyf').blur(function () {
            var tzzl = parseFloat($('#tzzl').val());
            var tzdj = parseFloat($('#tzdj').val());
            var tzyf = parseFloat($('#tzyf').val());
            var tzxj = mul(tzzl,add(tzdj,tzyf));
            if (tzxj === NaN || tzxj == '' || tzxj == undefined) { 
                tzxj = 0;
             }
            $('#tzxj').val(tzxj);
        });
        // 调整点击确定
        $('#btn-sure').click(function () {
            var tzzl = parseFloat($('#tzzl').val());
            var tzdj = parseFloat($('#tzdj').val());
            var tzyf = parseFloat($('#tzyf').val());
            var tzxj = parseFloat($('#tzxj').val());
            changeData[client]['data'][tzindex].zl = tzzl;
            changeData[client]['data'][tzindex].dj = tzdj;
            changeData[client]['data'][tzindex].yf = tzyf;
            changeData[client]['data'][tzindex].xj = tzxj;
            var color = tzxj < 0 ? '#f12e2e':'black'; 
            $('.zl' + client + tzindex).html(forTest_2.formatMoney(tzData[client]['data'][tzindex].zl, 2).replace(/(?:\.0*|(\.\d+?)0+)$/,'$1') );
            $('.dj' + client + tzindex).html('&yen;' + forTest_2.formatMoney(tzData[client]['data'][tzindex].dj, 2).replace(/(?:\.0*|(\.\d+?)0+)$/,'$1')  + ' [' + tzData[client]['data'][tzindex].yf + ']');
            $('.xj' + client + tzindex).html('<span style="color:'+color+';">&yen;' + forTest_2.formatMoney(tzData[client]['data'][tzindex].xj, 2).replace(/(?:\.0*|(\.\d+?)0+)$/,'$1') +'</span>');
        });
        // 获取用户应收
        function getClientInfo() {

            $.ajax({
                type: 'POST',
                url: "{:U('Light/Api/GuestJsApplyApi')}",
                dataType: 'json',
                data: {
                    user_id: user_id,
                    system: "{$system}",
                    modname: 'GuestJsApply',
                    action: 'getClientInfo',
                },
                success: function (res) {
                    $('#ys').hide();
                    $('#ysye').html('<span style="color:' + res['color'] + '">&yen;' + res['format'] + '</span>');
                    $('#tz').hide();
                    qmje = parseFloat(res['qmje']);
                    $('#tz').val(res['tzje']);
                    $('#tz_show').show();
                    $('#tz_show').html('&yen;' + res['format2']);
                }
            });
        }
        // 计算调整后余额
        $('#tz').blur(function () {
            var val = $(this).val();
            var itemVal = parseInt(val) + parseInt(qmje);
            $('#tzye').html(itemVal);
        });

        // 金额输入 显示大写
        $('#js').keyup(function () {
            var money = $(this).val();
            ykje_y = String(money).indexOf(".") + 1;
            ykje_count = String(money).length - ykje_y;
            if (ykje_y > 0 && ykje_count > 2) return tooltip('金额错误，小数点后面保留2位数');
            if (money.length > 15) {
                money = money.substr(0, 15);
                $(this).val(money);
            }
            var cap = AmountLtoU(money);
            if (cap == '零元整') {
                show_cap.removeClass('redColor');
                show_cap.addClass('greyColor');
                show_cap.html('自动填写');
            } else {
                show_cap.removeClass('greyColor');
                show_cap.addClass('redColor');
                show_cap.html(cap);
            }

        });
        function AmountLtoU(num) {
            ///<param name=num type=number>金额</param>
            if (isNaN(num)) return "";
            var strPrefix = "";
            if (num < 0) strPrefix = "(负)";
            num = Math.abs(num);
            if (num >= 1000000000000) return "您输入的数字太大，重新输入";
            var strOutput = "";
            var strUnit = '仟佰拾亿仟佰拾万仟佰拾元角分';
            var strCapDgt = '零壹贰叁肆伍陆柒捌玖';
            num += "00";
            var intPos = num.indexOf('.');
            if (intPos >= 0) {
                num = num.substring(0, intPos) + num.substr(intPos + 1, 2);
            }
            strUnit = strUnit.substr(strUnit.length - num.length);
            for (var i = 0; i < num.length; i++) {
                strOutput += strCapDgt.substr(num.substr(i, 1), 1) + strUnit.substr(i, 1);
            }
            return strPrefix + strOutput.replace(/零角零分$/, '整').replace(/零[仟佰拾]/g, '零').replace(/零{2,}/g, '零').replace(/零([亿|万])/g, '$1').replace(/零+元/, '元').replace(/亿零{0,3}万/, '亿').replace(/^元/, "零元");
        };
        // 输入限制
        function clearNoNum(obj) {
            obj.value = obj.value.replace(/[^\d.-]/g, "");  //清除“数字”和“.”以外的字符  
            obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/, '$1$2.$3');//只能输入两个小数  
            
        }
        function checkNum(obj) {
            obj.value = obj.value.replace(/\.{2,}/g, "."); //只保留第一个. 清除多余的  
            obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
            
            //如果没有小数点，不能为类似 01、02的金额 
            if (obj.value.indexOf(".") < 0 && obj.value != "") {
                obj.value = parseFloat(obj.value);
            }
            //如果有小数点，不能为类似 1.10的金额  
            if (obj.value.indexOf(".") > 0 && obj.value.indexOf("0") > 2) {
                obj.value = parseFloat(obj.value);
            }
            //如果有小数点，不能为类似 0.00的金额 
            if (obj.value.indexOf(".") > 0 && obj.value.lastIndexOf("0") > 2) {
                obj.value = parseFloat(obj.value);
            }
        }
        function add(a, b) {
            var c, d, e;
            try {
                c = a.toString().split(".")[1].length;
            } catch (f) {
                c = 0;
            }
            try {
                d = b.toString().split(".")[1].length;
            } catch (f) {
                d = 0;
            }
            return e = Math.pow(10, Math.max(c, d)), (mul(a, e) + mul(b, e)) / e;
        }

        function sub(a, b) {
            var c, d, e;
            try {
                c = a.toString().split(".")[1].length;
            } catch (f) {
                c = 0;
            }
            try {
                d = b.toString().split(".")[1].length;
            } catch (f) {
                d = 0;
            }
            return e = Math.pow(10, Math.max(c, d)), (mul(a, e) - mul(b, e)) / e;
        }

        function mul(a, b) {
            var c = 0,
                d = a.toString(),
                e = b.toString();
            try {
                c += d.split(".")[1].length;
            } catch (f) { }
            try {
                c += e.split(".")[1].length;
            } catch (f) { }
            return Number(d.replace(".", "")) * Number(e.replace(".", "")) / Math.pow(10, c);
        }

        function div(a, b) {
            var c, d, e = 0,
                f = 0;
            try {
                e = a.toString().split(".")[1].length;
            } catch (g) { }
            try {
                f = b.toString().split(".")[1].length;
            } catch (g) { }
            return c = Number(a.toString().replace(".", "")), d = Number(b.toString().replace(".", "")), mul(c / d, Math.pow(10, f - e));
        }
    </script>
</block>