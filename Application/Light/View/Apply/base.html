<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=0">
    
    <title>{$title}</title>
    <link href="__PUBLIC__/assets/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 WeUI -->
    <!-- <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/1.1.2/weui.min.css" /> -->
    <link rel="stylesheet" href="__PUBLIC__/assets/css/weui.min.css" />
    <link rel="stylesheet" href="__PUBLIC__/assets/css/weMain.css?version=201709012" />
    <link rel="stylesheet" href="__PUBLIC__/assets/css/viewer.css" />
    <link rel="stylesheet" href="//at.alicdn.com/t/font_915899_6e03l1mub3m.css" />
    <style type="text/css">
  .weui-cells:after {
            border-bottom: 0px solid #fff;
        }
        .weui-selet__user {
            width: 2.5em;
            height: 2.5em;
            margin-bottom: 5px;
            margin-right: 16px;
            border-radius: 5px;
        }
        .wk-select__user {
            height: 60px;
            width: 52px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 6px;
        }
        .wk-select__css {
            height: 100px;
            width: 52px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 6px;
        }
        .wk-comment__user {
            height: 60px;
            width: 52px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 12px;
        }
        a:hover {
            text-decoration: none;
        }
        .weui-tabbar{
            position: fixed;
        }
        /* textarea 自适应父容器大小 */  
        .comment {  
            width: 100%; /*自动适应父布局宽度*/  
            overflow: auto;  
            word-break: break-all;  
            margin-top: 5px;
        }  

        label {
            font-weight: 400;
            margin-bottom: 0px;
        }
        .searchCenter{
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fjys{
            margin-right: 9px;
            margin-bottom: 9px;
            width: 79px;
            height: 79px;
            background: no-repeat 50%;
            background-size: cover;
        }
        @media print{
                a:after{
                    content:""!important;
                }
            }
        .ready-btn{
            text-align: center;
            padding: 10px;
            font-size: 16px;
            background: #fff;
        }
        .ready-btn-on{
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container" id="container">
        <div class="page tabbar js_show" >
            <div class="page__bd" style="height: 100%;">
                    
                        <div class="weui-tab">
                            <div class="weui-tab__panel">
                    
                    <div class="weui-panel weui-panel_access" id='weui_panel_content'>
                        <!-- <div class="weui-panel__hd">审批信息</div> -->
                        <div class="weui-panel__bd">
                            <div class="weui-media-box weui-media-box_small-appmsg">
                                <div class="weui-cells">
                                    <span class="weui-media-box weui-media-box_appmsg">
                                        <div class="weui-media-box__bd" id="apply_status">
                                            <block name='show_title'>
                                                <div style="display: flex;flex-direction: row;align-items: center;margin-bottom: 1em;">
                                                    <img class="weui-media-box__thumb" src="{$avatar}" alt="" style="border-radius: 5px;width: 2.5em;height: 2.5em;margin-right: 1em;">
                                                    <h4 class="weui-media-box__title" style="font-weight: 800;font-size:20px;">{$applyer}的{$title|str_replace="表",'',###}</h4>
                                                    <eq name="stat" value="1">
                                                        <span class="label label-success" style="margin-left: 1em;padding-top: 0.3em;padding-bottom: 0.2em">已通过</span>
                                                    </eq>
                                                    <eq name="stat" value="2">
                                                        <eq name="apply.stat" value="2">
                                                            <span class="label label-success" style="margin-left: 1em;padding-top: 0.3em;padding-bottom: 0.2em">已通过</span>
                                                        </eq>
                                                        <eq name="apply.stat" value="1">
                                                            <span class="label label-danger" style="margin-left: 1em;padding-top: 0.3em;padding-bottom: 0.2em">已退审</span>
                                                        </eq>
                                                        <eq name="apply.stat" value="0">
                                                            <eq name="isSigning" value='会审'>
                                                                    <span class="label label-primary" style="margin-left: 1em;padding-top: 0.3em;padding-bottom: 0.2em">会审中</span>
                                                                <else/>
                                                                    <span class="label label-primary" style="margin-left: 1em;padding-top: 0.3em;padding-bottom: 0.2em">审批中</span>
                                                            </eq>
                                                        </eq>
                                                    </eq>
                                                    <eq name="stat" value="0">
                                                        <span class="label label-default" style="margin-left: 1em;padding-top: 0.3em;padding-bottom: 0.2em">已撤销</span>
                                                    </eq>
                                                </div>
                                            </block>
                                            <block name="content_body">
                                                <volist name="content" id="val">
                                                    <p class="weui-media-box__desc weui-flex">
                                                        <span class="font-width" >{$val.name}</span>
                                                        <span class="weui-flex__item" id="{$val.id}" style="color:{$val.color} ">{$val.value}</span>
                                                    </p>
                                                </volist>
                                            </block>
                                        </div>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div> 
                    <if condition="!empty($imgsrc)">
                        <div class="weui-panel" id='weui_panel_fj' style="margin-top: 0px;">
                            <div class="weui-panel__hd" style="font-size: 16px;background-color: #f8f8f8;color:black;padding-top: 10px;">附件
                                    <span style="color: #f12e2e;font-size: 14px;">（点击图片，可查看附件）</span>
                                </div>
                            <div class="weui-cells" style="margin-top:0px;">
                                <div class="weui-cell">
                                    <div class="weui-uploader__bd">
                                        <ul class="weui-uploader__files" id="viewer" style="margin-bottom: 0px;float: left;" >
                                                <volist name="imgsrc" id="val">
                                                    <img src={$val} class='fjys' data-original="{$val}" >
                                                </volist>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                                
                        </div>
                    </if>      

                    <block name="table"></block>      
                          
                <block name="work_flow">
                    <div class="weui-panel" style="margin-top: 0px;" id='weui_panel_table'>
                        <div class="weui-panel__hd" style="font-size: 16px;background-color: #f8f8f8;color:black;padding-top: 10px;">审批流程
                            <a href="{:U('Light/Process/ApplyProcess',array('modname'=>$mod_name,'system'=>$system,'aid' => $aid))}">
                                <i class="iconfont icon-chakan" style="vertical-align: middle;" ></i>
                            </a> 
                        </div>
                        <div class="weui-cells" style="margin-top:0px;">
                            <div class="weui-cell">
                                <div class="weui-cell__bd">
                                    <div class="weui-uploader">
                                        <div class="weui-uploader__bd" style="height: 70px;">
                                            <ul class="weui-uploader__files" id="app_pro" style="margin-bottom: 0px;">
                                               
                                            <block name="process">
                                                <volist name="proInfo" id="vo">
                                                    <if condition="$vo.id eq $first['id']">
                                                        <li class='weui-uploader__file wk-select__user' id='{$first.id}' style='min-height:70px;width: 45px; margin-bottom: 0;margin-right: 0'>
                                                    <else/>
                                                        <li class='weui-uploader__file wk-select__user' id='{$vo.id}' style='min-height:70px;width: 45px; margin-bottom: 0;margin-right: 0;margin-left:8px'>
                                                    </if>
                                                    <if condition="$vo.avatar eq ''">
                                                        <img src='Public/assets/i/defaul.png' class='weui-selet__user' style='margin-right: 6px;margin-top:10px; width: 2em; height: 2em;'>
                                                        <else/>
                                                        <img src={$vo.avatar} class='weui-selet__user' style='margin-right: 6px;margin-top:10px; width: 2em; height: 2em;'>
                                                    </if>
                                                    <span style='margin-right: 6px;font-size: 12px;'>{$vo.realname}</span>
                                                    <if condition="$vo.proc eq 1">
                                                            <span class="glyphicon glyphicon-arrow-right" style="position: relative;top: -3.3em;right: 2em;font-size: 14px;"></span>
                                                    </if>
                                                    <if condition="$vo.proc eq 2">
                                                            <span style="border-radius: 3px;position: relative;top: -2.3em;right: 1.7em;width: 5px;height: 5px;background-color: #333333"></span>       
                                                    </if>
                                                    </li>
                                                </volist>
                                            </block>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </block>

                <block name="process_record">
                    <div class="weui-panel" style="margin-top: 0px;" id='weui_panel_proc'>
                        <div class="weui-panel__hd" style="font-size: 16px;background-color: #f8f8f8;color:black;padding-top: 10px;">审批记录</div>
                        <div class="weui-panel__bd">
                            <div class="weui-media-box weui-media-box_small-appmsg" style="padding-bottom: 10px;">
                                <div class="weui-cells">
                                   
                                    <if condition="empty($process)">
                                            <span class="weui-media-box weui-media-box_appmsg" style="    align-items: flex-start;padding-top: 10px;">
                                                    <h4 class="weui-media-box__title" style="/*font-weight: 800;*/margin-top: 0px;margin-bottom: 5px;color:grey;">
                                                        无审批记录
                                                    </h4>
                                            </span>
                                        <else/>
                                        
                                        <volist name="process" id="proc">
                                            <span class="weui-media-box weui-media-box_appmsg" style="    align-items: flex-start;padding-top: 10px;">
                                                <div class="weui-media-box__hd" style="width: 2.5em;height: 2.5em;">
                                                    <img class="weui-media-box__thumb" src="{$proc.avatar}" alt="" style="border-radius: 5px;">
                                                </div>
                                                <div class="weui-media-box__bd">
                                                    <h4 class="weui-media-box__title" style="/*font-weight: 800;*/margin-top: 0px;margin-bottom: 5px;color:grey;">
                                                        <eq name="proc.app_stat" value="0"> {$proc.per_name}&nbsp;&nbsp;&nbsp;&nbsp;
                                                                <if condition="$proc.app_name neq '会审'">[审批中]
                                                                    <else/>[会审中]
                                                                    </if>
                                                                </eq>
                                                        <eq name="proc.app_stat" value="1"> {$proc.per_name}&nbsp;&nbsp;&nbsp;&nbsp;
                                                            <span style="color:red;">[已退审]</span>
                                                        </eq>
                                                        <eq name="proc.app_stat" value="2">
                                                            <if condition="$proc.app_name eq '已转审'">
                                                                {$proc.per_name}&nbsp;&nbsp;&nbsp;&nbsp;[已转审]
                                                                <else/> {$proc.per_name}&nbsp;&nbsp;&nbsp;&nbsp;[已同意]   
                                                                    </eq>
                                                            </if>
                                                        </eq>
                                                        <span  style="float: right;font-size: 15px;line-height: 18px;">{$proc.approve_time|substr=2,14}</span> 
                                                    </h4>
                                                    <p class="weui-media-box__desc" style="display: block;overflow: visible; word-break:break-all; word-wrap:break-word;margin-bottom: 0px;color:black;">
                                                       <if condition="$proc.sign neq '' " >
                                                           <img src="__PUBLIC__/upload/sign/{$proc.sign}" style="width: 150px;"><br/>
                                                       </if>
                                                        {$proc.app_word}
                                                    </p>
                                                    <p class="weui-media-box__desc" style="display: block;overflow: visible; word-break:break-all; word-wrap:break-word;font-size: 15px;margin-bottom: 0px;">
                                                        
                                                        <neq name="proc.app_stat" value="0">
                                                            <eq name="Think.session.name" value="$proc.per_name">
                                                                <eq name="proc.able_del" value="1">
                                                                    <span style="color:red; cursor: pointer;" class="proc_del" data-id="{$proc.aid}" data-mod="{$proc.mod_name}">
                                                                    <span style="color:grey; ">（5分钟内）</span>撤回</span>  
                                                                    <else/>
                                                                    <span style="color:grey; ">(超5分钟不可撤回)</span>
                                                                </eq>
                                                            </eq>
                                                        </neq>
                                                        
                                                    </p>
                                                </div>
                                            </span>
                                        </volist>
                                    </if>
                                </div>
                            </div>
                        </div>
                    </div>
                </block>

                <block name="copyto">
                    <div class="weui-panel" style="margin-top: 0px;">
                        <div class="weui-panel__hd" style="font-size: 16px;background-color: #f8f8f8;color:black;padding-top: 10px;">抄送<span style="color: #f12e2e">（点击+手动添加抄送人）</span></div>
                        <div class="weui-panel__bd" >
                            <div class="weui-media-box weui-media-box_small-appmsg" >
                                <div class="weui-cells" style="margin-top:0px;">
                                    <div class="weui-cell" style="padding-top: 3px;padding-bottom: 1px;">
                                        <div class="weui-cell__bd">
                                            <div class="weui-uploader">
                                                <div class="weui-uploader__bd">
                                                    <ul class="weui-uploader__files" style="margin-bottom: 0px;" id='selectUser'>
                                                        <if condition="empty($already_cp)">
                                                            <li>
                                                                    <h4 class="weui-media-box__title" style="/*font-weight: 800;*/margin-top: 0px;margin-bottom: 5px;color:grey;">
                                                                    无抄送人
                                                                    </h4>
                                                            </li>
                                                            <else/>
                                                            <volist name="already_cp" id="acp">
                                                                <li class="weui-uploader__file wk-select__css" id="{$acp.id}"  style='min-height:70px;width: 45px;margin-right: 0;margin-bottom: 0;'>
                                                                    <if condition="in_array($acp['id'],$fixed_id)">
                                                                        <span style="margin-right: 6px;font-size: 12px;">[固定]</span>
                                                                        <else/>
                                                                        <span style="margin-right: 6px;font-size: 12px;">[手动]</span>
                                                                    </if>
                                                                    <if condition="$acp.url eq ''">
                                                                        <img src="__PUBLIC__/i/defaul.png" class="weui-selet__user" style="margin-right: 6px;margin-top:3px;width: 2em; height: 2em;" />
                                                                        <else/>
                                                                        <img src="{$acp.url}" class="weui-selet__user" style="margin-right: 6px;margin-top:3px;width: 2em; height: 2em;" />
                                                                    </if>
                                                                    <span style="margin-right: 6px;font-size: 12px;">{$acp.name}</span>
                                                                    <if condition="in_array($acp['id'],$readedArr)">
                                                                        <span style="margin-right: 6px;font-size: 12px;color: green;">[已读]</span>
                                                                        <else/>
                                                                        <span style="margin-right: 6px;font-size: 12px;color: red;">[未读]</span>
                                                                    </if>
                                                                </li>
                                                            </volist>
                                                        </if>
                                                    </ul>
                                                    <eq name="isApplyer" value="1">
                                                        <if condition="$apply.state == 0">
                                                            <div class="weui-uploader__input-box" style="width: 2.5em;height: 2.5em;margin: 10px 0 10px 0;">
                                                                <input id="uploaderInput1" class="weui-uploader__input" type="button" name="copyto" data-toggle="modal" data-target="#myModal" readonly />
                                                                <input type="hidden" name="copyto_id" id="copyto_id">
                                                            </div>    
                                                        </if>
                                                    </eq>
                                                    
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                               
                            </div>
                        </div>
                    </div>
                </block>
                <block name="push">
                        <div class="weui-panel" style="margin-top: 0px;">
                            <div class="weui-panel__hd" style="font-size: 16px;background-color: #f8f8f8;color:black;padding-top: 10px;">推送名单
                                <a href="{:U('Light/Process/PushProcess',array('system' => $system,'modname'=>$mod_name,'aid'=>$aid))}">
                                    <i class="iconfont icon-chakan" style="vertical-align: middle;" ></i>
                                </a>
                                <span style="color: #f12e2e;">（审批通过后群发推送人）</span>
                            </div>
                            <div class="weui-panel__bd">
                                <div class="weui-media-box weui-media-box_small-appmsg" >
                                    <div class="weui-cells" style="margin-top:0px;">
                                        <div class="weui-cell" style="padding-top: 3px;padding-bottom: 1px;">
                                            <div class="weui-cell__bd">
                                                <div class="weui-uploader">
                                                    <div class="weui-uploader__bd" >
                                                        <ul class="weui-uploader__files" style="margin-bottom: 0px;" >
                                                            <if condition="empty($already_cpPush)">
                                                                    <volist name="push" id="vo">
                                                                        <li class='weui-uploader__file wk-select__user' style='min-height:70px;height:88px;width: 45px;margin-right: 0;margin-bottom: 0;'>
                                                                        <if condition="$vo.avatar eq ''">
                                                                            <img src="Public/assets/i/defaul.png" class='weui-selet__user' style='margin-right: 6px;margin-top:10px;width: 2em; height: 2em;'>
                                                                            <else/>
                                                                            <img src="{$vo.avatar}" class='weui-selet__user' style='margin-right: 6px;margin-top:10px;width: 2em; height: 2em;'>
                                                                        </if>
                                                                        <span style='margin-right: 6px;font-size: 12px;'> {$vo.name}</span>
                                                                        </li>
                                                                    </volist>
                                                                    <else/>
                                                                    <volist name="already_cpPush" id="acp">
                                                                        <li class="weui-uploader__file wk-select__css" id="{$acp.id}" style='min-height:70px;height:88px;width: 45px;margin-right: 0;margin-bottom: 0;'>
                                                                            <if condition="$acp.url eq ''">
                                                                                <img src="__PUBLIC__/i/defaul.png" class="weui-selet__user" style="margin-right: 6px;margin-top:10px;width: 2em; height: 2em;" />
                                                                                <else/>
                                                                                <img src="{$acp.url}" class="weui-selet__user" style="margin-right: 6px;margin-top:10px;width: 2em; height: 2em;" />
                                                                            </if>
                                                                            <span style="margin-right: 6px;font-size: 12px;">{$acp.name}</span>
                                                                            
                                                                            <if condition="in_array($acp['id'],$readedArrPush)">
                                                                                <span style="margin-right: 6px;font-size: 12px;color: green;">[已读]</span>
                                                                                <else/>
                                                                                <span style="margin-right: 6px;font-size: 12px;color: red;">[未读]</span>
                                                                            </if>  
                                                                        </li>
                                                                    </volist>
                                                            </if>
                                                        </ul>
                                                        <eq name="isApplyer" value="1">
                                                            <eq name="apply.state" value="1">
                                                            
                                                                <div class="weui-uploader__input-box" style="width: 2.5em;height: 2.5em;margin-right: 0px;margin-bottom: 0px;margin-top:20px;">
                                                                    <input id="uploaderInput" class="weui-uploader__input" type="button" name="copyto" data-toggle="modal" data-target="#myModal" readonly />
                                                                    <input type="hidden" name="copyto_id" id="copyto_id">
                                                                </div>
                                                                            
                                                            </eq>
                                                        </eq> 
                                                        
                                                    </div>
                                                    
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </block>
                <block name="comment">
                    <div class="weui-panel" style="margin-top: 0px;">
                        <div class="weui-panel__hd" style="font-size: 16px;background-color: #f8f8f8;color:black;padding-top: 10px;">评论<span style="color: #f12e2e">（流程及抄送人员均可评论或@指定人）</span></div>
                        <div class="weui-panel__bd">
                            <div class="weui-media-box weui-media-box_small-appmsg" style="padding-bottom: 10px;">
                                <div class="weui-cells">
                                    <if condition="empty($comment_list)">
                                            <span class="weui-media-box weui-media-box_appmsg" style="    align-items: flex-start;padding-top: 10px;">
                                                        <h4 class="weui-media-box__title" style="/*font-weight: 800;*/margin-top: 0px;margin-bottom: 5px;color:grey;">
                                                        无评论
                                                        </h4>
                                                    </span>
                                            <else/>
                                    <volist name="comment_list" id="clist">
                                        <if condition="$clist.class eq 'dn'">
                                            <span class="weui-media-box weui-media-box_appmsg {$clist.class}"  style="align-items: flex-start;padding-top: 10px;display: none;">
                                        <else/>
                                            <span class="weui-media-box weui-media-box_appmsg {$clist.class}"  style="align-items: flex-start;padding-top: 10px;">
                                        </if>
                                            <div class="weui-media-box__hd" style="width: 2.5em;height: 2.5em;">
                                                <img class="weui-media-box__thumb" src="{$clist.avatar}" alt="" style="border-radius: 5px;">
                                            </div>
                                            <div class="weui-media-box__bd">
                                                <h4 class="weui-media-box__title" style="/*font-weight: 800;*/margin-top: 0px;margin-bottom: 5px;color:grey;">
                                                    <span>{$clist.name}</span>
                                                    <span style="float: right;font-size: 15px;line-height: 18px;">{$clist.time|substr=2,14}</span>
                                                </h4>
                                                <p class="weui-media-box__desc" style="display: block;overflow: visible; word-break:break-all; word-wrap:break-word;margin-bottom: 0px;color:black;">
                                                    {$clist.word}
                                                </p>
                                               
                                                <if condition="$clist.is_img eq 1">
                                                    <ul class="weui-uploader__files viewer"   style="margin-bottom: 0px;">
                                                        <volist name="clist.file" id="val">
                                                            <img  src="__PUBLIC__/upload/html5uploads/{$val}" class="fjys"  data-original="__PUBLIC__/upload/html5uploads/{$val}" alt="" style="max-width: 95%;">
                                                        </volist>
                                                    </ul>    
                                                </if>
                                                <if condition="($clist.pid neq 9999) AND ($clist.pid neq 8888) ">
                                                    <p class="weui-media-box__desc" style="display: flex;flex-direction:row;justify-content:space-between;align-items:center;font-size: 15px;margin-bottom: 0px;">
                                                        <switch name="clist.comment_ready">
                                                                <case value="no_this_param"><span>&nbsp;</span> </case>
                                                                <case value="readynone"><span>未读</span></case>
                                                                <case value="readyall"><span >全部已读</span></case>
                                                                <default /><span class="comment_id" style='color:#337ab7;' index="{$clist.id}" data-toggle="modal" data-target="#myModal3">{$clist.comment_ready}</span> 
                                                            </switch>
    
                                                        <eq name="Think.session.wxid" value="$clist.wxid">
                                                            <eq name="clist.del_able" value="1">
                                                                <span style="color:red;" class="comment_del" data-id="{$clist.id}">
                                                                    <span style="color:grey;">（2小时内）</span>删除</span>
                                                            </eq>
                                                        </eq>
                                                        <neq name="clist.pid" value="9999">
                                                            <neq name="clist.pid" value="8888">
                                                                <span style="color:red;" realname="{$clist.name}" wxid="{$clist.wxid}" avatar="{$clist.avatar}" data-toggle="modal" data-target="#myModal2" class="reply">回复</span>
                                                            </neq>
                                                        </neq> 
                                                    </p>
                                                </if>
                                                <eq name="clist.class" value="up">
                                                    <p style="font-size: 15px;margin-bottom: 0px;float: right;"><span style="color:#337ab7;"  id="{$clist.class}">展开</span></p>
                                                </eq>
                                            </div>
                                        </span>
                                    </volist>
                                    </if>
                                </div>
                            </div>
                        </div>
                    </div>
                </block>
                

                <if condition="$stat neq 0 ">
                    <block name="apply">
                        <eq name="isApplyer" value="1">
                            <eq name="apply.stat" value="0">
                                <div class="weui-panel" style="margin-top: 0px;">
                                    <div class="weui-panel__hd" style="font-size: 16px;background-color: #f8f8f8;color:black;padding-top: 10px;">{$stepStatus}意见</div>
                                    <div class="weui-panel__bd">
                                        <div class="weui-cell">
                                            <div class="weui-cell__bd">
                                                <textarea class="weui-textarea" placeholder="请输入{$stepStatus}意见;
{$stepStatus}意见可@指定人;
无指定默认@所有人（含抄送）;" rows="3" id="comment" style="font-size: 1.2em"></textarea>
                                                <div class="weui-textarea-counter">
                                                    <!-- 指定@ -->
                                                    <div class="weui-tabbar" style="position: initial;">
                                                        <a href="#" class="weui-tabbar__item" style="text-decoration: none;">
                                                            <p class="weui-tabbar__label" style="font-size: 15px;color:black;" id="btn-sp">
                                                                <span class="glyphicon" aria-hidden="true" style="margin-right: 5px;"></span>@ 指定人</p>
                                                        </a>
                                                    </div>
                                                    <div class="page js_show" id="approve_at" style="position: relative;display: none;">
                                                        <div class="page__bd">
                                                            <div class="weui-cells" id="" style="margin-top: 5px;margin-bottom: 5px;">
                                                                <div class="weui-uploader">
                                                                    <div class="weui-uploader__bd" style="margin-right: 0px;margin-bottom: 0px;padding-top: 12px;">
                                                                        <ul class="weui-uploader__files" id="selectapprovetUser" style="margin-bottom: 0px;">
                                                                        </ul>
                                                                        <input type="hidden" name="approve_to_id" id="approve_to_id">
                                                                    </div>
                                                                </div>
                                                            </div>
                            
                                                            <div class="weui-cells searchbar-result" id="approveSearchResult" style="margin-top: 0px;">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- end   指定@ -->
                                                </div>
                                            </div>
                                            
                                        </div>
                                        <div class="button-sp-area" id="apply-area" style="margin-bottom: 20px;display: flex;flex-direction: row;width: 100%;justify-content: space-around;align-items: baseline;">
                                            <a href="javascript:;" id="apply-agree" class="weui-btn weui-btn_primary" style="width: 40%">同意</a>
                                            <a href="javascript:;" id="apply-refuse" class="weui-btn weui-btn_warn" style="width: 40%;">退审</a>
                                            <!-- <a href="javascript:;" class="weui-btn weui-btn_default">转审</a> -->
                                            
                                            <input type="hidden" name="apply_user" id="apply_user" value="{$applyerID}">
                                        </div>
                                        <div class="button-sp-area" style="margin-bottom: 20px;display: flex;flex-direction: row;width: 100%;justify-content: space-around;align-items: baseline;">
                                            <button id="apply-change" class="weui-btn weui-btn_primary" style="width: 90%">转审</button>
                                        </div>
                                        <!-- <div class="weui-cells__title">各个中心主管及以上职位的申请抄送</div> -->
                                        <div class="weui-cells" style="margin-top:0px;">
                                            <div class="weui-cell">
                                                <div class="weui-cell__bd">
                                                    <div class="weui-uploader">
                                                        <div class="weui-uploader__bd" style="min-height: 50px;">
                                                             <div  style="color: #f12e2e;">点击同意后5分钟内可撤回</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </eq>
                        </eq>
                    </block>
                    
                    <div class="weui-gallery" id="gallery">
                        <span class="weui-gallery__img" id="galleryImg"></span>
                        <!-- <div class="weui-gallery__opr">
                            <a href="javascript:" class="weui-gallery__del">
                                <i class="weui-icon-delete weui-icon_gallery-delete"></i>
                            </a>
                        </div> -->
                    </div>
                </if>
                <input type="hidden" name="aid" id="aid" value="{$aid}">
                <block name='attention'>
                        <if condition=" (empty($atten)) and (!$CueConfig)">
                            <div id="attention" style="display:none">
                            <else/>
                            <div id="attention" >
                        </if>
                            <div class="weui-cells__title">注意事项  
                                <if condition="$CueConfig">
                                    <a href="{:U('Light/Config/Dispenser',array('robot'=>'attention','system' => $system ,'modname' => $mod_name,'aid'=> $aid))}">
                                        <i class="iconfont icon-xiugai" style="vertical-align: middle;" ></i>
                                    </a>
                                </if>
                             </div>
                            <!-- <div class="weui-cells__title">各个中心主管及以上职位的申请抄送</div> -->
                            <div class="weui-cells" style="margin-top:0px;">
                                <div class="weui-cell">
                                    <div class="weui-cell__bd">
                                        <div class="weui-uploader">
                                            <div class="weui-uploader__bd" >
                                                <div id="attentionContent" style="font-size: 15px;color: #f12e2e;white-space: pre-wrap;">{$atten.content}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </block>
                <block name="operation">
                            
                                </div>
                                <div class="weui-tabbar" style="padding-top: 8px;/*position: fixed;*/">
                                    <a href="#" class="weui-tabbar__item" style="text-decoration: none;">
                                        <!--  <span style="display: inline-block;position: relative;">
                                <span class="glyphicon glyphicon-align-left" aria-hidden="true"></span>
                                <span class="weui-badge" style="position: absolute;top: -2px;right: -13px;">8</span>
                            </span> -->
                                        <p class="weui-tabbar__label" style="font-size: 15px;color:black;" data-toggle="modal" data-target="#myModal2">
                                            <span class="glyphicon glyphicon-align-left" aria-hidden="true" style="margin-right: 5px;"></span>评论</p>
                                    </a>
                                    <!-- <a href="javascript:;" class="weui-tabbar__item">
                            <span class="glyphicon glyphicon-align-left" aria-hidden="true"></span>
                            <p class="weui-tabbar__label">通讯录</p>
                        </a> -->
                                    <a href="javascript:;" class="weui-tabbar__item" id="btn-delete">
                                        <!-- <span style="display: inline-block;position: relative;">
                                <span class="glyphicon glyphicon-align-left" aria-hidden="true"></span>
                                <span class="weui-badge weui-badge_dot" style="position: absolute;top: 0;right: -6px;"></span>
                            </span> -->
                                        <p class="weui-tabbar__label" style="font-size: 15px;color:black;"  id="show_iosDialog_delete">
                                            <span class="glyphicon glyphicon-share-alt" aria-hidden="true" style="margin-right: 5px;"></span>撤销</p>
                                    </a>
                                    <a href="javascript:;" class="weui-tabbar__item" id="btn-urge">
                                        <p class="weui-tabbar__label" style="font-size: 15px;color:black;">
                                            <span class="glyphicon glyphicon-hourglass" aria-hidden="true" style="margin-right: 5px;"></span>催审</p>
                                    </a>
                                </div>
                                </div>
                </block>
            
            </div>
        </div>
        <!--BEGIN toast-->
        <div id="toast" style="display: none;">
            <div class="weui-mask_transparent"></div>
            <div class="weui-toast">
                <i class="weui-icon-success-no-circle weui-icon_toast"></i>
                <p class="weui-toast__content">已完成</p>
            </div>
        </div>
        <!--end toast-->
        <!-- loading toast -->
        <div id="loadingToast" style="display:none;">
            <div class="weui-mask_transparent"></div>
            <div class="weui-toast">
                <i class="weui-loading weui-icon_toast"></i>
                <p class="weui-toast__content">数据加载中</p>
            </div>
        </div>
        <!-- changeable toast -->
        <div id="doingToast" style="display:none;">
            <div class="weui-mask_transparent"></div>
            <div class="weui-toast">
                <i class="weui-loading weui-icon_toast"></i>
                <p class="weui-toast__content" id="doing">进行中...</p>
            </div>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" width="100%">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only copy_to_close">Close</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">选择人员</h4>
                    </div>
                    <div class="modal-body" id="select_content" style="padding-top: 0px;padding-bottom: 0px;">
                        <div class="page js_show" style="position: relative;">
                            <div class="page__bd">
                                <div class="weui-search-bar" id="searchBar">
                                <form class="weui-search-bar__form">
                                    <div class="weui-search-bar__box">
                                        <i class="weui-icon-search"></i>
                                        <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="请输入姓名或拼音缩写搜索" required/>
                                        <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
                                    </div>
                                    <label class="weui-search-bar__label searchCenter" id="searchText">
                                        <i class="weui-icon-search"></i>
                                        <span>请输入姓名或拼音缩写搜索</span>
                                    </label>
                                </form>
                                <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">搜索</a>
                            </div>
                                <div class="weui-cells searchbar-result" id="searchResult" style="margin-top: 0px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default copy_to_close"   data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-success" id="pre-level" data-pid="">上一级</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal END-->
        <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" width="100%">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only">Close</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">评论内容：</h4>
                    </div>
                    <div class="modal-body" id="select_content" style="padding-top: 0px;padding-bottom: 0px;">
                        <div class="page js_show" style="position: relative;">
                            <div class="page__bd">
                                <textarea name="comment_content" id="comment_content" class="comment" data-aid="{$aid}" placeholder="请输入评论内容;
评论内容可@指定人;
@指定人未读每30分钟自动提醒;
无指定默认@所有人（含抄送）;
任意流程均可评论;" rows="6" cols="30"></textarea> {__TOKEN__}
                            </div>
                        </div>
                        <div class="weui-tabbar" style="padding-top: 8px;position: initial;">
                            <a href="#" class="weui-tabbar__item" style="text-decoration: none;">
                                <p class="weui-tabbar__label" style="font-size: 15px;color:black;" id="btn-at">
                                    <span class="glyphicon" aria-hidden="true" style="margin-right: 5px;"></span>@ 指定人</p>
                            </a>
                            <a href="javascript:;" class="weui-tabbar__item" id="btn-face">
                                <p class="weui-tabbar__label" style="font-size: 15px;color:black;">
                                    <span class="glyphicon glyphicon-sunglasses" aria-hidden="true" style="margin-right: 5px;"></span>表情</p>
                            </a>
                            <a href="javascript:;" class="weui-tabbar__item" id="btn-img">
                                <p class="weui-tabbar__label" style="font-size: 15px;color:black;">
                                    <span class="glyphicon glyphicon-picture" aria-hidden="true" style="margin-right: 5px;"></span>图片</p>
                            </a>
                        </div>
                        <div class="page js_show" id="comment_at" style="position: relative;display: none;">
                            <div class="page__bd">
                                <div class="weui-cells" id="" style="margin-top: 5px;margin-bottom: 5px;">
                                    <div class="weui-uploader">
                                        <div class="weui-uploader__bd" style="margin-right: 0px;margin-bottom: 0px;padding-top: 12px;">
                                            <ul class="weui-uploader__files" id="selectCommentUser" style="margin-bottom: 0px;">
                                            </ul>
                                            <input type="hidden" name="comment_to_id" id="comment_to_id">
                                        </div>
                                    </div>
                                </div>

                                <div class="weui-cells searchbar-result" id="commentSearchResult" style="margin-top: 0px;">
                                </div>
                            </div>
                        </div>
                        <div class="page js_show" id="comment_img" style="position: relative;display: none;">
                            <div class="page__bd">
                                <div class="weui-cell">
                                    <div class="weui-cell__bd">
                                        <div class="weui-uploader">
                                            <div class="weui-uploader__hd">
                                                <p class="weui-uploader__title" style="margin-bottom: 0px;">图片上传</p>
                                                <div class="weui-uploader__info">
                                                    <span id="upload_nums">0</span>/9</div>
                                            </div>
                                            <div class="weui-uploader__bd">
                                                <ul class="weui-uploader__files" id="uploaderFiles" style="margin-bottom: 0px;">
                                                </ul>
                                                <div class="weui-uploader__input-box">
                                                    <input onclick="imgUpload()" class="weui-uploader__input"/>
                                                    <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" name="file_image[]" multiple style="display: none;" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="file_names" id="file_names">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-success" id="comment-send">发送</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal END-->
        <!-- Modal -->
        <div class="modal fade" id="myModal3" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"
            width="100%">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only ">Close</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">信息详情</h4>
                    </div>
                    <div class="modal-body" id="select_content" style="padding-top: 0px;padding-bottom: 0px;">
                        <div class="page js_show" style="position: relative;">
                            <div class="page__bd">
                                <div class="weui-flex">
                                    <div class="weui-flex__item"><div index='read' class="placeholder ready-btn ready-btn-on ready-btn-read">已读</div></div>
                                    <div class="weui-flex__item"><div index='noread' class="placeholder ready-btn">未读</div></div>
                                </div>
                                <div class="weui-cells searchbar-result" id="readHtml" style="margin-top: 0px;">
                                        
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default " data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal END-->            
        <!--BEGIN dialog-->
        <div id="dialogs">
            <div class="js_dialog" id="iosDialog" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__hd">
                        <strong class="weui-dialog__title">是否删除抄送人</strong>
                    </div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="dialog_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                        <a href="javascript:;" onclick="dialog_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                    </div>
                </div>
            </div>
        
            <!-- 撤销记录 -->
            <div class="js_dialog" id="iosDialog_delete" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__hd">
                        <strong class="weui-dialog__title" style="color: #f12e2e" id="delete_cue"></strong>
                    </div>
                    <div class="weui-dialog__hd">
                        <strong class="weui-dialog__title">
                            <textarea class="weui-textarea" name="reason"  id="delete_reason" placeholder="请输入撤销理由至少5个字" rows="2"></textarea>
                        </strong>
                    </div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="dialog_delete_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                        <a href="javascript:;" onclick="dialog_delete_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                    </div>
                </div>
            </div>

            <if condition="(($apply.stat eq 0)) AND (($isApplyer eq 1) OR ($isApplyUser eq 1) OR ($isPasser eq 1) OR ($isCopyto eq 1))">
            <!-- 催审记录 -->
            <div class="js_dialog" id="iosDialog_urge" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__hd">
                        <strong class="weui-dialog__title" style="color: #f12e2e" id="urge_cue"></strong>
                    </div>
                    <div class="weui-dialog__hd">
                            <strong class="weui-dialog__title">
                                <textarea class="weui-textarea" name="reason"  id="urge_reason" placeholder="请输入催审理由至少5个字" rows="2"></textarea>
                            </strong>
                    </div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="dialog_urge_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                        <a href="javascript:;" onclick="dialog_urge_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                    </div>
                </div>
            </div>
        </if>
            <div class="js_dialog" id="iosDialog_alert" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__bd" id="alert_content">错误</div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="dialog_alert_close()" class="weui-dialog__btn weui-dialog__btn_primary">知道了</a>
                    </div>
                </div>
            </div>
            <div class="js_dialog" id="iosDialog_comment_del" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__hd">
                        <strong class="weui-dialog__title">是否删除评论人</strong>
                    </div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="dialog_comment_del_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                        <a href="javascript:;" onclick="dialog_comment_del_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                    </div>
                </div>
            </div>
            <div class="js_dialog" id="iosDialog_approve_del" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__hd">
                        <strong class="weui-dialog__title">是否删除审批评论人</strong>
                    </div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="dialog_approve_del_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                        <a href="javascript:;" onclick="dialog_approve_del_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                    </div>
                </div>
            </div>
            <div class="js_dialog" id="iosDialog_comment_record_del" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__hd">
                        <strong class="weui-dialog__title">是否删除评论</strong>
                    </div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="dialog_comment_record_del_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                        <a href="javascript:;" onclick="dialog_comment_record_del_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                    </div>
                </div>
            </div>
            <div class="js_dialog" id="iosDialog_proc_del" style="display: none;">
                <div class="weui-mask"></div>
                
                <div class="weui-dialog">
                    <div class="weui-dialog__hd">
                        <strong class="weui-dialog__title">是否撤回该审批</strong>
                    </div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="dialog_proc_del_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                        <a href="javascript:;" onclick="dialog_proc_del_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                    </div>
                </div>
            </div>
            <div class="js_dialog" id="iosDialog_sign" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__hd">
                        <strong class="weui-dialog__title" style="color: #f12e2e" id="delete_cue">签收推送</strong>
                    </div>
                    <div class="weui-dialog__bd" style="color: #333">
                        发送信息至手机端签收？
                    </div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="dialog_sign_close()" class="weui-dialog__btn weui-dialog__btn_default">取消</a>
                        <a href="javascript:;" onclick="dialog_sign_confirm()" class="weui-dialog__btn weui-dialog__btn_primary">确认</a>
                    </div>
                </div>
            </div>
        </div>
        <!--END dialog-->
         <!--BEGIN dialog-->
        
            <div class="js_dialog" id="knowDialog" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__bd">图片布局方向须朝上！</div>
                    <div class="weui-dialog__ft">
                        <a href="javascript:;" onclick="dialog_iknow()" class="weui-dialog__btn weui-dialog__btn_primary">知道了</a>
                    </div>
                </div>
            </div>

            <div class="js_dialog" id="imgDialog" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__bd" style="padding:15px;color:#f12e2e;">签名预览</div>
                    <div class="weui-dialog__bd"><img id="signImg" src="" style="width: 100%;" > </div>
                    <div class="weui-dialog__ft"> 
                        <a href="javascript:;" onclick="dialog_image()" class="weui-dialog__btn weui-dialog__btn_primary">关闭</a>
                        <a href="javascript:;"  style="color:#f12e2e;" onclick="dialog_image_del()" class="weui-dialog__btn weui-dialog__btn_primary">重签</a>
                    </div>
                </div>
            </div>
            <div class="js_dialog" id="imgDialogSure" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__bd" style="padding:15px;color:#f12e2e;">签名预览</div>
                    <div class="weui-dialog__bd"><img id="signImgSure" src="" style="width: 100%;" > </div>
                    <div class="weui-dialog__ft"> 
                        <a href="javascript:;" onclick="jSignatureTest()" class="weui-dialog__btn weui-dialog__btn_primary">提交</a>
                        <a href="javascript:;" style="color:#f12e2e;" onclick="dialog_imageSure_del()"  class="weui-dialog__btn weui-dialog__btn_primary">重签</a>
                    </div>
                </div>
            </div>
            <div class="js_dialog" id="refuseDialog" style="display: none;">
                <div class="weui-mask"></div>
                <div class="weui-dialog">
                    <div class="weui-dialog__bd" style="padding:15px;color:#f12e2e;">退审确认</div>
                    <div class="weui-dialog__bd">确定要将此申请退审？</div>
                    <div class="weui-dialog__ft"> 
                        <a href="javascript:;" onclick="dialog_refuse_cal()" class="weui-dialog__btn weui-dialog__btn_primary">取消</a>
                        <a href="javascript:;"  style="color:#f12e2e;" onclick="dialog_refuse()" class="weui-dialog__btn weui-dialog__btn_primary">确定</a>
                    </div>
                </div>
            </div>
    <!-- END dialog -->
    </div>
    <div class="other_page" id="other_page" style="display: none;    
                                                        position: absolute;
                                                        left: 0;
                                                        top: 0;
                                                        height: 100%;
                                                        width: 100%;
                                                        z-index: 999;">
    <div class="container">
        
        <div class="page tabbar js_show">
            <div class="page__bd" id="sign_height">
                <div class="weui-tab">
                    <div class="weui-tab__panel" style="padding: 0">
                            <fieldset style="border: none ; width: 100%; height: 100%;background: #fff;">
                                    
                                    <div id="signature" style="height: 100%;">
                                    </div>
                                </fieldset>
                    </div>
                    <div class="weui-tabbar" id="sign-tab" style="bottom:auto;">
                        <a href="javascript:;" class="weui-tabbar__item">
                                <span href="javascript:;"  onclick="imgDialogSure()" style="padding:5px 15px;margin: 6px;" class="weui-btn weui-btn_mini weui-btn_primary">确定</span>
                        </a>
                        <a href="javascript:;" class="weui-tabbar__item">
                                <span href="javascript:;"  onclick="reset()" style="padding:5px 15px;margin: 6px;"  class="weui-btn weui-btn_mini weui-btn_warn">清屏</span>
                        </a>
                        <a href="javascript:;" class="weui-tabbar__item">
                                <span href="javascript:;"  onclick="FadeOutImage()" style="padding:5px 15px;margin: 6px;"  class="weui-btn weui-btn_mini weui-btn_default">取消</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    </div>
</body>


<script src="__PUBLIC__/assets/js/jquery-1.11.1.min.js"></script>
<script src="__PUBLIC__/assets/js/bootstrap.min.js"></script>
<!-- <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script> -->
<script src="__PUBLIC__/assets/js/exif.js"></script>
<script src="__PUBLIC__/assets/jSignature/flashcanvas.js" type="text/javascript"></script>
<script src="__PUBLIC__/assets/jSignature/jSignature.min.js" type="text/javascript"></script>
<script src="__PUBLIC__/assets/js/viewer.js"></script>
<!-- <script src="__PUBLIC__/assets/js/vconsole.min.js"></script> -->

<script>
    var ishttps = 'https:' == document.location.protocol ? true : false;
    if(ishttps == false){
        httpsUrl = document.location.href;
        httpsUrl = httpsUrl.replace('http:',"https:");
        window.location.href = httpsUrl;
    }
    // 自动催审信息 收起
    $('#up').click(function(){
        var upflag = $(this).text();
        if(upflag == '展开'){
            $('.dn').show();
            $(this).text('收起');
        }else{
            $('.dn').hide();
            $(this).text('展开');
        }
        
    });
    // 已读未读 
    $('.ready-btn').click(function(){
        $('.ready-btn').removeClass('ready-btn-on');
        $(this).addClass('ready-btn-on');
        var param = $(this).attr('index');
        getReadMan(param);
    });

    var comment_id = '';
    $('.comment_id').click(function(){
        comment_id = $(this).attr('index');
        $('.ready-btn').removeClass('ready-btn-on');
        $('.ready-btn-read').addClass('ready-btn-on');
        getReadMan('read');
    });
   
    function getReadMan(param){
        var $dtoast = $('#doingToast');
        $('#doing').text('加载中...');
        $('#readHtml').html('<div class="weui-loadmore"><i class="weui-loading"></i><span class="weui-loadmore__tips">正在加载</span></div>');
        $.post("{:U('Light/Apply/getReadMan')}",
            {
                comment_id: comment_id,
                param     : param,
                mod_name  : "{$mod_name}",
                system    : "{$system}",
            }, function (data) {
                 $('#readHtml').html(data);
            }
        );
    }
    // 查看插件
    $(function () { 
        $('#viewer').viewer({
            url: 'data-original',
        });
        $('.viewer').viewer({
            url: 'data-original',
        });
    });

    // if(window.name != "bencalie"){
    //     location.reload();
    //     window.name = "bencalie";
    // }
    // else{
    //     window.name = "";
    // }
    // 强制横屏
    var signoutput_file = ''; 
    
    // 签名设置
    function reset() {
            var $sigdiv = $("#signature");
            $sigdiv.jSignature("reset");
        }
    function jSignatureTest() {
        $('#imgDialogSure').fadeOut();
        var $sigdiv = $("#signature");
        var datapair = $sigdiv.jSignature("getData", "image"); //设置输出的格式，具体可以参考官方文档
        $('#signImg').attr('src',"data:" + datapair[0] + "," + datapair[1]);  
        upImage("data:" + datapair[0] + "," + datapair[1]);
    } 
    // 签名上传
    function upImage(img){
        
        var $dtoast = $('#doingToast');
        $('#doing').text('签名上传中...');
        $dtoast.fadeIn(100);
        $.post("{:U('Light/Apply/upImage')}",
            {
                "img": img,
                system: "{$system}"
            }, function (data) {
                // console.log(data);
                if (data.code == 200) {
                    $('#doing').text('上传成功');
                    signoutput_file = data.data.output_file;
                    $('#btn-yl-div').show();
                    $('#btn-qz-div').hide();
                    $('#other_page').fadeOut();
                } else {
                    $('#doing').text('上传失败！');
                }
                $('#imgDialog').fadeOut();
                $dtoast.fadeOut(1000);
            }
        );
    } 
    // 签名预览
    function dialog_image_del(){
        signoutput_file = '';
        reset();
        $('#btn-yl-div').hide();
        $('#btn-qz-div').show();
        $('#other_page').fadeIn();
        $('#imgDialog').fadeOut();
    }

    // 签名确定
    function imgDialogSure(){
        $('#imgDialogSure').fadeIn();
        var $sigdiv = $("#signature");
        var datapair = $sigdiv.jSignature("getData", "image"); //设置输出的格式，具体可以参考官方文档
        $('#signImgSure').attr('src',"data:" + datapair[0] + "," + datapair[1]); 
    }
    // 退审确认 取消按钮
    function dialog_refuse_cal(){
            $('#refuseDialog').fadeOut();
    }
    // 退审确认 确定按钮
    function dialog_refuse(){
        applySubmit('apply-refuse');
    }
    function dialog_imageSure_del(){
        $('#imgDialogSure').fadeOut();
        reset();
    }
    //提交方法
    function applySubmit(type){
        if(type.length == 0) {
            $("#alert_content").text('提交失败，请联系信息中心');
            $("#iosDialog_alert").show();
            return false;
        }
        var option = 0;
        $('#signImg').attr('src');
        //审批值传入
        var comment = $("#comment").val();
        var apply_user = $("#apply_user").val();
        var copyto_id = $("#copyto_id").val();
        var id = $("#aid").val();
        var hash = $(":input[name='__hash__']").val();
        var approve_id = $("#approve_to_id").val();
            //console.log(approve_id);
            // 审批类型
        if (type == "apply-agree") {
            option = 2;
        } else {
            option = 1;
        }
        // 退审无需签字
        if(option == 2){
            // 签名判断
            if("{$mod_name}" == 'CostMoney'  || "{$mod_name}" == 'CgfkApply' || "{$mod_name}" == 'PjCgfkApply' || "{$mod_name}" == 'WlCgfkApply' || "{$mod_name}" == 'SalesRefundApply'|| "{$mod_name}" == 'ClientStatementApply' ){
                if('{$ismoble}'=='false'){
                    return $("#iosDialog_sign").show();
                }
                if(signoutput_file == ''){
                    $("#alert_content").text('请先签字！');
                    $("#iosDialog_alert").show();
                    return false;
                }
            }
        }
        $('#loadingToast').fadeIn(100);
        //保存数据
        $.ajax({
            type: "POST",
            url: "{:U('Light/WorkFlowOpTv/WorkFlowSubmit')}",
            dataType: "json",
            data: {
                id: id,
                approve_id:approve_id,
                mod_name: "{$mod_name}",
                system: "{$system}",
                signoutput_file:signoutput_file,
                apply_user: apply_user, //中文申请人姓名，用于发送审批结果 
                option: option,
                copyto_id: copyto_id,
                word: comment,
                status: "submit",
                __hash__: hash
            },
            complete: function (data) {
                //审批完成后操作
                // alert('审批通过');
                // console.log(data);
                $('#loadingToast').hide();
                var $toast = $('#toast');
                if ($toast.css('display') != 'none') return;

                $toast.fadeIn(100);
                // console.log(id);
                setTimeout(function () {
                    $toast.fadeOut(100);
                    window.location = "{:U('Light/Apply/applyInfo?aid=')}" + id + "&modname=" + '{$mod_name}' + "&system=" + '{$system}';
                }, 500);
            }
        });
    }
    // 签名催收 隐藏
    function dialog_sign_close(){
        $("#iosDialog_sign").hide();
    }
    $("#comment").val("{$per_word}");
    // 签名催收 确定
    function dialog_sign_confirm(){
        var comment = $("#comment").val();
        var id = $("#aid").val();
        var apply_user = $("#apply_user").val();
        var hash = $(":input[name='__hash__']").val();
        
        $("#iosDialog_sign").hide();
        $('#loadingToast').fadeIn(100);
        $.ajax({
            type: "POST",
            url: "{:U('Light/Apply/signUrge')}",
            dataType: "json",
            data: {
                id: id,
                mod_name: "{$mod_name}",
                system: "{$system}",
                apply_user: apply_user, //中文申请人姓名，用于发送审批结果 
                word: comment,
                __hash__: hash
            },
            complete: function (data) {
                $('#loadingToast').hide();   
                window.reload();
            }
        });

    }
    function dialog_image(){
        $('#imgDialog').fadeOut();
    }
   $('#btn-yl').click(function(){
        $('#imgDialog').fadeIn();
   });
   $('#btn-qz').click(function(){
        if('{$ismoble}'=='false') return  $("#iosDialog_sign").show();
        $("#alert_content").text('建议使用横屏签名！');
        $("#iosDialog_alert").show();
        $('#other_page').fadeIn();
    
        // 屏幕大小判断
        var screenHeight,screenWidth;
        if (document.body.clientHeight > document.body.clientWidth) {
            screenHeight = document.body.clientWidth;
            screenWidth = document.body.clientHeight;
        } else {
            screenHeight = document.body.clientHeight;
            screenWidth = document.body.clientWidth;
        }
        var arguments = {
            width: screenWidth*1.1,
            height: screenHeight*0.63,
            signatureLine: false,//去除默认画布上那条横线
            lineWidth: '4',
            'decor-color':'#ffffff'
        };
        $("#signature").jSignature(arguments);
   });


   function FadeOutImage(){
        $('#other_page').fadeOut();
        $('#signature').html('');
   }


     $('input').attr('autocomplete','off');
    // Global var
    var $li_dom = '';
    var $li_dom_comment = '';
    var $li_dom_comment_record = '';
    var loading = '<div class="weui-loadmore"><i class="weui-loading"></i><span class="weui-loadmore__tips">正在加载</span></div>';
    var noresult = '<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无数据</span></div>';
    // Close dialog
    function dialog_comment_del_close() {
        $("#iosDialog_comment_del").fadeOut(100);
    }
    // Confirm dialog
    function dialog_comment_del_confirm() {

        var id = $li_dom_comment.attr("id");
        // console.log(id);
        var ids = $("#comment_to_id").val() + ",";
        var old_ids_arr = ids.split(",");
        var id_str = '';
        var location = $.inArray(id, old_ids_arr);
        // // console.log(old_name_arr);
        if (location >= 0) {
            var repl_id = ',' + id + ',';
            id_str = ids.replace(repl_id, ',');
        }
        $("#comment_to_id").val(id_str);
        $li_dom_comment.remove();
        $("#iosDialog_comment_del").fadeOut(100);
    }
    // Close dialog
    function dialog_approve_del_close() {
        $("#iosDialog_approve_del").fadeOut(100);
    }
    // Confirm dialog
    function dialog_approve_del_confirm() {

        var id = $li_dom_comment.attr("id");
        // console.log(id);
        var ids = $("#approve_to_id").val() + ",";
        var old_ids_arr = ids.split(",");
        var id_str = '';
        var location = $.inArray(id, old_ids_arr);
        // // console.log(old_name_arr);
        if (location >= 0) {
            var repl_id = ',' + id + ',';
            id_str = ids.replace(repl_id, ',');
        }
        $("#approve_to_id").val(id_str);
        $li_dom_comment.remove();
        $("#iosDialog_approve_del").fadeOut(100);
    }
    // Close dialog
    function dialog_close() {
        $("#iosDialog").fadeOut(100);
    }
    // Confirm dialog
    function dialog_confirm() {
        var id = $li_dom.attr("id");
        // console.log(id);
        var ids = $("#copyto_id").val() + ",";
        var old_ids_arr = ids.split(",");
        var id_str = '';
        var location = $.inArray(id, old_ids_arr);
        // // console.log(old_name_arr);
        if (location >= 0) {
            var repl_id = ',' + id + ',';
            id_str = ids.replace(repl_id, ',');
        }
        $("#copyto_id").val(id_str);
        $li_dom.remove();
        $("#iosDialog").fadeOut(100);
    }
    // Close dialog
    function dialog_urge_close() {
        $("#iosDialog_urge").fadeOut(100);
        $('#urge_cue').text('');
    }
    // Confirm dialog
    function dialog_urge_confirm() {
        var $reason = $('#urge_reason').val();
        if($reason.length <5) return $('#urge_cue').text('催审理由至少5个字');
        $("#iosDialog_urge").fadeOut(100);
        var aid = $('#comment_content').attr('data-aid');
        var $dtoast = $('#doingToast');
        if ($dtoast.css('display') != 'none') return;
        $('#doing').text('发送中...');
        $dtoast.fadeIn(100);
        $.post("{:U('Light/WorkFlow/urgeWorkFlow')}",
            {
                "aid": aid,
                "mod_name": "{$mod_name}",
                "system": "{$system}",
                "reason":$reason
            }, function (data) {
                // console.log(data);
                if (data == 'success') {
                    $("#alert_content").text('催审成功');
                } else if (data == 'sended') {
                    $("#alert_content").text('24小时内只能催审1次！');
                } else {
                    // alert('催审错误！');
                    $("#alert_content").text('催审错误！');
                }
                $("#iosDialog_alert").show();
                $dtoast.fadeOut(1000);
            }
        );
    }
    // 回复信息
    $('.reply').click(function(){
        $("#comment_to_id").val('');
        $("#selectCommentUser").empty();
        $("#comment_at").fadeIn(200);

        var id = $(this).attr('wxid');
        var name = $(this).attr('realname');
        var img = $(this).attr('avatar');
        // 重复点击
        var ids = $("#comment_to_id").val() + ",";
        var old_ids_arr = ids.split(",");
        if($.inArray(id,old_ids_arr)!=-1){
            return false;
        }
        var ids = $("#comment_to_id").val() + "," + id;
        var comment_content = $("#comment_content").val();
        var new_comment_content = "";
        // new_comment_content = comment_content+'@'+name;
        // $("#comment_content").val(new_comment_content);
        var tmpl = '<li class="weui-uploader__file wk-comment__user" id="#id#" "><img src="#url#" class="weui-selet__user" style="margin-bottom: 0px;margin-right: 6px;" /><span style="margin-right: 6px;font-size: 14px;">#name#</span><span class="weui-badge" style="position: relative;top: -5.8em;right: -1.4em;">X</span></li>';
        // console.log(id);
        tmpl = tmpl.replace('#id#', id);
        tmpl = tmpl.replace('#name#', name);
        $("#selectCommentUser").append($(tmpl.replace('#url#', img)));
        $("#comment_to_id").val(ids);
    });
    // Close comment record del dialog
    function dialog_comment_record_del_close() {
        $("#iosDialog_comment_record_del").fadeOut(100);
    }
    // Confirm comment record del dialog
    function dialog_comment_record_del_confirm() {
        $("#iosDialog_comment_record_del").fadeOut(100);
        var id = $li_dom_comment_record.attr('data-id');
        var $dtoast = $('#doingToast');
        if ($dtoast.css('display') != 'none') return;
        $('#doing').text('删除中...');
        $dtoast.fadeIn(100);
        $.post("{:U('Light/Apply/delCommentRecord')}",
            {
                "id": id,
                system: "{$system}"
            }, function (data) {
                // console.log(data);
                if (data == 'success') {
                    $('#doing').text('删除成功');
                    $li_dom_comment_record.parent().parent().parent().css('display', 'none');
                } else {
                    $('#doing').text('删除错误！');
                }
                $dtoast.fadeOut(1000);
            }
        );
    }
// 图片压缩
var filechooser = document.getElementById("uploaderInput");
    $("#comment_img").css({'display':'none'});
    $("#btn-img").on('click',function(){
        $("#comment_img").toggle(200);
        if ($("#comment_img").css('display') != 'none') {

        }
    })
    // 触发上传机制
    function imgUpload(){
        $("#knowDialog").fadeIn(100);
    }

    // 内容提示(知道了)
    function dialog_iknow(){
        $("#knowDialog").fadeOut(100);
        
        filechooser.click();
    }

    

    // Close dialog
  //    用于压缩图片的canvas
  var canvas = document.createElement("canvas");
    var ctx = canvas.getContext('2d');
    //    瓦片canvas
    var tCanvas = document.createElement("canvas");
    var tctx = tCanvas.getContext("2d");
    var maxsize = 100 * 1024;
    var img_num = 0;
    var imgIndex = "",
        imgdom = "";
    $("#upload").on("click", function () {
        filechooser.click();
    }).on("touchstart", function () {
            $(this).addClass("touch")
        })
        .on("touchend", function () {
            $(this).removeClass("touch")
        });
    filechooser.onchange = function () {
        if (!this.files.length) return;
        var files = Array.prototype.slice.call(this.files);
        if (files.length > 9 || img_num > 8) {
            alert("最多只可上传9张图片");
            return;
        }
        files.forEach(function (file, i) {
            if (!/\/(?:jpeg|png|gif)/i.test(file.type)) return;
            // console.log(file);
            // console.log(i);
            // console.log(Orientation);
            var reader = new FileReader();
            var li = document.createElement("li");
            //          获取图片大小
            var size = file.size / 1024 > 1024 ? (~~(10 * file.size / 1024 / 1024)) / 10 + "MB" : ~~(file.size / 1024) + "KB";
            // li.innerHTML = '<div class="progress"><span></span></div><div class="size">' + size + '</div>';
            li.innerHTML = '<div class="weui-uploader__file-content"></div>';
            $(li).addClass("weui-uploader__file weui-uploader__file_status");
            $("#uploaderFiles").append($(li));
            reader.onload = function () {
                var result = this.result;
                var img = new Image();
                img.src = result;
                $(li).css("background-image", "url(" + result + ")");

                //如果图片大小小于100kb，则直接上传
                if (result.length <= maxsize) {
                    img = null;
                    // TODO：这里没有做图片旋转，小于100K可能会有问题
                    upload(result, file.type, $(li), i);
                    return;
                }
                //      图片加载完毕之后进行压缩，然后上传
                if (img.complete) {
                    callback();
                } else {
                    img.onload = callback;
                }

                function callback() {
                    //获取照片方向角属性，用户旋转控制  
                    EXIF.getData(file, function () {
                        Orientation = EXIF.getTag(this, 'Orientation');
                        // alert(Orientation);
                        var data = compress(img, Orientation);
                        upload(data, file.type, $(li), i);
                        img = null;
                    });
                }
            };
            reader.readAsDataURL(file);
        })
    };
    //对图片旋转处理 added by lzk  
    function rotateImg(img, direction, canvas) {
        // alert(img);  
        //最小与最大旋转方向，图片旋转4次后回到原方向    
        var min_step = 0;
        var max_step = 3;
        //var img = document.getElementById(pid);    
        if (img == null) return;
        //img的高度和宽度不能在img元素隐藏后获取，否则会出错    
        var height = img.height;
        var width = img.width;
        //var step = img.getAttribute('step');    
        var step = 2;
        if (step == null) {
            step = min_step;
        }
        if (direction == 'right') {
            step++;
            //旋转到原位置，即超过最大值    
            step > max_step && (step = min_step);
        } else {
            step--;
            step < min_step && (step = max_step);
        }
        //img.setAttribute('step', step);    
        /*var canvas = document.getElementById('pic_' + pid);   
        if (canvas == null) {   
            img.style.display = 'none';   
            canvas = document.createElement('canvas');   
            canvas.setAttribute('id', 'pic_' + pid);   
            img.parentNode.appendChild(canvas);   
        }  */
        //旋转角度以弧度值为参数    
        var degree = step * 90 * Math.PI / 180;
        // var ctx = canvas.getContext('2d');
        // console.log(step);
        switch (step) {
            case 0:
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0);
                break;
            case 1:
                canvas.width = height;
                canvas.height = width;
                ctx.rotate(degree);
                ctx.drawImage(img, 0, -height);
                break;
            case 2:
                canvas.width = width;
                canvas.height = height;
                ctx.rotate(degree);
                ctx.drawImage(img, -width, -height);
                break;
            case 3:
                canvas.width = height;
                canvas.height = width;
                ctx.rotate(degree);
                ctx.drawImage(img, -width, 0);
                break;
        }
    }
    //    使用canvas对大图片进行压缩
    function compress(img, Orientation) {
        var initSize = img.src.length;
        var width = img.width;
        var height = img.height;
        //如果图片大于四百万像素，计算压缩比并将大小压至400万以下
        var ratio;
        if ((ratio = width * height / 4000000) > 1) {
            ratio = Math.sqrt(ratio);
            width /= ratio;
            height /= ratio;
        } else {
            ratio = 1;
        }
        canvas.width = width;
        canvas.height = height;
        //        铺底色
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        //如果图片像素大于100万则使用瓦片绘制
        var count;
        if ((count = width * height / 1000000) > 1) {
            count = ~~(Math.sqrt(count) + 1); //计算要分成多少块瓦片
            //            计算每块瓦片的宽和高
            var nw = ~~(width / count);
            var nh = ~~(height / count);
            tCanvas.width = nw;
            tCanvas.height = nh;
            for (var i = 0; i < count; i++) {
                for (var j = 0; j < count; j++) {
                    tctx.drawImage(img, i * nw * ratio, j * nh * ratio, nw * ratio, nh * ratio, 0, 0, nw, nh);
                    ctx.drawImage(tCanvas, i * nw, j * nh, nw, nh);
                }
            }
        } else {
            ctx.drawImage(img, 0, 0, width, height);
        }

        // console.log(Orientation);

        if (navigator.userAgent.match(/iphone/i)) {
            console.log('iphone');
            //alert(expectWidth + ',' + expectHeight);  
            //如果方向角不为1，都需要进行旋转 added by lzk  
            if (Orientation != "" && Orientation != 1) {
                console.log('旋转处理');
                switch (Orientation) {
                    case 6://需要顺时针（向左）90度旋转  
                        console.log('需要顺时针（向左）90度旋转');
                        rotateImg(img, 'left', canvas);
                        break;
                    case 8://需要逆时针（向右）90度旋转  
                        console.log('需要顺时针（向右）90度旋转');
                        rotateImg(img, 'right', canvas);
                        break;
                    case 3://需要180度旋转  
                        console.log('需要180度旋转');
                        rotateImg(img, 'right', canvas);//转两次  
                        rotateImg(img, 'right', canvas);
                        break;
                }
            }
        } else {
            //alert(Orientation);  
            if (Orientation != "" && Orientation != 1) {
                //alert('旋转处理');  
                switch (Orientation) {
                    case 6://需要顺时针（向左）90度旋转  
                        console.log('需要顺时针（向左）90度旋转');
                        rotateImg(img, 'left', canvas);
                        break;
                    case 8://需要逆时针（向右）90度旋转  
                        console.log('需要顺时针（向右）90度旋转');
                        rotateImg(img, 'right', canvas);
                        break;
                    case 3://需要180度旋转  
                        console.log('需要180度旋转');
                        rotateImg(img, 'right', canvas);//转两次  
                        rotateImg(img, 'right', canvas);
                        break;
                }
            }

        }

        var srcStr = img.src;
        var img_header = srcStr.substring(0,23);
        // console.log(img_header);
        var indexSearch = img_header.indexOf('png');
        console.log(indexSearch);
        //进行最小压缩
        if(indexSearch<=0){
            var ndata = canvas.toDataURL('image/jpeg', 0.4);
        }
        else if (indexSearch>0){
            var ndata = canvas.toDataURL('image/jpeg', 0.4);//'image/png'
        }
        // console.log('压缩前：' + initSize);
        // console.log('压缩后：' + ndata.length);
        // console.log('压缩率：' + ~~(100 * (initSize - ndata.length) / initSize) + "%");
        tCanvas.width = tCanvas.height = canvas.width = canvas.height = 0;
        return ndata;
    }
    //    图片上传，将base64的图片转成二进制对象，塞进formdata上传
    function upload(basestr, file, $li, i) {
        var text = window.atob(basestr.split(",")[1]);
        // var buffer = new Uint8Array(text.length);
        var pecent = 0,
            loop = null;
        // for (var i = 0; i < text.length; i++) {
        //     buffer[i] = text.charCodeAt(i);
        // }
        // var blob = getBlob([buffer], type);
        var xhr = new XMLHttpRequest();
        var formdata = getFormData();
        // console.log(blob);
        // formdata.append('imagefile', blob);
        formdata.append('imagefile', basestr);
        formdata.append('order', i);
        u = "{:U('Light/Apply/commentUploadBaseImg')}";
        xhr.open('post', u);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var jsonData = JSON.parse(xhr.responseText);
               
                var imagedata = jsonData[0] || {};
                var text = imagedata.path ? '上传成功' : '上传失败';
                
                console.log(text + '：' + imagedata.path);
                clearInterval(loop);
                //当收到该消息时上传完毕
                // $li.find(".weui-uploader__file-content").animate({ 'width': "100%" }, pecent < 95 ? 200 : 0, function() {
                //     $(this).html(text);
                // });
                $li.find(".weui-uploader__file-content").html("");
                $li.find(".weui-uploader__file-content").parent().removeClass("weui-uploader__file_status");
                img_num++;
                $("#upload_nums").text(img_num);
                var file_names = $("#file_names").val() + imagedata.output_file + "|";
                $("#file_names").val(file_names);
               
                if (!imagedata.path) return;
                // $(".pic-list").append('<a href="' + imagedata.path + '">' + imagedata.name + '（' + imagedata.size + '）<img src="' + imagedata.path + '" /></a>');
            }
        };
        //数据发送进度，前50%展示该进度
        xhr.upload.addEventListener('progress', function (e) {
            if (loop) return;
            pecent = ~~(100 * e.loaded / e.total) / 2;
            // $li.find(".weui-uploader__file-content").css('width', pecent + "%");
            $li.find(".weui-uploader__file-content").html(pecent + "%");
            if (pecent == 50) {
                mockProgress();
            }
        }, false);
        //数据后50%用模拟进度
        function mockProgress() {
            if (loop) return;
            loop = setInterval(function () {
                pecent++;
                // $li.find(".weui-uploader__file-content").css('width', pecent + "%");
                $li.find(".weui-uploader__file-content").html(pecent + "%");
                console.log(pecent);
                if (pecent == 99) {
                    clearInterval(loop);
                }
            }, 100)
        }
        xhr.send(formdata);

        $(".weui-uploader__file").on('click',function(){
            imgIndex = $(this).index();
            imgdom = $(this);
            // console.log(imgIndex);
        })

        $(".weui-gallery__del").on('click',function(){
            // 是否删除该图
            $("#iosDialog_imgDel").fadeIn(100);
        })

    }

    // 取消图片删除
    function dialog_close_imgdelete(){
        $("#iosDialog_imgDel").fadeOut(100);
    }
    // 确认图片删除
    function dialog_confirm_imgdelete(){
        imgdom.remove();
        var file_names_str = $("#file_names").val();
        var file_names_arr = file_names_str.split("|");
        file_names_arr.splice(imgIndex, 1);
        var file_str_1 = file_names_arr.toString();
        var file_str_2=file_str_1.replace(/,/g,"|");
        // console.log(file_str_2);
        $("#file_names").val(file_str_2);
        $("#iosDialog_imgDel").fadeOut(100);
    }

    /**
     * 获取blob对象的兼容性写法
     * @param buffer
     * @param format
     * @returns {*}
     */
    function getBlob(buffer, format) {
        try {
            return new Blob(buffer, { type: format });
        } catch (e) {
            var bb = new (window.BlobBuilder || window.WebKitBlobBuilder || window.MSBlobBuilder);
            buffer.forEach(function (buf) {
                bb.append(buf);
            });
            return bb.getBlob(format);
        }
    }
    /**
     * 获取formdata
     */
    function getFormData() {
        var isNeedShim = ~navigator.userAgent.indexOf('Android') &&
            ~navigator.vendor.indexOf('Google') &&
            !~navigator.userAgent.indexOf('Chrome') &&
            navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop() <= 534;
        return isNeedShim ? new FormDataShim() : new FormData()
    }
    /**
     * formdata 补丁, 给不支持formdata上传blob的android机打补丁
     * @constructor
     */
    function FormDataShim() {
        console.warn('using formdata shim');
        var o = this,
            parts = [],
            boundary = Array(21).join('-') + (+new Date() * (1e16 * Math.random())).toString(36),
            oldSend = XMLHttpRequest.prototype.send;
        this.append = function (name, value, filename) {
            parts.push('--' + boundary + '\r\nContent-Disposition: form-data; name="' + name + '"');
            if (value instanceof Blob) {
                parts.push('; filename="' + (filename || 'blob') + '"\r\nContent-Type: ' + value.type + '\r\n\r\n');
                parts.push(value);
            } else {
                parts.push('\r\n\r\n' + value);
            }
            parts.push('\r\n');
        };
        // Override XHR send()
        XMLHttpRequest.prototype.send = function (val) {
            var fr,
                data,
                oXHR = this;
            if (val === o) {
                // Append the final boundary string
                parts.push('--' + boundary + '--\r\n');
                // Create the blob
                data = getBlob(parts);
                // Set up and read the blob into an array to be sent
                fr = new FileReader();
                fr.onload = function () {
                    oldSend.call(oXHR, fr.result);
                };
                fr.onerror = function (err) {
                    throw err;
                };
                fr.readAsArrayBuffer(data);
                // Set the multipart content type and boudary
                this.setRequestHeader('Content-Type', 'multipart/form-data; boundary=' + boundary);
                XMLHttpRequest.prototype.send = oldSend;
            } else {
                oldSend.call(this, val);
            }
        };
    }

    // END => 图片上传 
    function dialog_delete_close() {
        $("#iosDialog_delete").fadeOut(100);
        $('#delete_cue').text('');
    }
    // Confirm dialog
    function dialog_delete_confirm() {
        var $reason = $('#delete_reason').val();
        if($reason.length <5) return $('#delete_cue').text('撤销理由至少5个字');
        $("#iosDialog_delete").fadeOut(100);
        var id = {$aid};
        var $dtoast = $('#doingToast');
        if ($dtoast.css('display') != 'none') return;
        $('#doing').text('撤销中...');
        $dtoast.fadeIn(100);
        $.post("{:U('Light/Apply/delRecord')}",
            {
                "id"      : id,
                'mod_name': "{$mod_name}",
                'system'  : "{$system}",
                "reason"  : $reason
            }, function (data) {
                 //console.log(data);
                if (data == 'success') {
                    $('#doing').text('撤销成功');
                    
                } else {
                    // alert('撤销错误！');
                    $('#doing').text('撤销错误！');
                }
                $dtoast.fadeOut(1000);
                // window.location = "{:U('Light/Apply/seekApply')}";
                location.reload();
            }
        );
    }

    // 审批撤回
    $('.proc_del').on('click',function(){
        $('#iosDialog_proc_del').fadeIn(100);
    })
    function dialog_proc_del_close(){
        $('#iosDialog_proc_del').fadeOut(100);
    }

    function dialog_proc_del_confirm(){
        $("#iosDialog_proc_del").fadeOut(100);
        var id = {$aid};
        var $dtoast = $('#doingToast');
        if ($dtoast.css('display') != 'none') return;
        $('#doing').text('撤销中...');
        $dtoast.fadeIn(100);
        $.post("{:U('Light/Apply/delProc')}",
            {
                "id": id,
                mod_name: "{$mod_name}",
                system: "{$system}"
            }, function (data) {
                 //console.log(data);
                if (data.code == 200) {
                    $('#doing').text('撤销成功');
                    location.reload();
                } else {
                    $("#alert_content").text(data.msg);
                    $("#iosDialog_alert").show();
                }
               
                // window.location = "{:U('Light/Apply/seekApply')}";
                
            }
        );
    }




    // Alert close
    function dialog_alert_close() {
        $("#iosDialog_alert").hide();
    }
    $(function () {
        var $selectUser = $("#selectUser");
        var $gallery = $("#gallery"),
            $galleryImg = $("#galleryImg");

        $(".imgsrc").on("click", function () {
            var src = $(this).attr('src');
            var sty = "background-image: url(" + src + ");";
            // console.log(sty);
            $galleryImg.attr("style", sty);
            $gallery.fadeIn(100);
        });
        $gallery.on("click", function () {
            $gallery.fadeOut(100);
        });

        function getDepartment(id) {
            $('#searchResult').empty();
            $('#searchResult').append(loading);
            $.post("{:U('Light/Apply/getDeptHtml')}",
                {
                    "id": id
                }, function (data) {
                    $('#searchResult').empty();
                    if (data == '') {
                        $('#searchResult').append(noresult);
                    } else {
                        $('#searchResult').append(data);
                    }
                }
            );
        }
        
        // Modal
        $('#myModal').on('show.bs.modal', function (e) {
            var id = 1;
            $("#pre-level").attr("data-pid", 0);
            getDepartment(id);
        });
        // select department
        $("#searchResult").on("click", ".select-department", function () {
            var id = $(this).attr('data-id');
            var type = $(this).attr('data-type');
            // console.log(id);
            getDepartment(id);
            $("#pre-level").attr("data-pid", id);
        });
        // select department user
        $("#searchResult").on("click", ".select-user", function () {
            // var tmpl = '<li class="weui-uploader__file weui-selet__user" style="background-image:url(#url#)" id="#id#"></li>';
            var tmpl = '<li class="weui-uploader__file wk-select__user" id="#id#" style="height:90px;"><img src="#url#" class="weui-selet__user" style="margin-bottom: 0px;margin-right: 6px;margin-top:10px;" /><span style="margin-right: 6px;font-size: 14px;">#name#</span><span class="weui-badge" style="position: relative;top: -5.8em;right: -1.4em;">X</span></li>';
            var id = $(this).attr('data-id');
            var type = $(this).attr('data-type');
            var img = $(this).attr('data-img');
            var name = $(this).attr('data-name');
            var ids = $("#copyto_id").val() + "," + id;
            // console.log(id);
            tmpl = tmpl.replace('#id#', id);
            tmpl = tmpl.replace('#name#', name);
            $selectUser.append($(tmpl.replace('#url#', img)));
            $("#copyto_id").val(ids);
            $('#searchInput').val(null);
            $('#myModal').modal('hide')
        });
        // delete copyto user
        $("#selectUser").on("click", ".wk-select__user", function () {
            $li_dom = $(this);
            $("#iosDialog").fadeIn(200);
        });

        // up pre-level
        $("#pre-level").on("click", function () {
            $('#searchResult').empty();
            $('#searchResult').append(loading);
            var pid = $(this).attr("data-pid");
            // console.log(pid);
            $.post("{:U('Light/Apply/getParentDeptHtml')}",
                {
                    "id": pid
                }, function (data) {
                    $('#searchResult').empty();
                    // console.log(data);
                    if (data == '') {
                        $('#searchResult').append(noresult);
                    } else {
                        $('#searchResult').append(data.html);
                        // console.log(data.pid);
                        $("#pre-level").attr("data-pid", data.pid);
                    }
                }
            );
        });
        
        // apply
        $("#apply-area").on("click", "#apply-agree,#apply-refuse", function () {
            var type = $(this).attr("id");
            if(type == "apply-agree"){
                applySubmit(type);
            }else{
                $('#refuseDialog').show();
            }
        });
        // apply-change
        $("#apply-change").on("click", function (e) {
            e.stopPropagation();
            var id = $("#aid").val();
            var mod_name = "{$mod_name}";
            var system = "{$system}";
            window.location = "{:U('Light/Apply/applyChange?aid=')}" + id + "&mod_name=" + mod_name + "&system=" + system;
        });
        // 催审按钮
        $("#btn-urge").on("click", function () {
            if ({$applyerID} != {$uid}) {
                // alert("非申请人不可催审！");
                $("#alert_content").text('非申请人不可催审！');
                $("#iosDialog_alert").show();
                return false;
            }
            $('#urge_cue').text('');
            $("#iosDialog_urge").fadeIn(200);
        });
        // 删除按钮
        $("#btn-delete").on("click", function () {
            if(1!={$delete}){
                if ({$applyerID} != {$uid}  ) {
                    $("#alert_content").html('非申请人不可撤销！');
                    $("#iosDialog_alert").show();
                    //alert("非申请人不可撤销！");
                    return false;
                }
            }
            // !{$isqs} &&
            if( $('#apply_status .label').eq(0).text() == '已撤销'){
                $("#alert_content").text('已撤销不可撤销！');
                $("#iosDialog_alert").show();
                //alert("非申请人不可撤销！");
                return false;
            }

            $("#iosDialog_delete").fadeIn(200);
        });

        // 保存评论
        $("#comment-send").on("click", function () {
            $('#loadingToast').fadeIn(100);
            $('#myModal2').modal('hide');
            //评论值传入
            var comment_content = $("#comment_content").val();
            var aid             = $('#comment_content').attr('data-aid');
            var ctoid           = $('#comment_to_id').val();
            var file            = $('#file_names').val();
            var hash            = $(":input[name='__hash__']").val();
            // console.log(aid);
            //保存数据
            $.ajax({
                type: "POST",
                url: "{:U('Light/Apply/saveApplyComment')}",
                dataType: "json",
                data: {
                    aid: aid,
                    ctoid: ctoid,
                    file:file,
                    mod_name: "{$mod_name}",
                    system: "{$system}",
                    word: comment_content,
                    __hash__: hash
                },
                success: function (data) {
                    //审批完成后操作
                    // alert('审批通过');
                    // console.log(data);
                    $('#loadingToast').hide();
                    var $toast = $('#toast');
                    if ($toast.css('display') != 'none') return;

                    $toast.fadeIn(100);
                    // console.log(id);
                    setTimeout(function () {
                        $toast.fadeOut(100);
                        window.location = "{:U('Light/Apply/applyInfo?aid=')}" + aid + "&modname=" + "{$mod_name}" + "&system=" + "{$system}";
                    }, 500);
                }
            });
        });

 

        // select comment user
        $("#commentSearchResult").on("click", ".select-comment-user", function () {
            var id = $(this).attr('data-id');
            var uid = $(this).attr('data-uid');
            var name = $(this).attr('data-name');
            var img = $(this).attr('data-img');
            // 重复点击
            var ids = $("#comment_to_id").val() + ",";
            var old_ids_arr = ids.split(",");
            if($.inArray(id,old_ids_arr)!=-1){
                return false;
            }
            var ids = $("#comment_to_id").val() + "," + id;
            var comment_content = $("#comment_content").val();
            var new_comment_content = "";
            // new_comment_content = comment_content+'@'+name;
            // $("#comment_content").val(new_comment_content);
            var tmpl = '<li class="weui-uploader__file wk-comment__user" id="#id#" style=""><img src="#url#" class="weui-selet__user" style="margin-bottom: 0px;margin-right: 6px;" /><span style="margin-right: 6px;font-size: 14px;">#name#</span><span class="weui-badge" style="position: relative;top: -5.8em;right: -1.4em;">X</span></li>';
            // console.log(id);
            tmpl = tmpl.replace('#id#', id);
            tmpl = tmpl.replace('#name#', name);
            $("#selectCommentUser").append($(tmpl.replace('#url#', img)));
            $("#comment_to_id").val(ids);
        });
        
        $("#approveSearchResult").on("click", ".select-comment-user", function () {
            var id = $(this).attr('data-id');
            var uid = $(this).attr('data-uid');
            var name = $(this).attr('data-name');
            var img = $(this).attr('data-img');
            // 重复点击
            var ids = $("#approve_to_id").val() + ",";
            var old_ids_arr = ids.split(",");
            if($.inArray(id,old_ids_arr)!=-1){
                return false;
            }
            var ids = $("#approve_to_id").val() + "," + id;
            var comment_content = $("#approve_content").val();
            var new_comment_content = "";
            // new_comment_content = comment_content+'@'+name;
            // $("#comment_content").val(new_comment_content);
            var tmpl = '<li class="weui-uploader__file wk-comment__user" id="#id#" style=""><img src="#url#" class="weui-selet__user" style="margin-bottom: 0px;margin-right: 6px;" /><span style="margin-right: 6px;font-size: 14px;">#name#</span><span class="weui-badge" style="position: relative;top: -5.8em;right: -1.4em;">X</span></li>';
            // console.log(id);
            tmpl = tmpl.replace('#id#', id);
            tmpl = tmpl.replace('#name#', name);
            $("#selectapprovetUser").append($(tmpl.replace('#url#', img)));
            $("#approve_to_id").val(ids);
        });

        // delete comment user
        $("#selectCommentUser").on("click", ".wk-comment__user", function () {
            $li_dom_comment = $(this);
            $("#iosDialog_comment_del").fadeIn(200);
        });
        $("#selectapprovetUser").on("click", ".wk-comment__user", function () {
            $li_dom_comment = $(this);
            $("#iosDialog_approve_del").fadeIn(200);
        });
        // delete comment record
        $(".comment_del").on("click", function () {
            $li_dom_comment_record = $(this);
            $("#iosDialog_comment_record_del").fadeIn(200);
            // $(this).parent().parent().parent().css('display', 'none');
        });
        // 抄送搜索框
        var $searchBar = $('#searchBar'),
            $searchResult = $('#searchResult'),
            $searchText = $('#searchText'),
            $searchInput = $('#searchInput'),
            $searchClear = $('#searchClear'),
            $searchCancel = $('#searchCancel');

        function hideSearchResult(){
            // $searchResult.hide();
            $searchInput.val('');
        }
        function cancelSearch(){
            hideSearchResult();
            $searchBar.removeClass('weui-search-bar_focusing');
            $searchText.show();
        }

        $searchText.on('click', function(){
            $searchBar.addClass('weui-search-bar_focusing');
            $searchInput.focus();
        });
        $searchInput
            .on('blur', function () {
                if(!this.value.length) cancelSearch();
            })
            .on('input', function(){
                if(this.value.length) {
                    $searchResult.show();
                    searchCopyUser();
                } else {
                    modelIni()
                }
            })
        ;
        $searchClear.on('click', function(){
            hideSearchResult();
            $searchInput.focus();
        });
        $searchCancel.on('click', function(){
            searchCopyUser();
        });
        $searchInput.on('keypress',function(e) {  
            var keycode = e.keyCode;  
            var searchName = $(this).val();
            if(keycode=='13') {  
            e.preventDefault();    

            searchCopyUser();
            }         
        });
        function searchCopyUser(){
            word = $searchInput.val();
            if(!word.length) return modelIni();
            $('#searchResult').empty();
            $('#searchResult').append(loading);
            $.post("{:U('Light/Apply/getDeptHtml')}",
                {
                    "type": 1,
                    'search':word
                }, function (data) {
                    $('#searchResult').empty();
                    // console.log(data);
                    if(data == '') {
                        console.log(1);
                        $('#searchResult').append(noresult);
                    } else {
                        console.log(2);
                        $('#searchResult').append(data);
                        // console.log(data.pid);
                        $("#pre-level").attr("data-pid", 17);
                    }
                }
            );
        }

        function modelIni(){
            var id = 1;
            $searchInput.val(null);
            $("#pre-level").attr("data-pid", 0);
            getDepartment(id);
        }

        // 评论搜索框
        var //$commentSearchBar = $('#commentSearchBar'),
            $commentSearchResult = $('#commentSearchResult'),
            //$commentSearchText = $('#commentSearchText'),
            //$commentSearchInput = $('#commentSearchInput'),
            //$commentSearchClear = $('#commentSearchClear'),
            $commentSearchCancel = $('#commentSearchCancel');
       // @按钮
       $("#btn-at").on("click", function () {
            $("#comment_at").toggle(200);
            // if ($("#comment_at").css('display') != 'none') {
            // }
            getCommentResult($commentSearchResult);
        });
        
        
        function getCommentResult($dom){
            var id = $("#aid").val();
            $dom.show();
            $.post("{:U('Light/Apply/getSearchUser')}",
                {
                    id: id,
                    system: "{$system}",
                    mod_name:"{$mod_name}"
                }, function (data) {
                    
                    if (data == '') { 
                        $dom.append(noresult);
                    } else{
                        $dom.empty();
                        $('#loadingToast').fadeOut(100);
                        $dom.append(data.html);
                    }
                }
            );
        }


        // @按钮 -- 审批
        $("#btn-sp").on("click", function () {
            $("#approve_at").toggle(200);
            getCommentResult($approveSearchResult);
        });

        
         // 评论搜索框 --审批
         var //$approveSearchBar = $('#approveSearchBar'),
            $approveSearchResult = $('#approveSearchResult'),
            //$approveSearchText = $('#approveSearchText'),
            //$approveSearchInput = $('#approveSearchInput'),
           // $approveSearchClear = $('#approveSearchClear'),
            $approveSearchCancel = $('#approveSearchCancel');
            
        if($('#apply_status .label').eq(0).text() == '已撤销'){
            //$('#doing').text('该申请已撤销！');
            $("#alert_content").text('该申请已撤销');
            $("#iosDialog_alert").show();
        }         
        
    });
   
</script>
<block name="js">

</block>
</html>